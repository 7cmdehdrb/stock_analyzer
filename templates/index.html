<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>포트폴리오 성과 분석기</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            margin-bottom: 20px;
        }

        /* 네비게이션 바 바로 다음의 카드는 상단 둥근 모서리 제거 */
        #analysisFormCard {
            border-radius: 0 0 15px 15px;
            margin-top: 0;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        input[type="file"],
        input[type="date"],
        input[type="text"],
        select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
            background-color: white;
        }

        input[type="file"]:focus,
        input[type="date"]:focus,
        input[type="text"]:focus,
        select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #667eea;
            font-weight: 600;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #fee;
            color: #c33;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #c33;
            display: none;
        }

        .results {
            display: none;
        }

        /* 수동 입력 테이블 스타일 */
        .input-table-container {
            margin-top: 20px;
            overflow-x: auto;
        }

        .input-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 10px;
        }

        .input-table th {
            background: #f5f5f5;
            padding: 10px;
            text-align: left;
            border-bottom: 2px solid #667eea;
            font-weight: 600;
            font-size: 14px;
        }

        .input-table td {
            padding: 8px;
            border-bottom: 1px solid #e0e0e0;
        }

        .input-table input[type="text"],
        .input-table input[type="number"],
        .input-table select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .input-table input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .delete-row-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .delete-row-btn:hover {
            background: #dc2626;
        }

        /* 모바일 반응형 - 직접 입력 테이블 */
        @media (max-width: 768px) {
            .input-table th,
            .input-table td {
                padding: 6px 4px;
                font-size: 12px;
            }

            .input-table input[type="text"],
            .input-table input[type="number"],
            .input-table select {
                padding: 6px;
                font-size: 13px;
            }

            .delete-row-btn {
                padding: 4px 8px;
                font-size: 11px;
            }
        }

        @media (max-width: 480px) {
            .input-table th,
            .input-table td {
                padding: 4px 2px;
                font-size: 11px;
            }

            .input-table input[type="text"],
            .input-table input[type="number"],
            .input-table select {
                padding: 4px;
                font-size: 12px;
                min-width: 60px;
            }

            .input-table input[type="checkbox"] {
                width: 16px;
                height: 16px;
            }

            .delete-row-btn {
                padding: 3px 6px;
                font-size: 10px;
            }
        }

        .add-row-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .add-row-btn:hover {
            opacity: 0.9;
        }

        .input-mode-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .mode-btn {
            flex: 1;
            padding: 10px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        .mode-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .mode-btn:hover {
            transform: translateY(-2px);
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .summary-item {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .summary-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .summary-value {
            font-size: 24px;
            font-weight: 700;
            color: #333;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .metric-label {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 10px;
            font-weight: 500;
            color: #333;
        }

        .metric-value {
            font-size: 32px;
            font-weight: 700;
        }

        .metric-description {
            font-size: 11px;
            opacity: 0.8;
            margin-top: 5px;
            color: #444;
        }

        .chart-container {
            margin-top: 20px;
            position: relative;
            height: 400px;
        }

        canvas {
            max-width: 100%;
        }

        .helper-text {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
            font-style: italic;
        }

        .positive {
            color: #22c55e;
        }

        .negative {
            color: #ef4444;
        }

        /* 정렬 가능한 테이블 헤더 */
        .sortable-header {
            cursor: pointer;
            user-select: none;
            position: relative;
            padding-right: 20px !important;
        }

        .sortable-header:hover {
            background: #e8e8e8;
        }

        .sortable-header::after {
            content: '⇅';
            position: absolute;
            right: 8px;
            opacity: 0.3;
            font-size: 14px;
        }

        .sortable-header.sort-asc::after {
            content: '↑';
            opacity: 1;
            color: #667eea;
        }

        .sortable-header.sort-desc::after {
            content: '↓';
            opacity: 1;
            color: #667eea;
        }

        /* 네비게이션 바 스타일 */
        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 0;
            margin: 0 0 0 0;
            border-radius: 15px 15px 0 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .navbar-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px 30px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .navbar-title {
            color: white;
            font-size: 24px;
            font-weight: 700;
            text-decoration: none;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .navbar-title:hover {
            opacity: 0.9;
        }

        .navbar-links {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .navbar-link {
            color: white;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 500;
            transition: background 0.2s;
            white-space: nowrap;
        }

        .navbar-link:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .navbar-link.active {
            background: rgba(255, 255, 255, 0.3);
        }

        /* 모바일 반응형 - 헤더 */
        @media (max-width: 768px) {
            .navbar-content {
                padding: 10px 15px;
            }

            .navbar-title {
                font-size: 18px;
            }

            .navbar-links {
                gap: 5px;
            }

            .navbar-link {
                padding: 6px 12px;
                font-size: 14px;
            }
        }

        @media (max-width: 480px) {
            .navbar-title {
                font-size: 16px;
            }

            .navbar-link {
                padding: 5px 10px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 네비게이션 바 -->
        <div class="navbar">
            <div class="navbar-content">
                <a href="/" class="navbar-title">📊 포트폴리오 성과 분석기</a>
                <div class="navbar-links">
                    <a href="/" class="navbar-link active">분석하기</a>
                    <a href="/ranking" class="navbar-link">랭킹보기</a>
                    <a href="/exchange-rate" class="navbar-link">환율</a>
                    <a href="/login" class="navbar-link" id="authLink">로그인</a>
                </div>
            </div>
        </div>

        <div class="card" id="analysisFormCard">
            <form id="analysisForm" enctype="multipart/form-data">
                <!-- 입력 모드 선택 -->
                <div class="input-mode-toggle">
                    <button type="button" class="mode-btn active" id="manualModeBtn">✏️ 직접 입력</button>
                    <button type="button" class="mode-btn" id="csvModeBtn">📁 CSV 불러오기</button>
                </div>

                <!-- CSV 업로드 모드 -->
                <div id="csvUploadSection" class="form-group" style="display: none;">
                    <label for="csvFile">포트폴리오 CSV 파일 불러오기</label>
                    <input type="file" id="csvFile" name="csv_file" accept=".csv">
                    <div class="helper-text">
                        CSV 파일을 선택하면 자동으로 아래 입력 폼이 채워집니다. CSV 파일은 "티커", "보유량", "국가" 컬럼을 포함해야 합니다.
                    </div>
                </div>

                <!-- 수동 입력 모드 -->
                <div id="manualInputSection">
                    <label>포트폴리오 종목 입력</label>
                    <div class="input-table-container">
                        <table class="input-table">
                            <thead>
                                <tr>
                                    <th style="width: 30%;">티커</th>
                                    <th style="width: 25%;">보유수량</th>
                                    <th style="width: 20%;">국가</th>
                                    <th style="width: 25%;">삭제</th>
                                </tr>
                            </thead>
                            <tbody id="manualInputTableBody">
                                <!-- 초기 행 -->
                                <tr class="input-row">
                                    <td><input type="text" class="ticker-input" placeholder="예: AAPL"></td>
                                    <td><input type="number" class="quantity-input" placeholder="보유 주식 수 (예: 10)" min="0" step="1"></td>
                                    <td>
                                        <select class="country-input">
                                            <option value="미국">미국</option>
                                            <option value="한국">한국</option>
                                        </select>
                                    </td>
                                    <td><button type="button" class="delete-row-btn" onclick="deleteRow(this)">삭제</button></td>
                                </tr>
                            </tbody>
                        </table>
                        <div style="display: flex; gap: 10px;">
                            <button type="button" class="add-row-btn" onclick="addRow()" style="flex: 1;">
                                <span>➕</span>
                                <span>종목 추가</span>
                            </button>
                            <button type="button" class="add-row-btn" onclick="addDcaRow()" style="flex: 1; background: #28a745;">
                                <span>📈</span>
                                <span>적립식 투자 추가</span>
                            </button>
                        </div>
                        
                        <!-- 적립식 투자 섹션 -->
                        <div id="dcaSection" style="margin-top: 20px; padding: 15px; background: #f0f8ff; border-radius: 8px; border: 1px solid #b0d4f1; display: none;">
                            <h4 style="margin: 0 0 15px 0; color: #0066cc; font-size: 14px; font-weight: 600;">📈 적립식 투자 (Dollar Cost Averaging)</h4>
                            <table class="input-table">
                                <thead>
                                    <tr>
                                        <th style="width: 25%;">티커</th>
                                        <th style="width: 20%;">1주기당 추가수량</th>
                                        <th style="width: 15%;">국가</th>
                                        <th style="width: 20%;">주기</th>
                                        <th style="width: 20%;">삭제</th>
                                    </tr>
                                </thead>
                                <tbody id="dcaInputTableBody">
                                    <!-- DCA 행들이 여기에 추가됨 -->
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- 현금 입력 섹션 -->
                        <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e0e0e0;">
                            <h4 style="margin: 0 0 15px 0; color: #333; font-size: 14px; font-weight: 600;">💰 현금 보유액</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div>
                                    <label style="display: block; margin-bottom: 5px; color: #666; font-size: 13px;">원화 (KRW)</label>
                                    <input type="number" id="cashKRW" placeholder="원화 금액 (예: 1000000)" min="0" step="1" value="0" 
                                           style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; box-sizing: border-box;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; color: #666; font-size: 13px;">달러 (USD)</label>
                                    <input type="number" id="cashUSD" placeholder="달러 금액 (예: 1000.50)" min="0" step="0.01" value="0" 
                                           style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; box-sizing: border-box;">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="startDate">시작 일자</label>
                    <input type="date" id="startDate" name="start_date" required>
                    <div class="helper-text">
                        분석을 시작할 날짜를 선택하세요. (예: 포트폴리오 구성 시작일)
                    </div>
                </div>

                <div class="form-group">
                    <label for="benchmarkTicker">벤치마크</label>
                    <select id="benchmarkTicker" name="benchmark_ticker" required>
                        <option value="SPY">S&P 500</option>
                        <option value="QQQ">NASDAQ 100</option>
                        <option value="069500.KS">KODEX 200</option>
                        <option value="CUSTOM">기타 (직접 입력)</option>
                        <option disabled>──────────────</option>
                        <option value="HEDGEFUND_BLACKROCK">🏢 블랙록 (BlackRock)</option>
                        <option value="HEDGEFUND_BERKSHIRE">🏢 버크셔 해서웨이 (Berkshire Hathaway)</option>
                    </select>
                    <div class="helper-text">
                        포트폴리오 성과를 비교할 벤치마크를 선택하세요.
                    </div>
                </div>

                <!-- 기타 벤치마크 입력 필드 (숨김 상태로 시작) -->
                <div class="form-group" id="customBenchmarkGroup" style="display: none;">
                    <label for="customBenchmarkTicker">벤치마크 티커</label>
                    <input type="text" id="customBenchmarkTicker" name="custom_benchmark_ticker" placeholder="예: ARKK, VTI, ^IXIC">
                    <div class="helper-text">
                        비교할 벤치마크의 티커를 입력하세요. (예: ARKK, VTI, ^IXIC 등)
                    </div>
                </div>

                <div class="form-group">
                    <label for="baseCurrency">기준 통화</label>
                    <select id="baseCurrency" name="base_currency" required>
                        <option value="USD">미국 달러 (USD)</option>
                        <option value="KRW">한국 원화 (KRW)</option>
                    </select>
                    <div class="helper-text">
                        포트폴리오를 평가할 기준 통화를 선택하세요. 선택한 통화로 모든 자산이 환산됩니다.
                    </div>
                </div>

                <button type="submit" class="btn" id="analyzeBtn">분석 시작</button>
            </form>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <div>포트폴리오를 분석 중입니다...</div>
            </div>

            <div class="error" id="error" style="margin-top: 20px;"></div>
            
            <!-- 캐시 통계 -->
            <div style="margin-top: 20px; padding: 15px; background: #f5f7fa; border-radius: 8px; font-size: 12px; color: #666;">
                <div>
                    <strong>💾 데이터 캐시:</strong> 
                    <span id="cacheStats">로딩 중...</span>
                </div>
            </div>
        </div>

        <div class="results" id="results">
            <!-- 포트폴리오 이름 표시 (상세 뷰 전용) -->
            <div class="card" id="portfolioNameSection" style="display: none;">
                <h1 style="margin: 0; color: #333; font-size: 2em;">
                    <span id="portfolioNameDisplay"></span>
                </h1>
                <div style="margin-top: 10px; font-size: 14px; color: #666;">
                    👤 <span id="portfolioOwnerDisplay" style="font-weight: 600;"></span>
                </div>
                <div id="privacyNotice" style="margin-top: 15px; padding: 12px; border-left: 4px solid #ffc107; border-radius: 4px; font-size: 14px;">
                    <!-- JavaScript에서 동적으로 내용 설정 -->
                </div>
            </div>
            
            <div class="card">
                <h2 style="margin-bottom: 20px; color: #333;">📈 포트폴리오 요약</h2>
                <div class="summary-grid" id="summaryGrid"></div>
            </div>

            <div class="card">
                <h2 style="margin-bottom: 20px; color: #333;">💼 보유 종목 현황</h2>
                <div style="overflow-x: auto;">
                    <table id="holdingsTable" style="width: 100%; border-collapse: collapse; margin-top: 10px;">
                        <thead>
                            <tr style="background: #f5f5f5;">
                                <th class="sortable-header" onclick="sortHoldings('ticker')" style="padding: 12px; text-align: left; border-bottom: 2px solid #667eea;">티커</th>
                                <th style="padding: 12px; text-align: left; border-bottom: 2px solid #667eea;">종목명</th>
                                <th style="padding: 12px; text-align: right; border-bottom: 2px solid #667eea;">보유수량</th>
                                <th style="padding: 12px; text-align: right; border-bottom: 2px solid #667eea;">평가액</th>
                                <th class="sortable-header" onclick="sortHoldings('weight')" style="padding: 12px; text-align: right; border-bottom: 2px solid #667eea;">비중(%)</th>
                            </tr>
                        </thead>
                        <tbody id="holdingsTableBody">
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="card">
                <h2 style="margin-bottom: 20px; color: #333;">🥧 자산 배분 비중</h2>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 20px;">
                    <div>
                        <h3 style="text-align: center; margin-bottom: 15px; color: #666; font-size: 16px;">시작 시점</h3>
                        <div style="position: relative; height: 300px;">
                            <canvas id="initialAllocationChart"></canvas>
                        </div>
                    </div>
                    <div>
                        <h3 style="text-align: center; margin-bottom: 15px; color: #666; font-size: 16px;">현재 시점</h3>
                        <div style="position: relative; height: 300px;">
                            <canvas id="currentAllocationChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2 style="margin-bottom: 20px; color: #333;">📊 성과 지표</h2>
                <div class="metrics-grid" id="metricsGrid"></div>
            </div>

            <div class="card">
                <h2 style="margin-bottom: 20px; color: #333;">📉 누적 수익률 비교</h2>
                <div class="chart-container">
                    <canvas id="performanceChart"></canvas>
                </div>
            </div>

            <!-- 저장 버튼 -->
            <div class="card" id="saveSection" style="display: none;">
                <h2 style="margin-bottom: 20px; color: #333;">💾 포트폴리오 저장</h2>
                <div style="display: flex; gap: 15px; align-items: center; margin-bottom: 15px;">
                    <input 
                        type="text" 
                        id="portfolioName" 
                        placeholder="포트폴리오 이름 입력" 
                        style="flex: 1; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px;"
                    >
                    <button 
                        id="saveBtn" 
                        onclick="savePortfolio()"
                        style="padding: 12px 30px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; white-space: nowrap;"
                    >
                        💾 저장하기
                    </button>
                </div>
                <!-- CSV 내보내기 버튼 (직접 입력 모드 전용) -->
                <div id="exportSection" style="display: none;">
                    <button 
                        id="exportBtn" 
                        onclick="exportToCSV()"
                        style="width: 100%; padding: 12px 30px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer;"
                    >
                        📥 CSV로 내보내기
                    </button>
                    <div style="margin-top: 10px; font-size: 12px; color: #666;">
                        💡 입력한 포트폴리오를 CSV 파일로 다운로드하여 나중에 다시 사용할 수 있습니다.
                    </div>
                </div>
                <div id="saveMessage" style="margin-top: 15px; padding: 12px; border-radius: 6px; display: none;"></div>
            </div>

            <!-- AI 분석 버튼 -->
            <div class="card" id="aiAnalysisSection" style="display: none; text-align: center;">
                <button 
                    id="aiAnalysisBtn" 
                    onclick="analyzeWithAI()"
                    style="
                        padding: 20px 40px;
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        color: white;
                        border: none;
                        border-radius: 50px;
                        font-size: 16px;
                        font-weight: 700;
                        cursor: pointer;
                        box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
                        transition: all 0.3s ease;
                        display: inline-flex;
                        align-items: center;
                        gap: 12px;
                    "
                    onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 12px 24px rgba(102, 126, 234, 0.4)';"
                    onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 8px 20px rgba(102, 126, 234, 0.3)';"
                >
                    <span style="font-size: 24px;">🤖</span>
                    <span>AI로 분석하기</span>
                </button>
                <div style="margin-top: 15px; font-size: 13px; color: #666;">
                    💡 AI가 포트폴리오 성과를 분석하고 인사이트를 제공합니다.
                </div>
            </div>

            <!-- AI 분석 결과 모달 -->
            <div id="aiAnalysisModal" class="ai-modal">
                <div class="ai-modal-container">
                    <!-- 모달 헤더 -->
                    <div class="ai-modal-header">
                        <h2 class="ai-modal-title">
                            <span class="ai-icon">🤖</span>
                            <span class="ai-title-text">AI 포트폴리오 분석</span>
                        </h2>
                        <button onclick="closeAIModal()" class="ai-modal-close" 
                            onmouseover="this.style.background='rgba(255,255,255,0.2)'" 
                            onmouseout="this.style.background='none'">
                            ×
                        </button>
                    </div>
                    
                    <!-- 로딩 상태 -->
                    <div id="aiLoadingState" class="ai-loading">
                        <div class="ai-loading-icon">🤖</div>
                        <div class="ai-loading-title">
                            AI가 포트폴리오를 분석하고 있습니다...
                        </div>
                        <div class="ai-loading-subtitle">
                            잠시만 기다려주세요
                        </div>
                        <div class="ai-loading-warning">
                            ⚠️ <strong>주의:</strong> 분석이 완료될 때까지 창을 닫거나 화면을 벗어나지 마세요.
                        </div>
                        <div class="ai-loading-spinner-wrapper">
                            <div class="ai-loading-spinner"></div>
                        </div>
                    </div>
                    
                    <!-- 분석 결과 -->
                    <div id="aiAnalysisContent" class="ai-content"></div>
                </div>
            </div>
        </div>
    </div>

    <style>
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* AI 모달 기본 스타일 */
        .ai-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 9999;
            overflow-y: auto;
            padding: 20px;
        }
        
        .ai-modal-container {
            max-width: 900px;
            margin: 30px auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            position: relative;
        }
        
        .ai-modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px 25px;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .ai-modal-title {
            margin: 0;
            color: white;
            font-size: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .ai-icon {
            font-size: 24px;
        }
        
        .ai-title-text {
            font-size: 20px;
        }
        
        .ai-modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 28px;
            cursor: pointer;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.2s;
            flex-shrink: 0;
        }
        
        .ai-loading {
            padding: 40px 20px;
            text-align: center;
            display: none;
        }
        
        .ai-loading-icon {
            font-size: 48px;
            margin-bottom: 20px;
        }
        
        .ai-loading-title {
            font-size: 18px;
            color: #667eea;
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        .ai-loading-subtitle {
            font-size: 14px;
            color: #999;
            margin-bottom: 20px;
        }
        
        .ai-loading-warning {
            font-size: 13px;
            color: #ef4444;
            background: #fee;
            padding: 12px;
            border-radius: 6px;
            margin: 0 auto 30px;
            max-width: 400px;
            border: 1px solid #fcc;
        }
        
        .ai-loading-spinner-wrapper {
            margin-top: 30px;
        }
        
        .ai-loading-spinner {
            display: inline-block;
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        .ai-content {
            padding: 30px;
            max-height: 70vh;
            overflow-y: auto;
            line-height: 1.8;
        }
        
        /* 마크다운 스타일링 */
        #aiAnalysisContent h2 {
            color: #333;
            margin-top: 30px;
            margin-bottom: 15px;
            font-size: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e0e0e0;
            word-break: keep-all;
        }
        
        #aiAnalysisContent h2:first-child {
            margin-top: 0;
        }
        
        #aiAnalysisContent ul {
            margin-left: 20px;
            margin-bottom: 20px;
            padding-left: 0;
        }
        
        #aiAnalysisContent li {
            margin-bottom: 10px;
            color: #333;
            word-break: keep-all;
        }
        
        #aiAnalysisContent strong {
            color: #667eea;
            font-weight: 600;
        }
        
        #aiAnalysisContent p {
            margin-bottom: 15px;
            color: #555;
            word-break: keep-all;
        }
        
        #aiAnalysisContent code {
            background: #f5f5f5;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            color: #e83e8c;
            font-size: 0.9em;
            word-break: break-all;
        }
        
        /* 테이블 스타일링 (AI 분석 결과에 포함될 수 있음) */
        #aiAnalysisContent table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            font-size: 14px;
        }
        
        #aiAnalysisContent th,
        #aiAnalysisContent td {
            border: 1px solid #e0e0e0;
            padding: 8px;
            text-align: left;
        }
        
        #aiAnalysisContent th {
            background: #f5f5f5;
            font-weight: 600;
            color: #333;
        }
        
        #aiAnalysisContent blockquote {
            border-left: 4px solid #667eea;
            margin: 15px 0;
            padding: 10px 20px;
            background: #f8f9ff;
            color: #555;
        }
        
        /* 모바일 반응형 스타일 */
        @media (max-width: 768px) {
            .ai-modal {
                padding: 0;
            }
            
            .ai-modal-container {
                margin: 0;
                border-radius: 0;
                min-height: 100vh;
                max-width: 100%;
            }
            
            .ai-modal-header {
                padding: 15px 20px;
                border-radius: 0;
                position: sticky;
                top: 0;
                z-index: 10;
            }
            
            .ai-modal-title {
                font-size: 16px;
                gap: 8px;
            }
            
            .ai-icon {
                font-size: 20px;
            }
            
            .ai-title-text {
                font-size: 16px;
            }
            
            .ai-modal-close {
                font-size: 24px;
                width: 32px;
                height: 32px;
            }
            
            .ai-loading {
                padding: 30px 15px;
            }
            
            .ai-loading-icon {
                font-size: 36px;
                margin-bottom: 15px;
            }
            
            .ai-loading-title {
                font-size: 16px;
                margin-bottom: 8px;
            }
            
            .ai-loading-subtitle {
                font-size: 13px;
                margin-bottom: 15px;
            }
            
            .ai-loading-warning {
                font-size: 12px;
                padding: 10px;
                margin: 0 15px 20px;
                max-width: 100%;
            }
            
            .ai-loading-spinner {
                width: 40px;
                height: 40px;
                border-width: 4px;
            }
            
            .ai-content {
                padding: 20px 15px;
                max-height: calc(100vh - 80px);
            }
            
            #aiAnalysisContent h2 {
                font-size: 18px;
                margin-top: 20px;
                margin-bottom: 12px;
                padding-bottom: 8px;
            }
            
            #aiAnalysisContent ul {
                margin-left: 10px;
                margin-bottom: 15px;
                padding-left: 10px;
            }
            
            #aiAnalysisContent li {
                margin-bottom: 8px;
                font-size: 14px;
                line-height: 1.6;
            }
            
            #aiAnalysisContent p {
                margin-bottom: 12px;
                font-size: 14px;
                line-height: 1.6;
            }
            
            #aiAnalysisContent code {
                font-size: 0.85em;
                padding: 1px 4px;
            }
            
            #aiAnalysisContent table {
                font-size: 12px;
                display: block;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            #aiAnalysisContent th,
            #aiAnalysisContent td {
                padding: 6px;
                font-size: 12px;
            }
            
            #aiAnalysisContent blockquote {
                padding: 8px 15px;
                margin: 10px 0;
                font-size: 14px;
            }
        }
        
        /* 작은 모바일 (360px 이하) */
        @media (max-width: 360px) {
            .ai-modal-title {
                font-size: 14px;
            }
            
            .ai-icon {
                font-size: 18px;
            }
            
            .ai-title-text {
                font-size: 14px;
            }
            
            .ai-content {
                padding: 15px 10px;
            }
            
            #aiAnalysisContent h2 {
                font-size: 16px;
            }
            
            #aiAnalysisContent li,
            #aiAnalysisContent p {
                font-size: 13px;
            }
            
            #aiAnalysisContent table {
                font-size: 11px;
            }
            
            #aiAnalysisContent th,
            #aiAnalysisContent td {
                padding: 4px;
                font-size: 11px;
            }
        }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        // 전역 변수로 로그인 상태 저장
        let isUserLoggedIn = false;

        // 로그인 상태 체크
        async function checkLoginStatus() {
            try {
                const response = await fetch('/api/me');
                const data = await response.json();
                
                const authLink = document.getElementById('authLink');
                
                if (data.logged_in) {
                    isUserLoggedIn = true;
                    authLink.textContent = `👤 ${data.user.nickname}`;
                    authLink.href = '/mypage';
                    authLink.onclick = null;
                } else {
                    isUserLoggedIn = false;
                    authLink.textContent = '로그인';
                    authLink.href = '/login';
                    authLink.onclick = null;
                }
                
                // 로그인 상태에 따라 UI 업데이트
                updateUIBasedOnLogin();
            } catch (error) {
                console.error('로그인 상태 확인 오류:', error);
                isUserLoggedIn = false;
                updateUIBasedOnLogin();
            }
        }
        
        // 로그인 상태에 따라 UI 업데이트
        function updateUIBasedOnLogin() {
            const portfolioNameInput = document.getElementById('portfolioName');
            const saveBtn = document.getElementById('saveBtn');
            const aiAnalysisBtn = document.getElementById('aiAnalysisBtn');
            
            if (portfolioNameInput && saveBtn) {
                if (!isUserLoggedIn) {
                    portfolioNameInput.disabled = true;
                    portfolioNameInput.placeholder = '🔒 로그인이 필요한 기능입니다';
                    portfolioNameInput.style.backgroundColor = '#f5f5f5';
                    portfolioNameInput.style.cursor = 'not-allowed';
                    
                    saveBtn.disabled = true;
                    saveBtn.style.opacity = '0.5';
                    saveBtn.style.cursor = 'not-allowed';
                    saveBtn.title = '로그인이 필요합니다';
                } else {
                    portfolioNameInput.disabled = false;
                    portfolioNameInput.placeholder = '포트폴리오 이름 입력';
                    portfolioNameInput.style.backgroundColor = 'white';
                    portfolioNameInput.style.cursor = 'text';
                    
                    saveBtn.disabled = false;
                    saveBtn.style.opacity = '1';
                    saveBtn.style.cursor = 'pointer';
                    saveBtn.title = '';
                }
            }
            
            if (aiAnalysisBtn) {
                if (!isUserLoggedIn) {
                    aiAnalysisBtn.disabled = true;
                    aiAnalysisBtn.style.opacity = '0.5';
                    aiAnalysisBtn.style.cursor = 'not-allowed';
                    aiAnalysisBtn.title = '로그인이 필요합니다';
                    aiAnalysisBtn.innerHTML = '🤖 AI 분석하기 <span style="font-size: 12px; display: block; margin-top: 5px;">🔒 로그인이 필요한 기능입니다</span>';
                } else {
                    aiAnalysisBtn.disabled = false;
                    aiAnalysisBtn.style.opacity = '1';
                    aiAnalysisBtn.style.cursor = 'pointer';
                    aiAnalysisBtn.title = '';
                    aiAnalysisBtn.innerHTML = '🤖 AI 분석하기<br><span style="font-size: 12px; opacity: 0.9;">포트폴리오를 AI가 분석해드립니다</span>';
                }
            }
        }
        
        // 로그아웃
        async function logout() {
            try {
                const response = await fetch('/api/logout', {
                    method: 'POST'
                });
                
                if (response.ok) {
                    alert('로그아웃되었습니다.');
                    window.location.reload();
                }
            } catch (error) {
                console.error('로그아웃 오류:', error);
                alert('로그아웃 중 오류가 발생했습니다.');
            }
        }
        
        // 페이지 로드 시 로그인 상태 체크
        window.addEventListener('DOMContentLoaded', checkLoginStatus);
        
        const form = document.getElementById('analysisForm');
        const loading = document.getElementById('loading');
        const error = document.getElementById('error');
        const results = document.getElementById('results');
        const analyzeBtn = document.getElementById('analyzeBtn');

        // 날짜 기본값 설정 (오늘 날짜와 3년 전 1월 1일)
        const today = new Date();
        const threeYearsAgo = new Date(today.getFullYear() - 3, 0, 1); // 0 = January, 1 = 1일
        const minDate = new Date(2000, 0, 1); // 2000년 1월 1일
        
        // 로컬 날짜를 YYYY-MM-DD 형식으로 변환 (UTC 문제 방지)
        function formatLocalDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        console.log('Today:', formatLocalDate(today));
        console.log('Three years ago (Jan 1):', formatLocalDate(threeYearsAgo));
        
        document.getElementById('startDate').min = formatLocalDate(minDate);
        document.getElementById('startDate').max = formatLocalDate(today);
        document.getElementById('startDate').value = formatLocalDate(threeYearsAgo);
        
        // 기본 벤치마크 설정
        document.getElementById('benchmarkTicker').value = 'SPY';

        // 벤치마크 선택 변경 이벤트 리스너
        document.getElementById('benchmarkTicker').addEventListener('change', function() {
            const customBenchmarkGroup = document.getElementById('customBenchmarkGroup');
            const customBenchmarkTicker = document.getElementById('customBenchmarkTicker');
            
            if (this.value === 'CUSTOM') {
                customBenchmarkGroup.style.display = 'block';
                customBenchmarkTicker.required = true;
            } else {
                customBenchmarkGroup.style.display = 'none';
                customBenchmarkTicker.required = false;
                customBenchmarkTicker.value = ''; // 값 초기화
            }
        });

        // 입력 모드 버튼 이벤트 리스너
        document.getElementById('csvModeBtn').addEventListener('click', function() {
            switchInputMode('csv');
        });
        document.getElementById('manualModeBtn').addEventListener('click', function() {
            switchInputMode('manual');
        });

        // CSV 파일 선택 시 자동 파싱
        document.getElementById('csvFile').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file) return;

            console.log('📁 CSV file selected:', file.name);
            
            // 로딩 표시
            const csvSection = document.getElementById('csvUploadSection');
            const helperText = csvSection.querySelector('.helper-text');
            const originalHelperText = helperText.innerHTML;
            helperText.innerHTML = '<span style="color: #667eea;">⏳ CSV 파일을 분석하는 중...</span>';

            try {
                const formData = new FormData();
                formData.append('csv_file', file);

                const response = await fetch('/parse-csv', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'CSV 파일 파싱 실패');
                }

                console.log('✅ CSV parsed successfully:', data);

                // 수동 입력 모드로 전환
                switchInputMode('manual');

                // 기존 행 모두 삭제
                const tbody = document.getElementById('manualInputTableBody');
                tbody.innerHTML = '';

                // CSV 데이터로 행 채우기
                data.portfolio.forEach(item => {
                    const newRow = document.createElement('tr');
                    newRow.className = 'input-row';
                    newRow.innerHTML = `
                        <td><input type="text" class="ticker-input" placeholder="예: AAPL" value="${item.ticker}"></td>
                        <td><input type="number" class="quantity-input" placeholder="보유 주식 수 (예: 10)" min="0" step="1" value="${item.quantity}"></td>
                        <td>
                            <select class="country-input">
                                <option value="미국" ${item.country === '미국' ? 'selected' : ''}>미국</option>
                                <option value="한국" ${item.country === '한국' ? 'selected' : ''}>한국</option>
                            </select>
                        </td>
                        <td><button type="button" class="delete-row-btn" onclick="deleteRow(this)">삭제</button></td>
                    `;
                    tbody.appendChild(newRow);
                });

                // 최소 1개 행 보장
                if (tbody.children.length === 0) {
                    addRow();
                }

                // 현금 데이터 채우기
                if (data.cash) {
                    document.getElementById('cashKRW').value = data.cash.KRW || 0;
                    document.getElementById('cashUSD').value = data.cash.USD || 0;
                }

                // 성공 메시지
                helperText.innerHTML = '<span style="color: #22c55e;">✅ CSV 파일이 성공적으로 불러와졌습니다!</span>';
                setTimeout(() => {
                    helperText.innerHTML = originalHelperText;
                }, 3000);

                // 파일 입력 초기화
                e.target.value = '';

            } catch (error) {
                console.error('❌ Error parsing CSV:', error);
                helperText.innerHTML = `<span style="color: #ef4444;">❌ ${error.message}</span>`;
                setTimeout(() => {
                    helperText.innerHTML = originalHelperText;
                }, 5000);
            }
        });

        // 입력 모드 전역 변수 (기본값: manual, 항상 manual 모드 사용)
        let currentInputMode = 'manual';

        // 입력 모드 전환 (CSV 모드는 파일 선택 트리거로만 사용)
        function switchInputMode(mode) {
            console.log('Switching to mode:', mode);
            
            if (mode === 'csv') {
                // CSV 버튼 클릭 시 파일 선택 다이얼로그 열기
                document.getElementById('csvFile').click();
                // 항상 manual 모드 유지
                currentInputMode = 'manual';
            } else {
                currentInputMode = 'manual';
            }
            
            // 항상 manual 섹션만 표시
            document.getElementById('csvUploadSection').style.display = 'none';
            document.getElementById('manualInputSection').style.display = 'block';
            document.getElementById('csvFile').required = false;
            
            // 버튼 상태 업데이트
            document.getElementById('manualModeBtn').classList.add('active');
            document.getElementById('csvModeBtn').classList.remove('active');
        }

        // 행 추가
        function addRow() {
            const tbody = document.getElementById('manualInputTableBody');
            const newRow = document.createElement('tr');
            newRow.className = 'input-row';
            newRow.innerHTML = `
                <td><input type="text" class="ticker-input" placeholder="예: AAPL"></td>
                <td><input type="number" class="quantity-input" placeholder="보유 주식 수 (예: 10)" min="0" step="1"></td>
                <td>
                    <select class="country-input">
                        <option value="미국">미국</option>
                        <option value="한국">한국</option>
                    </select>
                </td>
                <td><button type="button" class="delete-row-btn" onclick="deleteRow(this)">삭제</button></td>
            `;
            tbody.appendChild(newRow);
        }

        // 행 삭제
        function deleteRow(button) {
            const tbody = document.getElementById('manualInputTableBody');
            const rows = tbody.getElementsByClassName('input-row');
            
            // 최소 1개 행은 유지
            if (rows.length > 1) {
                button.closest('tr').remove();
            } else {
                alert('최소 1개의 종목은 입력해야 합니다.');
            }
        }

        // 적립식 투자 행 추가
        function addDcaRow() {
            const dcaSection = document.getElementById('dcaSection');
            const tbody = document.getElementById('dcaInputTableBody');
            
            // 섹션이 숨겨져 있으면 표시
            if (dcaSection.style.display === 'none') {
                dcaSection.style.display = 'block';
            }
            
            const newRow = document.createElement('tr');
            newRow.className = 'dca-row';
            newRow.innerHTML = `
                <td><input type="text" class="dca-ticker-input" placeholder="예: AAPL"></td>
                <td><input type="number" class="dca-quantity-input" placeholder="매 주기마다 추가할 수량" min="0.01" step="0.01"></td>
                <td>
                    <select class="dca-country-input">
                        <option value="미국">미국</option>
                        <option value="한국">한국</option>
                    </select>
                </td>
                <td>
                    <select class="dca-frequency-input">
                        <option value="weekly">매주</option>
                        <option value="monthly">매월</option>
                        <option value="quarterly">매분기</option>
                    </select>
                </td>
                <td><button type="button" class="delete-row-btn" onclick="deleteDcaRow(this)">삭제</button></td>
            `;
            tbody.appendChild(newRow);
        }

        // 적립식 투자 행 삭제
        function deleteDcaRow(button) {
            const tbody = document.getElementById('dcaInputTableBody');
            const dcaSection = document.getElementById('dcaSection');
            
            button.closest('tr').remove();
            
            // 모든 행이 삭제되면 섹션 숨기기
            const rows = tbody.getElementsByClassName('dca-row');
            if (rows.length === 0) {
                dcaSection.style.display = 'none';
            }
        }

        // 수동 입력 데이터를 CSV 형식으로 변환
        function convertManualInputToCSV() {
            const rows = document.querySelectorAll('#manualInputTableBody .input-row');
            const csvLines = ['티커,보유량,국가,분류'];

            let hasData = false;
            rows.forEach(row => {
                const ticker = row.querySelector('.ticker-input').value.trim();
                const quantity = row.querySelector('.quantity-input').value.trim();
                const country = row.querySelector('.country-input').value;

                if (ticker && quantity) {
                    hasData = true;
                    const assetClass = '주식';  // 모든 행은 주식으로 처리
                    csvLines.push(`${ticker},${quantity},${country},${assetClass}`);
                }
            });

            // 현금 추가
            const cashKRW = parseFloat(document.getElementById('cashKRW').value) || 0;
            const cashUSD = parseFloat(document.getElementById('cashUSD').value) || 0;

            if (cashKRW > 0) {
                hasData = true;
                csvLines.push(`KRW,${cashKRW},한국,현금`);
            }

            if (cashUSD > 0) {
                hasData = true;
                csvLines.push(`USD,${cashUSD},미국,현금`);
            }

            if (!hasData) {
                return null;
            }

            return csvLines.join('\n');
        }

        // 캐시 통계 로드
        async function loadCacheStats() {
            try {
                const response = await fetch('/api/cache-stats');
                if (response.ok) {
                    const data = await response.json();
                    const statsElement = document.getElementById('cacheStats');
                    statsElement.textContent = `${data.ticker_count}개 종목, ${data.record_count.toLocaleString()}개 레코드`;
                } else {
                    document.getElementById('cacheStats').textContent = '통계 로드 실패';
                }
            } catch (err) {
                console.error('캐시 통계 로드 오류:', err);
                document.getElementById('cacheStats').textContent = '통계 로드 실패';
            }
        }

        // 페이지 로드 시 캐시 통계 가져오기
        loadCacheStats();

        // 저장된 포트폴리오 보기 처리
        window.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            console.log('URL params:', urlParams.toString());
            console.log('view param:', urlParams.get('view'));
            
            if (urlParams.get('view') === 'portfolio') {
                const portfolioData = sessionStorage.getItem('portfolioData');
                console.log('SessionStorage data:', portfolioData);
                
                if (portfolioData) {
                    try {
                        const data = JSON.parse(portfolioData);
                        console.log('Parsed data:', data);
                        
                        // 폼 섹션 숨기기
                        const formCard = document.getElementById('analysisFormCard');
                        if (formCard) {
                            formCard.style.display = 'none';
                        }
                        
                        // 포트폴리오 이름 및 소유자 표시
                        const portfolioNameSection = document.getElementById('portfolioNameSection');
                        const portfolioNameDisplay = document.getElementById('portfolioNameDisplay');
                        const portfolioOwnerDisplay = document.getElementById('portfolioOwnerDisplay');
                        const privacyNotice = document.getElementById('privacyNotice');
                        
                        if (portfolioNameSection && portfolioNameDisplay) {
                            portfolioNameDisplay.textContent = data.name;
                            if (portfolioOwnerDisplay && data.owner_nickname) {
                                portfolioOwnerDisplay.textContent = data.owner_nickname;
                            } else if (portfolioOwnerDisplay) {
                                portfolioOwnerDisplay.textContent = '익명';
                            }
                            
                            // 프라이버시 알림 설정
                            if (privacyNotice) {
                                if (data.is_owner) {
                                    // 소유자인 경우
                                    privacyNotice.style.background = '#d1ecf1';
                                    privacyNotice.style.color = '#0c5460';
                                    privacyNotice.innerHTML = '✅ <strong>내 포트폴리오:</strong> 모든 정보가 표시됩니다.';
                                } else {
                                    // 다른 사용자의 포트폴리오인 경우
                                    privacyNotice.style.background = '#fff3cd';
                                    privacyNotice.style.color = '#856404';
                                    privacyNotice.innerHTML = 'ℹ️ <strong>알림:</strong> 다른 사용자의 포트폴리오를 조회할 때는 프라이버시 보호를 위해 자산 가치가 표시되지 않습니다.';
                                }
                            }
                            
                            portfolioNameSection.style.display = 'block';
                        }
                        
                        // 결과 표시 - data에서 직접 필요한 필드 추출
                        // is_owner가 true면 정상 표시, false면 프라이버시 모드
                        displayResults({
                            metrics: data.metrics,
                            summary: data.summary,
                            holdings_table: data.holdings_table,
                            allocation_data: data.allocation_data,
                            chart_data: data.chart_data
                        }, !data.is_owner); // true = 프라이버시 모드 (다른 사용자), false = 정상 표시 (소유자)
                        
                        // 결과 섹션 표시
                        const results = document.getElementById('results');
                        if (results) {
                            results.style.display = 'block';
                        }
                        
                        // sessionStorage 정리
                        sessionStorage.removeItem('portfolioData');
                        
                        // URL에서 view 파라미터 제거 (브라우저 히스토리 유지)
                        window.history.replaceState({}, document.title, window.location.pathname);
                        
                    } catch (err) {
                        console.error('포트폴리오 데이터 로드 오류:', err);
                        console.error('Error stack:', err.stack);
                        alert('포트폴리오 데이터를 불러오는 중 오류가 발생했습니다.');
                    }
                } else {
                    console.log('No portfolio data in sessionStorage');
                }
            }
        });

        let chart = null;
        let initialAllocationChart = null;
        let currentAllocationChart = null;
        
        // 분석 결과를 저장하기 위한 전역 변수
        let currentAnalysisData = null;

        // 보유 종목 데이터 및 정렬 상태
        let currentHoldings = [];
        let currentCurrency = 'USD';
        let isDetailView = false;
        let currentSortColumn = null;
        let currentSortDirection = 'asc';

        // 정렬 함수
        function sortHoldings(column) {
            // 같은 컬럼을 클릭하면 방향 전환, 다른 컬럼이면 오름차순으로 시작
            if (currentSortColumn === column) {
                currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortColumn = column;
                currentSortDirection = 'asc';
            }

            // 정렬
            const sorted = [...currentHoldings].sort((a, b) => {
                if (column === 'ticker') {
                    // 현금은 항상 맨 아래
                    const aIsCash = a.asset_class === '현금';
                    const bIsCash = b.asset_class === '현금';
                    
                    if (aIsCash && !bIsCash) return 1;
                    if (!aIsCash && bIsCash) return -1;
                    
                    // 둘 다 현금이거나 둘 다 일반 자산인 경우 티커로 비교
                    const comparison = a.ticker.localeCompare(b.ticker);
                    return currentSortDirection === 'asc' ? comparison : -comparison;
                } else if (column === 'weight') {
                    const comparison = a.weight - b.weight;
                    return currentSortDirection === 'asc' ? comparison : -comparison;
                }
                return 0;
            });

            // 테이블 다시 렌더링
            renderHoldingsTable(sorted, currentCurrency, isDetailView);

            // 헤더 스타일 업데이트
            updateSortHeaders();
        }

        // 정렬 헤더 스타일 업데이트
        function updateSortHeaders() {
            // 모든 헤더에서 정렬 클래스 제거
            document.querySelectorAll('.sortable-header').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
            });

            // 현재 정렬 컬럼에 클래스 추가
            if (currentSortColumn === 'ticker') {
                const tickerHeader = document.querySelector('.sortable-header[onclick*="ticker"]');
                if (tickerHeader) {
                    tickerHeader.classList.add(currentSortDirection === 'asc' ? 'sort-asc' : 'sort-desc');
                }
            } else if (currentSortColumn === 'weight') {
                const weightHeader = document.querySelector('.sortable-header[onclick*="weight"]');
                if (weightHeader) {
                    weightHeader.classList.add(currentSortDirection === 'asc' ? 'sort-asc' : 'sort-desc');
                }
            }
        }

        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            // 항상 수동 입력 모드로 처리 (CSV는 이미 파싱되어 폼에 채워져 있음)
            let csvContent = null;
            let fileToUpload = null;

            // 수동 입력 모드: CSV 생성
            csvContent = convertManualInputToCSV();
            if (!csvContent) {
                alert('최소 1개의 종목을 입력해주세요.');
                return;
            }
            console.log('📝 Manual input CSV:', csvContent);
            
            // CSV를 Blob으로 변환하여 파일처럼 처리
            const blob = new Blob([csvContent], { type: 'text/csv' });
            fileToUpload = new File([blob], 'manual_input.csv', { type: 'text/csv' });

            // UI 초기화
            error.style.display = 'none';
            error.style.backgroundColor = ''; // 배경색 초기화
            error.style.color = ''; // 글자색 초기화
            error.style.borderLeft = ''; // 테두리 초기화
            results.style.display = 'none';
            loading.style.display = 'block';
            analyzeBtn.disabled = true;
            
            // AI 분석 캐시 초기화 (새로운 분석 시작)
            aiAnalysisResultCache = null;

            const formData = new FormData();
            formData.append('csv_file', fileToUpload);
            formData.append('start_date', document.getElementById('startDate').value);
            
            // 벤치마크 처리
            const benchmarkSelect = document.getElementById('benchmarkTicker').value;
            if (benchmarkSelect === 'CUSTOM') {
                const customTicker = document.getElementById('customBenchmarkTicker').value.trim();
                if (!customTicker) {
                    alert('벤치마크 티커를 입력해주세요.');
                    loading.style.display = 'none';
                    analyzeBtn.disabled = false;
                    return;
                }
                formData.append('benchmark_ticker', customTicker);
            } else {
                formData.append('benchmark_ticker', benchmarkSelect);
            }
            
            formData.append('base_currency', document.getElementById('baseCurrency').value);
            
            // 적립식 투자 데이터 추가
            const dcaRows = document.querySelectorAll('#dcaInputTableBody .dca-row');
            const dcaData = [];
            dcaRows.forEach(row => {
                const ticker = row.querySelector('.dca-ticker-input').value.trim();
                const quantity = row.querySelector('.dca-quantity-input').value.trim();
                const country = row.querySelector('.dca-country-input').value;
                const frequency = row.querySelector('.dca-frequency-input').value;
                
                if (ticker && quantity) {
                    dcaData.push({
                        ticker: ticker,
                        quantity: parseFloat(quantity),
                        country: country,
                        frequency: frequency
                    });
                }
            });
            
            if (dcaData.length > 0) {
                formData.append('dca_data', JSON.stringify(dcaData));
                console.log('📈 DCA data:', dcaData);
            }
            
            // FormData 내용 확인 (디버깅용)
            console.log('📤 Sending data:');
            for (let [key, value] of formData.entries()) {
                if (value instanceof File) {
                    console.log(`  ${key}: ${value.name} (${value.size} bytes)`);
                } else {
                    console.log(`  ${key}: ${value}`);
                }
            }

            try {
                const response = await fetch('/analyze', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || '분석 중 오류가 발생했습니다.');
                }

                console.log('✅ Analysis completed successfully');
                
                // 경고 메시지 표시 (일부 티커 실패)
                if (data.warning) {
                    const warningDiv = document.getElementById('error');
                    warningDiv.textContent = data.warning;
                    warningDiv.style.display = 'block';
                    warningDiv.style.backgroundColor = '#fff3cd';
                    warningDiv.style.color = '#856404';
                    warningDiv.style.borderLeft = '4px solid #ffc107';
                }
                
                // 분석 결과 저장 (저장 버튼용)
                // DCA가 적용된 최종 포트폴리오 CSV 사용
                let csvContentForSave;
                if (data.final_portfolio_csv) {
                    // 백엔드에서 DCA가 적용된 최종 포트폴리오를 받음
                    csvContentForSave = data.final_portfolio_csv;
                    console.log('📊 Using final portfolio CSV (with DCA applied)');
                } else {
                    // 항상 수동 입력에서 생성된 CSV 사용
                    csvContentForSave = csvContent;
                }

                currentAnalysisData = {
                    csv_content: csvContentForSave,
                    start_date: document.getElementById('startDate').value,
                    benchmark_ticker: document.getElementById('benchmarkTicker').value,
                    base_currency: document.getElementById('baseCurrency').value,
                    ...data
                };
                
                displayResults(data);
                results.style.display = 'block';
                
                // 저장 섹션 표시
                document.getElementById('saveSection').style.display = 'block';
                document.getElementById('saveMessage').style.display = 'none';
                
                // AI 분석 버튼 표시
                document.getElementById('aiAnalysisSection').style.display = 'block';
                
                // 로그인 상태에 따라 UI 업데이트
                updateUIBasedOnLogin();
                
                // 항상 CSV 내보내기 버튼 표시 (수동 입력 모드)
                document.getElementById('exportSection').style.display = 'block';

            } catch (err) {
                console.error('❌ Error:', err);
                error.textContent = err.message;
                error.style.display = 'block';
            } finally {
                loading.style.display = 'none';
                analyzeBtn.disabled = false;
                // 분석 후 캐시 통계 업데이트
                loadCacheStats();
            }
        });

        function displayResults(data, isDetailViewMode = false) {
            const { metrics, chart_data, summary, allocation_data, holdings_table } = data;

            // 전역 변수에 저장
            currentHoldings = holdings_table;
            currentCurrency = summary.base_currency;
            isDetailView = isDetailViewMode;
            currentSortColumn = null; // 정렬 상태 초기화
            currentSortDirection = 'asc';

            // 통화 심볼 결정
            const currencySymbol = summary.base_currency === 'USD' ? '$' : '₩';
            const currencyName = summary.base_currency === 'USD' ? 'USD' : 'KRW';

            // 자산 가치 표시 함수 (상세 뷰에서는 숨김)
            const formatValue = (value) => {
                return isDetailViewMode ? '-' : formatCurrency(value, summary.base_currency);
            };

            // 요약 정보 표시
            const summaryGrid = document.getElementById('summaryGrid');
            summaryGrid.innerHTML = `
                <div class="summary-item">
                    <div class="summary-label">보유 종목 수</div>
                    <div class="summary-value">${summary.num_holdings}</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">기준 통화</div>
                    <div class="summary-value">${currencyName}</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">USD/KRW 환율</div>
                    <div class="summary-value">${summary.exchange_rate.toLocaleString()}</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">시작 가치 (투자자산)</div>
                    <div class="summary-value">${formatValue(summary.initial_value)}</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">현재 가치 (투자자산)</div>
                    <div class="summary-value">${formatValue(summary.current_value)}</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">현금 보유액</div>
                    <div class="summary-value">${formatValue(summary.total_cash)}</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">총 자산 (현금포함)</div>
                    <div class="summary-value">${formatValue(summary.current_value_with_cash)}</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">수익률 (투자자산)</div>
                    <div class="summary-value ${summary.total_return >= 0 ? 'positive' : 'negative'}">
                        ${summary.total_return >= 0 ? '+' : ''}${summary.total_return}%
                    </div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">수익률 (현금포함)</div>
                    <div class="summary-value ${summary.total_return_with_cash >= 0 ? 'positive' : 'negative'}">
                        ${summary.total_return_with_cash >= 0 ? '+' : ''}${summary.total_return_with_cash}%
                    </div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">연평균 수익률 (CAGR)</div>
                    <div class="summary-value ${metrics.cagr >= 0 ? 'positive' : 'negative'}">
                        ${metrics.cagr >= 0 ? '+' : ''}${metrics.cagr}%
                    </div>
                </div>
            `;
            
            // 도넛 차트 생성
            createAllocationCharts(allocation_data, summary.base_currency);
            
            // 보유 종목 테이블 렌더링 (상세 뷰에서는 평가액 숨김)
            renderHoldingsTable(holdings_table, summary.base_currency, isDetailViewMode);
            
            // 정렬 헤더 초기화
            updateSortHeaders();

            // 그라데이션 색상 계산 함수
            function getGradientColor(value, benchmarkValue, isBetter) {
                // value가 benchmark보다 좋을수록 초록, 나쁠수록 빨강
                // isBetter: 'higher' (높을수록 좋음) 또는 'lower' (낮을수록 좋음)
                let diff = 0;
                if (isBetter === 'higher') {
                    diff = value - benchmarkValue;
                } else {
                    diff = benchmarkValue - value;
                }
                
                // 차이를 퍼센트로 변환 (벤치마크 대비)
                const percentDiff = benchmarkValue !== 0 ? (diff / Math.abs(benchmarkValue)) * 100 : diff * 100;
                
                // -50% ~ +50% 범위를 기준으로 색상 강도 계산
                const intensity = Math.max(-1, Math.min(1, percentDiff / 50));
                
                if (Math.abs(intensity) < 0.05) {
                    // 거의 같으면 매우 연한 회색
                    return 'rgb(245, 245, 245)';
                } else if (intensity > 0) {
                    // 초록색 (좋음) - 연한 초록 -> 진한 초록
                    const alpha = Math.abs(intensity);
                    const r = Math.floor(200 - alpha * 100); // 200 -> 100
                    const g = Math.floor(230 - alpha * 50);  // 230 -> 180
                    const b = Math.floor(200 - alpha * 100); // 200 -> 100
                    return `rgb(${r}, ${g}, ${b})`;
                } else {
                    // 빨간색 (나쁨) - 연한 빨강 -> 진한 빨강
                    const alpha = Math.abs(intensity);
                    const r = Math.floor(230 - alpha * 50);  // 230 -> 180
                    const g = Math.floor(200 - alpha * 100); // 200 -> 100
                    const b = Math.floor(200 - alpha * 100); // 200 -> 100
                    return `rgb(${r}, ${g}, ${b})`;
                }
            }

            // 배경색에 따른 텍스트 색상 결정 함수
            function getTextColor(value, benchmarkValue, isBetter) {
                // 모든 텍스트를 어두운 회색으로 통일
                return '#333';
            }

            // 성과 지표 표시
            const metricsGrid = document.getElementById('metricsGrid');
            metricsGrid.innerHTML = `
                <div class="metric-card" style="background: ${getGradientColor(metrics.sharpe_ratio, metrics.benchmark_sharpe_ratio, 'higher')};">
                    <div class="metric-label">샤프 비율 (Sharpe Ratio)</div>
                    <div class="metric-value" style="color: #333;">${metrics.sharpe_ratio}</div>
                    <div class="metric-description" style="font-size: 11px; color: #444;">
                        벤치마크: ${metrics.benchmark_sharpe_ratio}<br>
                        위험 대비 수익률. 높을수록 좋음
                    </div>
                </div>
                <div class="metric-card" style="background: ${getGradientColor(metrics.sortino_ratio, metrics.benchmark_sortino_ratio, 'higher')};">
                    <div class="metric-label">소티노 비율 (Sortino Ratio)</div>
                    <div class="metric-value" style="color: #333;">${metrics.sortino_ratio}</div>
                    <div class="metric-description" style="font-size: 11px; color: #444;">
                        벤치마크: ${metrics.benchmark_sortino_ratio}<br>
                        하방 위험 대비 수익률. 높을수록 좋음
                    </div>
                </div>
                <div class="metric-card" style="background: ${getGradientColor(metrics.alpha, 0, 'higher')};">
                    <div class="metric-label">알파 (Alpha)</div>
                    <div class="metric-value" style="color: ${getTextColor(metrics.alpha, 0, 'higher')};">
                        ${metrics.alpha >= 0 ? '+' : ''}${metrics.alpha}%
                    </div>
                    <div class="metric-description" style="font-size: 11px; color: #444;">
                        벤치마크: 0%<br>
                        벤치마크 대비 초과 수익률
                    </div>
                </div>
                <div class="metric-card" style="background: ${getGradientColor(Math.abs(metrics.beta - 1), 0, 'lower')};">
                    <div class="metric-label">베타 (Beta)</div>
                    <div class="metric-value" style="color: #333;">${metrics.beta}</div>
                    <div class="metric-description" style="font-size: 11px; color: #444;">
                        벤치마크: 1.0<br>
                        시장 민감도. 1.0 = 시장과 동일
                    </div>
                </div>
                <div class="metric-card" style="background: ${getGradientColor(metrics.cagr, metrics.benchmark_annual_return, 'higher')};">
                    <div class="metric-label">연평균 수익률 (CAGR)</div>
                    <div class="metric-value" style="color: ${getTextColor(metrics.cagr, metrics.benchmark_annual_return, 'higher')};">
                        ${metrics.cagr >= 0 ? '+' : ''}${metrics.cagr}%
                    </div>
                    <div class="metric-description" style="font-size: 11px; color: #444;">
                        벤치마크: ${metrics.benchmark_annual_return >= 0 ? '+' : ''}${metrics.benchmark_annual_return}%<br>
                        연간 복리 수익률
                    </div>
                </div>
                <div class="metric-card" style="background: ${getGradientColor(metrics.volatility, metrics.benchmark_volatility, 'lower')};">
                    <div class="metric-label">변동성 (Volatility)</div>
                    <div class="metric-value" style="color: #333;">${metrics.volatility}%</div>
                    <div class="metric-description" style="font-size: 11px; color: #444;">
                        벤치마크: ${metrics.benchmark_volatility}%<br>
                        연간 표준편차. 낮을수록 안정적
                    </div>
                </div>
            `;

            // 차트 생성
            const benchmarkName = summary.benchmark_name || summary.benchmark;
            createChart(chart_data, benchmarkName);
        }

        function createChart(chartData, benchmark) {
            const ctx = document.getElementById('performanceChart').getContext('2d');

            if (chart) {
                chart.destroy();
            }

            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartData.dates,
                    datasets: [
                        {
                            label: '내 포트폴리오',
                            data: chartData.portfolio_cumulative,
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            borderWidth: 3,
                            tension: 0.1,
                            fill: true,
                            pointRadius: 1,
                            pointHoverRadius: 5
                        },
                        {
                            label: `벤치마크 (${benchmark})`,
                            data: chartData.benchmark_cumulative,
                            borderColor: '#f43f5e',
                            backgroundColor: 'rgba(244, 63, 94, 0.1)',
                            borderWidth: 3,
                            tension: 0.1,
                            fill: true,
                            pointRadius: 1,
                            pointHoverRadius: 5
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    const value = context.parsed.y;
                                    const percent = ((value - 1) * 100).toFixed(2);
                                    label += `${value.toFixed(4)} (${percent >= 0 ? '+' : ''}${percent}%)`;
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            ticks: {
                                callback: function(value) {
                                    return value.toFixed(2);
                                }
                            },
                            title: {
                                display: true,
                                text: '누적 수익 (1.0 = 시작점)',
                                font: {
                                    size: 12,
                                    weight: 'bold'
                                }
                            }
                        },
                        x: {
                            ticks: {
                                maxTicksLimit: 10
                            },
                            title: {
                                display: true,
                                text: '날짜',
                                font: {
                                    size: 12,
                                    weight: 'bold'
                                }
                            }
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    }
                }
            });
        }

        function createAllocationCharts(allocationData, baseCurrency) {
            // 색상 팔레트
            const colors = [
                '#667eea', '#764ba2', '#f093fb', '#4facfe',
                '#43e97b', '#fa709a', '#fee140', '#30cfd0',
                '#a8edea', '#fed6e3', '#c471f5', '#ffecd2'
            ];

            // 시작 시점 도넛 차트
            const initialCtx = document.getElementById('initialAllocationChart').getContext('2d');
            if (initialAllocationChart) {
                initialAllocationChart.destroy();
            }

            initialAllocationChart = new Chart(initialCtx, {
                type: 'doughnut',
                data: {
                    labels: allocationData.initial.labels,
                    datasets: [{
                        data: allocationData.initial.values,
                        backgroundColor: colors.slice(0, allocationData.initial.labels.length),
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 10,
                                font: {
                                    size: 11
                                },
                                generateLabels: function(chart) {
                                    const data = chart.data;
                                    if (data.labels.length && data.datasets.length) {
                                        const total = data.datasets[0].data.reduce((a, b) => a + b, 0);
                                        return data.labels.map((label, i) => {
                                            const value = data.datasets[0].data[i];
                                            const percentage = ((value / total) * 100).toFixed(1);
                                            return {
                                                text: `${label}: ${percentage}%`,
                                                fillStyle: data.datasets[0].backgroundColor[i],
                                                hidden: false,
                                                index: i
                                            };
                                        });
                                    }
                                    return [];
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${label}: ${formatCurrency(value, baseCurrency)} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });

            // 현재 시점 도넛 차트
            const currentCtx = document.getElementById('currentAllocationChart').getContext('2d');
            if (currentAllocationChart) {
                currentAllocationChart.destroy();
            }

            currentAllocationChart = new Chart(currentCtx, {
                type: 'doughnut',
                data: {
                    labels: allocationData.current.labels,
                    datasets: [{
                        data: allocationData.current.values,
                        backgroundColor: colors.slice(0, allocationData.current.labels.length),
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 10,
                                font: {
                                    size: 11
                                },
                                generateLabels: function(chart) {
                                    const data = chart.data;
                                    if (data.labels.length && data.datasets.length) {
                                        const total = data.datasets[0].data.reduce((a, b) => a + b, 0);
                                        return data.labels.map((label, i) => {
                                            const value = data.datasets[0].data[i];
                                            const percentage = ((value / total) * 100).toFixed(1);
                                            return {
                                                text: `${label}: ${percentage}%`,
                                                fillStyle: data.datasets[0].backgroundColor[i],
                                                hidden: false,
                                                index: i
                                            };
                                        });
                                    }
                                    return [];
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${label}: ${formatCurrency(value, baseCurrency)} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderHoldingsTable(holdings, currency, isDetailView = false) {
            const tbody = document.getElementById('holdingsTableBody');
            
            tbody.innerHTML = holdings.map(h => `
                <tr style="border-bottom: 1px solid #e0e0e0;">
                    <td style="padding: 12px;"><strong>${h.ticker}</strong></td>
                    <td style="padding: 12px;">${h.name}</td>
                    <td style="padding: 12px; text-align: right;">${isDetailView ? '-' : (h.asset_class === '현금' ? '-' : h.quantity.toLocaleString())}</td>
                    <td style="padding: 12px; text-align: right;">${isDetailView ? '-' : formatCurrency(h.current_value, currency)}</td>
                    <td style="padding: 12px; text-align: right;"><strong>${h.weight}%</strong></td>
                </tr>
            `).join('');
        }

        function formatCurrency(value, currency = 'USD') {
            if (currency === 'KRW') {
                // 한국 원화
                if (value >= 100000000) {
                    return '₩' + (value / 100000000).toFixed(2) + '억';
                } else if (value >= 10000) {
                    return '₩' + (value / 10000).toFixed(0) + '만';
                }
                return '₩' + value.toLocaleString();
            } else {
                // 미국 달러
                if (value >= 1000000) {
                    return '$' + (value / 1000000).toFixed(2) + 'M';
                } else if (value >= 1000) {
                    return '$' + (value / 1000).toFixed(1) + 'K';
                }
                return '$' + value.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
            }
        }

        // 포트폴리오 저장 함수
        async function savePortfolio() {
            // 로그인 체크
            if (!isUserLoggedIn) {
                alert('🔒 로그인이 필요한 기능입니다.\n로그인 후 이용해주세요.');
                window.location.href = '/login';
                return;
            }
            
            const nameInput = document.getElementById('portfolioName');
            const name = nameInput.value.trim();
            const saveBtn = document.getElementById('saveBtn');
            const saveMessage = document.getElementById('saveMessage');
            
            if (!name) {
                alert('포트폴리오 이름을 입력해주세요.');
                nameInput.focus();
                return;
            }
            
            if (!currentAnalysisData) {
                alert('분석 결과가 없습니다. 먼저 분석을 실행해주세요.');
                return;
            }
            
            try {
                saveBtn.disabled = true;
                saveBtn.textContent = '저장 중...';
                
                const response = await fetch('/api/save-portfolio', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: name,
                        ...currentAnalysisData
                    })
                });
                
                const data = await response.json();
                
                if (response.status === 401) {
                    alert('🔒 ' + data.error);
                    window.location.href = '/login';
                    return;
                }
                
                if (!response.ok) {
                    throw new Error(data.error || '저장 중 오류가 발생했습니다.');
                }
                
                // 성공 메시지
                saveMessage.style.display = 'block';
                saveMessage.style.background = '#d4edda';
                saveMessage.style.color = '#155724';
                saveMessage.style.border = '1px solid #c3e6cb';
                saveMessage.textContent = `✅ ${data.message}`;
                
                // 입력 필드 초기화
                nameInput.value = '';
                
            } catch (err) {
                console.error('❌ Save Error:', err);
                saveMessage.style.display = 'block';
                saveMessage.style.background = '#f8d7da';
                saveMessage.style.color = '#721c24';
                saveMessage.style.border = '1px solid #f5c6cb';
                saveMessage.textContent = `❌ ${err.message}`;
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = '💾 저장하기';
            }
        }

        // CSV 내보내기 함수
        function exportToCSV() {
            if (!currentAnalysisData || !currentAnalysisData.csv_content) {
                alert('내보낼 데이터가 없습니다. 먼저 포트폴리오를 분석해주세요.');
                return;
            }

            try {
                // CSV 컨텐츠 가져오기
                const csvContent = currentAnalysisData.csv_content;
                
                // Blob 생성
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                
                // 다운로드 링크 생성
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                
                // 파일명 생성 (현재 날짜 포함)
                const today = new Date();
                const dateStr = today.toISOString().split('T')[0];
                const fileName = `portfolio_${dateStr}.csv`;
                
                link.setAttribute('href', url);
                link.setAttribute('download', fileName);
                link.style.visibility = 'hidden';
                
                // DOM에 추가하고 클릭
                document.body.appendChild(link);
                link.click();
                
                // 정리
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                console.log('✅ CSV exported successfully:', fileName);
                
                // 성공 메시지
                const saveMessage = document.getElementById('saveMessage');
                saveMessage.style.display = 'block';
                saveMessage.style.background = '#d4edda';
                saveMessage.style.color = '#155724';
                saveMessage.style.border = '1px solid #c3e6cb';
                saveMessage.textContent = `✅ CSV 파일이 다운로드되었습니다: ${fileName}`;
                
                // 3초 후 메시지 숨기기
                setTimeout(() => {
                    saveMessage.style.display = 'none';
                }, 3000);
                
            } catch (err) {
                console.error('❌ Export Error:', err);
                alert('CSV 내보내기 중 오류가 발생했습니다: ' + err.message);
            }
        }

        // AI 분석 결과 캐시 (같은 세션에서는 재요청하지 않음)
        let aiAnalysisResultCache = null;

        // AI 분석 함수
        async function analyzeWithAI() {
            // 로그인 체크
            if (!isUserLoggedIn) {
                alert('🔒 로그인이 필요한 기능입니다.\nAI 분석은 로그인 후 이용하실 수 있습니다.');
                window.location.href = '/login';
                return;
            }
            
            if (!currentAnalysisData) {
                alert('분석 데이터가 없습니다. 먼저 포트폴리오 분석을 실행해주세요.');
                return;
            }
            
            // 모달 열기
            const modal = document.getElementById('aiAnalysisModal');
            const loadingState = document.getElementById('aiLoadingState');
            const contentDiv = document.getElementById('aiAnalysisContent');
            
            openAIModal();
            
            // 캐시된 결과가 있으면 바로 표시
            if (aiAnalysisResultCache) {
                console.log('✅ Using cached AI analysis result');
                loadingState.style.display = 'none';
                contentDiv.style.display = 'block';
                contentDiv.innerHTML = aiAnalysisResultCache;
                return;
            }
            
            loadingState.style.display = 'block';
            contentDiv.style.display = 'none';
            contentDiv.innerHTML = '';
            
            try {
                console.log('🤖 Requesting AI analysis...');
                
                const response = await fetch('/api/ai-analysis', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        holdings: currentAnalysisData.holdings_table,
                        metrics: currentAnalysisData.metrics,
                        summary: currentAnalysisData.summary
                    })
                });
                
                const data = await response.json();
                
                // 로그인 체크
                if (response.status === 401) {
                    closeAIModal();
                    alert('🔒 ' + data.error);
                    window.location.href = '/login';
                    return;
                }
                
                // Rate limiting 처리
                if (response.status === 429 || data.rate_limited) {
                    throw new Error(data.error || 'AI 분석은 1분에 1번만 가능합니다.');
                }
                
                if (!response.ok || !data.success) {
                    throw new Error(data.error || 'AI 분석 요청이 실패했습니다.');
                }
                
                console.log('✅ AI analysis received' + (data.cached ? ' (from server cache)' : ''));
                
                // 마크다운을 HTML로 변환
                const htmlContent = marked.parse(data.analysis);
                
                // 결과 캐시에 저장
                aiAnalysisResultCache = htmlContent;
                
                // 결과 표시
                loadingState.style.display = 'none';
                contentDiv.style.display = 'block';
                contentDiv.innerHTML = htmlContent;
                
            } catch (err) {
                console.error('❌ AI Analysis Error:', err);
                loadingState.style.display = 'none';
                contentDiv.style.display = 'block';
                
                // Rate limit 에러인 경우 특별한 메시지 표시
                const isRateLimitError = err.message.includes('3분에 1번') || err.message.includes('1분에 1번');
                const errorIcon = isRateLimitError ? '⏱️' : '⚠️';
                const errorColor = isRateLimitError ? '#f59e0b' : '#ef4444';
                
                contentDiv.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: ${errorColor};">
                        <div style="font-size: 48px; margin-bottom: 20px;">${errorIcon}</div>
                        <div style="font-size: 18px; font-weight: 600; margin-bottom: 10px;">
                            ${isRateLimitError ? 'AI 분석 요청 제한' : 'AI 분석 중 오류가 발생했습니다'}
                        </div>
                        <div style="font-size: 14px; color: #999;">
                            ${err.message}
                        </div>
                    </div>
                `;
            }
        }
        
        function closeAIModal() {
            document.getElementById('aiAnalysisModal').style.display = 'none';
            // 모바일에서 body 스크롤 복원
            document.body.style.overflow = '';
        }
        
        // 모달 열기 헬퍼 함수
        function openAIModal() {
            document.getElementById('aiAnalysisModal').style.display = 'block';
            // 모바일에서 배경 스크롤 방지
            document.body.style.overflow = 'hidden';
        }
        
        // 모달 외부 클릭시 닫기
        document.getElementById('aiAnalysisModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeAIModal();
            }
        });
    </script>
</body>
</html>
