<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í¬íŠ¸í´ë¦¬ì˜¤ ì„±ê³¼ ë¶„ì„ê¸°</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            margin-bottom: 20px;
        }

        /* ë„¤ë¹„ê²Œì´ì…˜ ë°” ë°”ë¡œ ë‹¤ìŒì˜ ì¹´ë“œëŠ” ìƒë‹¨ ë‘¥ê·¼ ëª¨ì„œë¦¬ ì œê±° */
        #analysisFormCard {
            border-radius: 0 0 15px 15px;
            margin-top: 0;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        input[type="file"],
        input[type="date"],
        input[type="text"],
        select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
            background-color: white;
        }

        input[type="file"]:focus,
        input[type="date"]:focus,
        input[type="text"]:focus,
        select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #667eea;
            font-weight: 600;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #fee;
            color: #c33;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #c33;
            display: none;
        }

        .results {
            display: none;
        }

        /* ìˆ˜ë™ ì…ë ¥ í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        .input-table-container {
            margin-top: 20px;
            overflow-x: auto;
        }

        .input-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 10px;
        }

        .input-table th {
            background: #f5f5f5;
            padding: 10px;
            text-align: left;
            border-bottom: 2px solid #667eea;
            font-weight: 600;
            font-size: 14px;
        }

        .input-table td {
            padding: 8px;
            border-bottom: 1px solid #e0e0e0;
        }

        .input-table input[type="text"],
        .input-table input[type="number"],
        .input-table select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .input-table input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .delete-row-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .delete-row-btn:hover {
            background: #dc2626;
        }

        /* ëª¨ë°”ì¼ ë°˜ì‘í˜• - ì§ì ‘ ì…ë ¥ í…Œì´ë¸” */
        @media (max-width: 768px) {
            .input-table th,
            .input-table td {
                padding: 6px 4px;
                font-size: 12px;
            }

            .input-table input[type="text"],
            .input-table input[type="number"],
            .input-table select {
                padding: 6px;
                font-size: 13px;
            }

            .delete-row-btn {
                padding: 4px 8px;
                font-size: 11px;
            }
        }

        @media (max-width: 480px) {
            .input-table th,
            .input-table td {
                padding: 4px 2px;
                font-size: 11px;
            }

            .input-table input[type="text"],
            .input-table input[type="number"],
            .input-table select {
                padding: 4px;
                font-size: 12px;
                min-width: 60px;
            }

            .input-table input[type="checkbox"] {
                width: 16px;
                height: 16px;
            }

            .delete-row-btn {
                padding: 3px 6px;
                font-size: 10px;
            }
        }

        .add-row-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .add-row-btn:hover {
            opacity: 0.9;
        }

        .input-mode-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .mode-btn {
            flex: 1;
            padding: 10px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        .mode-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .mode-btn:hover {
            transform: translateY(-2px);
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .summary-item {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .summary-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .summary-value {
            font-size: 24px;
            font-weight: 700;
            color: #333;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .metric-label {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 10px;
            font-weight: 500;
            color: #333;
        }

        .metric-value {
            font-size: 32px;
            font-weight: 700;
        }

        .metric-description {
            font-size: 11px;
            opacity: 0.8;
            margin-top: 5px;
            color: #444;
        }

        .chart-container {
            margin-top: 20px;
            position: relative;
            height: 400px;
        }

        canvas {
            max-width: 100%;
        }

        .helper-text {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
            font-style: italic;
        }

        .positive {
            color: #22c55e;
        }

        .negative {
            color: #ef4444;
        }

        /* ì •ë ¬ ê°€ëŠ¥í•œ í…Œì´ë¸” í—¤ë” */
        .sortable-header {
            cursor: pointer;
            user-select: none;
            position: relative;
            padding-right: 20px !important;
        }

        .sortable-header:hover {
            background: #e8e8e8;
        }

        .sortable-header::after {
            content: 'â‡…';
            position: absolute;
            right: 8px;
            opacity: 0.3;
            font-size: 14px;
        }

        .sortable-header.sort-asc::after {
            content: 'â†‘';
            opacity: 1;
            color: #667eea;
        }

        .sortable-header.sort-desc::after {
            content: 'â†“';
            opacity: 1;
            color: #667eea;
        }

        /* ë„¤ë¹„ê²Œì´ì…˜ ë°” ìŠ¤íƒ€ì¼ */
        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 0;
            margin: 0 0 0 0;
            border-radius: 15px 15px 0 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .navbar-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px 30px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .navbar-title {
            color: white;
            font-size: 24px;
            font-weight: 700;
            text-decoration: none;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .navbar-title:hover {
            opacity: 0.9;
        }

        .navbar-links {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .navbar-link {
            color: white;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 500;
            transition: background 0.2s;
            white-space: nowrap;
        }

        .navbar-link:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .navbar-link.active {
            background: rgba(255, 255, 255, 0.3);
        }

        /* ëª¨ë°”ì¼ ë°˜ì‘í˜• - í—¤ë” */
        @media (max-width: 768px) {
            .navbar-content {
                padding: 10px 15px;
            }

            .navbar-title {
                font-size: 18px;
            }

            .navbar-links {
                gap: 5px;
            }

            .navbar-link {
                padding: 6px 12px;
                font-size: 14px;
            }
        }

        @media (max-width: 480px) {
            .navbar-title {
                font-size: 16px;
            }

            .navbar-link {
                padding: 5px 10px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ë„¤ë¹„ê²Œì´ì…˜ ë°” -->
        <div class="navbar">
            <div class="navbar-content">
                <a href="/" class="navbar-title">ğŸ“Š í¬íŠ¸í´ë¦¬ì˜¤ ì„±ê³¼ ë¶„ì„ê¸°</a>
                <div class="navbar-links">
                    <a href="/" class="navbar-link active">ë¶„ì„í•˜ê¸°</a>
                    <a href="/ranking" class="navbar-link">ë­í‚¹ë³´ê¸°</a>
                    <a href="/exchange-rate" class="navbar-link">í™˜ìœ¨</a>
                    <a href="/login" class="navbar-link" id="authLink">ë¡œê·¸ì¸</a>
                </div>
            </div>
        </div>

        <div class="card" id="analysisFormCard">
            <form id="analysisForm" enctype="multipart/form-data">
                <!-- ì…ë ¥ ëª¨ë“œ ì„ íƒ -->
                <div class="input-mode-toggle">
                    <button type="button" class="mode-btn active" id="manualModeBtn">âœï¸ ì§ì ‘ ì…ë ¥</button>
                    <button type="button" class="mode-btn" id="csvModeBtn">ğŸ“ CSV ë¶ˆëŸ¬ì˜¤ê¸°</button>
                </div>

                <!-- CSV ì—…ë¡œë“œ ëª¨ë“œ -->
                <div id="csvUploadSection" class="form-group" style="display: none;">
                    <label for="csvFile">í¬íŠ¸í´ë¦¬ì˜¤ CSV íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°</label>
                    <input type="file" id="csvFile" name="csv_file" accept=".csv">
                    <div class="helper-text">
                        CSV íŒŒì¼ì„ ì„ íƒí•˜ë©´ ìë™ìœ¼ë¡œ ì•„ë˜ ì…ë ¥ í¼ì´ ì±„ì›Œì§‘ë‹ˆë‹¤. CSV íŒŒì¼ì€ "í‹°ì»¤", "ë³´ìœ ëŸ‰", "êµ­ê°€" ì»¬ëŸ¼ì„ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤.
                    </div>
                </div>

                <!-- ìˆ˜ë™ ì…ë ¥ ëª¨ë“œ -->
                <div id="manualInputSection">
                    <label>í¬íŠ¸í´ë¦¬ì˜¤ ì¢…ëª© ì…ë ¥</label>
                    <div class="input-table-container">
                        <table class="input-table">
                            <thead>
                                <tr>
                                    <th style="width: 30%;">í‹°ì»¤</th>
                                    <th style="width: 25%;">ë³´ìœ ìˆ˜ëŸ‰</th>
                                    <th style="width: 20%;">êµ­ê°€</th>
                                    <th style="width: 25%;">ì‚­ì œ</th>
                                </tr>
                            </thead>
                            <tbody id="manualInputTableBody">
                                <!-- ì´ˆê¸° í–‰ -->
                                <tr class="input-row">
                                    <td><input type="text" class="ticker-input" placeholder="ì˜ˆ: AAPL"></td>
                                    <td><input type="number" class="quantity-input" placeholder="ë³´ìœ  ì£¼ì‹ ìˆ˜ (ì˜ˆ: 10)" min="0" step="1"></td>
                                    <td>
                                        <select class="country-input">
                                            <option value="ë¯¸êµ­">ë¯¸êµ­</option>
                                            <option value="í•œêµ­">í•œêµ­</option>
                                        </select>
                                    </td>
                                    <td><button type="button" class="delete-row-btn" onclick="deleteRow(this)">ì‚­ì œ</button></td>
                                </tr>
                            </tbody>
                        </table>
                        <div style="display: flex; gap: 10px;">
                            <button type="button" class="add-row-btn" onclick="addRow()" style="flex: 1;">
                                <span>â•</span>
                                <span>ì¢…ëª© ì¶”ê°€</span>
                            </button>
                            <button type="button" class="add-row-btn" onclick="addDcaRow()" style="flex: 1; background: #28a745;">
                                <span>ğŸ“ˆ</span>
                                <span>ì ë¦½ì‹ íˆ¬ì ì¶”ê°€</span>
                            </button>
                        </div>
                        
                        <!-- ì ë¦½ì‹ íˆ¬ì ì„¹ì…˜ -->
                        <div id="dcaSection" style="margin-top: 20px; padding: 15px; background: #f0f8ff; border-radius: 8px; border: 1px solid #b0d4f1; display: none;">
                            <h4 style="margin: 0 0 15px 0; color: #0066cc; font-size: 14px; font-weight: 600;">ğŸ“ˆ ì ë¦½ì‹ íˆ¬ì (Dollar Cost Averaging)</h4>
                            <table class="input-table">
                                <thead>
                                    <tr>
                                        <th style="width: 25%;">í‹°ì»¤</th>
                                        <th style="width: 20%;">1ì£¼ê¸°ë‹¹ ì¶”ê°€ìˆ˜ëŸ‰</th>
                                        <th style="width: 15%;">êµ­ê°€</th>
                                        <th style="width: 20%;">ì£¼ê¸°</th>
                                        <th style="width: 20%;">ì‚­ì œ</th>
                                    </tr>
                                </thead>
                                <tbody id="dcaInputTableBody">
                                    <!-- DCA í–‰ë“¤ì´ ì—¬ê¸°ì— ì¶”ê°€ë¨ -->
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- í˜„ê¸ˆ ì…ë ¥ ì„¹ì…˜ -->
                        <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e0e0e0;">
                            <h4 style="margin: 0 0 15px 0; color: #333; font-size: 14px; font-weight: 600;">ğŸ’° í˜„ê¸ˆ ë³´ìœ ì•¡</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div>
                                    <label style="display: block; margin-bottom: 5px; color: #666; font-size: 13px;">ì›í™” (KRW)</label>
                                    <input type="number" id="cashKRW" placeholder="ì›í™” ê¸ˆì•¡ (ì˜ˆ: 1000000)" min="0" step="1" value="0" 
                                           style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; box-sizing: border-box;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; color: #666; font-size: 13px;">ë‹¬ëŸ¬ (USD)</label>
                                    <input type="number" id="cashUSD" placeholder="ë‹¬ëŸ¬ ê¸ˆì•¡ (ì˜ˆ: 1000.50)" min="0" step="0.01" value="0" 
                                           style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; box-sizing: border-box;">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="startDate">ì‹œì‘ ì¼ì</label>
                    <input type="date" id="startDate" name="start_date" required>
                    <div class="helper-text">
                        ë¶„ì„ì„ ì‹œì‘í•  ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”. (ì˜ˆ: í¬íŠ¸í´ë¦¬ì˜¤ êµ¬ì„± ì‹œì‘ì¼)
                    </div>
                </div>

                <div class="form-group">
                    <label for="benchmarkTicker">ë²¤ì¹˜ë§ˆí¬</label>
                    <select id="benchmarkTicker" name="benchmark_ticker" required>
                        <option value="SPY">S&P 500</option>
                        <option value="QQQ">NASDAQ 100</option>
                        <option value="069500.KS">KODEX 200</option>
                        <option value="CUSTOM">ê¸°íƒ€ (ì§ì ‘ ì…ë ¥)</option>
                        <option disabled>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</option>
                        <option value="HEDGEFUND_BLACKROCK">ğŸ¢ ë¸”ë™ë¡ (BlackRock)</option>
                        <option value="HEDGEFUND_BERKSHIRE">ğŸ¢ ë²„í¬ì…” í•´ì„œì›¨ì´ (Berkshire Hathaway)</option>
                    </select>
                    <div class="helper-text">
                        í¬íŠ¸í´ë¦¬ì˜¤ ì„±ê³¼ë¥¼ ë¹„êµí•  ë²¤ì¹˜ë§ˆí¬ë¥¼ ì„ íƒí•˜ì„¸ìš”.
                    </div>
                </div>

                <!-- ê¸°íƒ€ ë²¤ì¹˜ë§ˆí¬ ì…ë ¥ í•„ë“œ (ìˆ¨ê¹€ ìƒíƒœë¡œ ì‹œì‘) -->
                <div class="form-group" id="customBenchmarkGroup" style="display: none;">
                    <label for="customBenchmarkTicker">ë²¤ì¹˜ë§ˆí¬ í‹°ì»¤</label>
                    <input type="text" id="customBenchmarkTicker" name="custom_benchmark_ticker" placeholder="ì˜ˆ: ARKK, VTI, ^IXIC">
                    <div class="helper-text">
                        ë¹„êµí•  ë²¤ì¹˜ë§ˆí¬ì˜ í‹°ì»¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”. (ì˜ˆ: ARKK, VTI, ^IXIC ë“±)
                    </div>
                </div>

                <div class="form-group">
                    <label for="baseCurrency">ê¸°ì¤€ í†µí™”</label>
                    <select id="baseCurrency" name="base_currency" required>
                        <option value="USD">ë¯¸êµ­ ë‹¬ëŸ¬ (USD)</option>
                        <option value="KRW">í•œêµ­ ì›í™” (KRW)</option>
                    </select>
                    <div class="helper-text">
                        í¬íŠ¸í´ë¦¬ì˜¤ë¥¼ í‰ê°€í•  ê¸°ì¤€ í†µí™”ë¥¼ ì„ íƒí•˜ì„¸ìš”. ì„ íƒí•œ í†µí™”ë¡œ ëª¨ë“  ìì‚°ì´ í™˜ì‚°ë©ë‹ˆë‹¤.
                    </div>
                </div>

                <button type="submit" class="btn" id="analyzeBtn">ë¶„ì„ ì‹œì‘</button>
            </form>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <div>í¬íŠ¸í´ë¦¬ì˜¤ë¥¼ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...</div>
            </div>

            <div class="error" id="error" style="margin-top: 20px;"></div>
            
            <!-- ìºì‹œ í†µê³„ -->
            <div style="margin-top: 20px; padding: 15px; background: #f5f7fa; border-radius: 8px; font-size: 12px; color: #666;">
                <div>
                    <strong>ğŸ’¾ ë°ì´í„° ìºì‹œ:</strong> 
                    <span id="cacheStats">ë¡œë”© ì¤‘...</span>
                </div>
            </div>
        </div>

        <div class="results" id="results">
            <!-- í¬íŠ¸í´ë¦¬ì˜¤ ì´ë¦„ í‘œì‹œ (ìƒì„¸ ë·° ì „ìš©) -->
            <div class="card" id="portfolioNameSection" style="display: none;">
                <h1 style="margin: 0; color: #333; font-size: 2em;">
                    <span id="portfolioNameDisplay"></span>
                </h1>
                <div style="margin-top: 10px; font-size: 14px; color: #666;">
                    ğŸ‘¤ <span id="portfolioOwnerDisplay" style="font-weight: 600;"></span>
                </div>
                <div id="privacyNotice" style="margin-top: 15px; padding: 12px; border-left: 4px solid #ffc107; border-radius: 4px; font-size: 14px;">
                    <!-- JavaScriptì—ì„œ ë™ì ìœ¼ë¡œ ë‚´ìš© ì„¤ì • -->
                </div>
            </div>
            
            <div class="card">
                <h2 style="margin-bottom: 20px; color: #333;">ğŸ“ˆ í¬íŠ¸í´ë¦¬ì˜¤ ìš”ì•½</h2>
                <div class="summary-grid" id="summaryGrid"></div>
            </div>

            <div class="card">
                <h2 style="margin-bottom: 20px; color: #333;">ğŸ’¼ ë³´ìœ  ì¢…ëª© í˜„í™©</h2>
                <div style="overflow-x: auto;">
                    <table id="holdingsTable" style="width: 100%; border-collapse: collapse; margin-top: 10px;">
                        <thead>
                            <tr style="background: #f5f5f5;">
                                <th class="sortable-header" onclick="sortHoldings('ticker')" style="padding: 12px; text-align: left; border-bottom: 2px solid #667eea;">í‹°ì»¤</th>
                                <th style="padding: 12px; text-align: left; border-bottom: 2px solid #667eea;">ì¢…ëª©ëª…</th>
                                <th style="padding: 12px; text-align: right; border-bottom: 2px solid #667eea;">ë³´ìœ ìˆ˜ëŸ‰</th>
                                <th style="padding: 12px; text-align: right; border-bottom: 2px solid #667eea;">í‰ê°€ì•¡</th>
                                <th class="sortable-header" onclick="sortHoldings('weight')" style="padding: 12px; text-align: right; border-bottom: 2px solid #667eea;">ë¹„ì¤‘(%)</th>
                            </tr>
                        </thead>
                        <tbody id="holdingsTableBody">
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="card">
                <h2 style="margin-bottom: 20px; color: #333;">ğŸ¥§ ìì‚° ë°°ë¶„ ë¹„ì¤‘</h2>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 20px;">
                    <div>
                        <h3 style="text-align: center; margin-bottom: 15px; color: #666; font-size: 16px;">ì‹œì‘ ì‹œì </h3>
                        <div style="position: relative; height: 300px;">
                            <canvas id="initialAllocationChart"></canvas>
                        </div>
                    </div>
                    <div>
                        <h3 style="text-align: center; margin-bottom: 15px; color: #666; font-size: 16px;">í˜„ì¬ ì‹œì </h3>
                        <div style="position: relative; height: 300px;">
                            <canvas id="currentAllocationChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2 style="margin-bottom: 20px; color: #333;">ğŸ“Š ì„±ê³¼ ì§€í‘œ</h2>
                <div class="metrics-grid" id="metricsGrid"></div>
            </div>

            <div class="card">
                <h2 style="margin-bottom: 20px; color: #333;">ğŸ“‰ ëˆ„ì  ìˆ˜ìµë¥  ë¹„êµ</h2>
                <div class="chart-container">
                    <canvas id="performanceChart"></canvas>
                </div>
            </div>

            <!-- ì €ì¥ ë²„íŠ¼ -->
            <div class="card" id="saveSection" style="display: none;">
                <h2 style="margin-bottom: 20px; color: #333;">ğŸ’¾ í¬íŠ¸í´ë¦¬ì˜¤ ì €ì¥</h2>
                <div style="display: flex; gap: 15px; align-items: center; margin-bottom: 15px;">
                    <input 
                        type="text" 
                        id="portfolioName" 
                        placeholder="í¬íŠ¸í´ë¦¬ì˜¤ ì´ë¦„ ì…ë ¥" 
                        style="flex: 1; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px;"
                    >
                    <button 
                        id="saveBtn" 
                        onclick="savePortfolio()"
                        style="padding: 12px 30px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; white-space: nowrap;"
                    >
                        ğŸ’¾ ì €ì¥í•˜ê¸°
                    </button>
                </div>
                <!-- CSV ë‚´ë³´ë‚´ê¸° ë²„íŠ¼ (ì§ì ‘ ì…ë ¥ ëª¨ë“œ ì „ìš©) -->
                <div id="exportSection" style="display: none;">
                    <button 
                        id="exportBtn" 
                        onclick="exportToCSV()"
                        style="width: 100%; padding: 12px 30px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer;"
                    >
                        ğŸ“¥ CSVë¡œ ë‚´ë³´ë‚´ê¸°
                    </button>
                    <div style="margin-top: 10px; font-size: 12px; color: #666;">
                        ğŸ’¡ ì…ë ¥í•œ í¬íŠ¸í´ë¦¬ì˜¤ë¥¼ CSV íŒŒì¼ë¡œ ë‹¤ìš´ë¡œë“œí•˜ì—¬ ë‚˜ì¤‘ì— ë‹¤ì‹œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                    </div>
                </div>
                <div id="saveMessage" style="margin-top: 15px; padding: 12px; border-radius: 6px; display: none;"></div>
            </div>

            <!-- AI ë¶„ì„ ë²„íŠ¼ -->
            <div class="card" id="aiAnalysisSection" style="display: none; text-align: center;">
                <button 
                    id="aiAnalysisBtn" 
                    onclick="analyzeWithAI()"
                    style="
                        padding: 20px 40px;
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        color: white;
                        border: none;
                        border-radius: 50px;
                        font-size: 16px;
                        font-weight: 700;
                        cursor: pointer;
                        box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
                        transition: all 0.3s ease;
                        display: inline-flex;
                        align-items: center;
                        gap: 12px;
                    "
                    onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 12px 24px rgba(102, 126, 234, 0.4)';"
                    onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 8px 20px rgba(102, 126, 234, 0.3)';"
                >
                    <span style="font-size: 24px;">ğŸ¤–</span>
                    <span>AIë¡œ ë¶„ì„í•˜ê¸°</span>
                </button>
                <div style="margin-top: 15px; font-size: 13px; color: #666;">
                    ğŸ’¡ AIê°€ í¬íŠ¸í´ë¦¬ì˜¤ ì„±ê³¼ë¥¼ ë¶„ì„í•˜ê³  ì¸ì‚¬ì´íŠ¸ë¥¼ ì œê³µí•©ë‹ˆë‹¤.
                </div>
            </div>

            <!-- AI ë¶„ì„ ê²°ê³¼ ëª¨ë‹¬ -->
            <div id="aiAnalysisModal" class="ai-modal">
                <div class="ai-modal-container">
                    <!-- ëª¨ë‹¬ í—¤ë” -->
                    <div class="ai-modal-header">
                        <h2 class="ai-modal-title">
                            <span class="ai-icon">ğŸ¤–</span>
                            <span class="ai-title-text">AI í¬íŠ¸í´ë¦¬ì˜¤ ë¶„ì„</span>
                        </h2>
                        <button onclick="closeAIModal()" class="ai-modal-close" 
                            onmouseover="this.style.background='rgba(255,255,255,0.2)'" 
                            onmouseout="this.style.background='none'">
                            Ã—
                        </button>
                    </div>
                    
                    <!-- ë¡œë”© ìƒíƒœ -->
                    <div id="aiLoadingState" class="ai-loading">
                        <div class="ai-loading-icon">ğŸ¤–</div>
                        <div class="ai-loading-title">
                            AIê°€ í¬íŠ¸í´ë¦¬ì˜¤ë¥¼ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...
                        </div>
                        <div class="ai-loading-subtitle">
                            ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”
                        </div>
                        <div class="ai-loading-warning">
                            âš ï¸ <strong>ì£¼ì˜:</strong> ë¶„ì„ì´ ì™„ë£Œë  ë•Œê¹Œì§€ ì°½ì„ ë‹«ê±°ë‚˜ í™”ë©´ì„ ë²—ì–´ë‚˜ì§€ ë§ˆì„¸ìš”.
                        </div>
                        <div class="ai-loading-spinner-wrapper">
                            <div class="ai-loading-spinner"></div>
                        </div>
                    </div>
                    
                    <!-- ë¶„ì„ ê²°ê³¼ -->
                    <div id="aiAnalysisContent" class="ai-content"></div>
                </div>
            </div>
        </div>
    </div>

    <style>
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* AI ëª¨ë‹¬ ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
        .ai-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 9999;
            overflow-y: auto;
            padding: 20px;
        }
        
        .ai-modal-container {
            max-width: 900px;
            margin: 30px auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            position: relative;
        }
        
        .ai-modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px 25px;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .ai-modal-title {
            margin: 0;
            color: white;
            font-size: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .ai-icon {
            font-size: 24px;
        }
        
        .ai-title-text {
            font-size: 20px;
        }
        
        .ai-modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 28px;
            cursor: pointer;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.2s;
            flex-shrink: 0;
        }
        
        .ai-loading {
            padding: 40px 20px;
            text-align: center;
            display: none;
        }
        
        .ai-loading-icon {
            font-size: 48px;
            margin-bottom: 20px;
        }
        
        .ai-loading-title {
            font-size: 18px;
            color: #667eea;
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        .ai-loading-subtitle {
            font-size: 14px;
            color: #999;
            margin-bottom: 20px;
        }
        
        .ai-loading-warning {
            font-size: 13px;
            color: #ef4444;
            background: #fee;
            padding: 12px;
            border-radius: 6px;
            margin: 0 auto 30px;
            max-width: 400px;
            border: 1px solid #fcc;
        }
        
        .ai-loading-spinner-wrapper {
            margin-top: 30px;
        }
        
        .ai-loading-spinner {
            display: inline-block;
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        .ai-content {
            padding: 30px;
            max-height: 70vh;
            overflow-y: auto;
            line-height: 1.8;
        }
        
        /* ë§ˆí¬ë‹¤ìš´ ìŠ¤íƒ€ì¼ë§ */
        #aiAnalysisContent h2 {
            color: #333;
            margin-top: 30px;
            margin-bottom: 15px;
            font-size: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e0e0e0;
            word-break: keep-all;
        }
        
        #aiAnalysisContent h2:first-child {
            margin-top: 0;
        }
        
        #aiAnalysisContent ul {
            margin-left: 20px;
            margin-bottom: 20px;
            padding-left: 0;
        }
        
        #aiAnalysisContent li {
            margin-bottom: 10px;
            color: #333;
            word-break: keep-all;
        }
        
        #aiAnalysisContent strong {
            color: #667eea;
            font-weight: 600;
        }
        
        #aiAnalysisContent p {
            margin-bottom: 15px;
            color: #555;
            word-break: keep-all;
        }
        
        #aiAnalysisContent code {
            background: #f5f5f5;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            color: #e83e8c;
            font-size: 0.9em;
            word-break: break-all;
        }
        
        /* í…Œì´ë¸” ìŠ¤íƒ€ì¼ë§ (AI ë¶„ì„ ê²°ê³¼ì— í¬í•¨ë  ìˆ˜ ìˆìŒ) */
        #aiAnalysisContent table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            font-size: 14px;
        }
        
        #aiAnalysisContent th,
        #aiAnalysisContent td {
            border: 1px solid #e0e0e0;
            padding: 8px;
            text-align: left;
        }
        
        #aiAnalysisContent th {
            background: #f5f5f5;
            font-weight: 600;
            color: #333;
        }
        
        #aiAnalysisContent blockquote {
            border-left: 4px solid #667eea;
            margin: 15px 0;
            padding: 10px 20px;
            background: #f8f9ff;
            color: #555;
        }
        
        /* ëª¨ë°”ì¼ ë°˜ì‘í˜• ìŠ¤íƒ€ì¼ */
        @media (max-width: 768px) {
            .ai-modal {
                padding: 0;
            }
            
            .ai-modal-container {
                margin: 0;
                border-radius: 0;
                min-height: 100vh;
                max-width: 100%;
            }
            
            .ai-modal-header {
                padding: 15px 20px;
                border-radius: 0;
                position: sticky;
                top: 0;
                z-index: 10;
            }
            
            .ai-modal-title {
                font-size: 16px;
                gap: 8px;
            }
            
            .ai-icon {
                font-size: 20px;
            }
            
            .ai-title-text {
                font-size: 16px;
            }
            
            .ai-modal-close {
                font-size: 24px;
                width: 32px;
                height: 32px;
            }
            
            .ai-loading {
                padding: 30px 15px;
            }
            
            .ai-loading-icon {
                font-size: 36px;
                margin-bottom: 15px;
            }
            
            .ai-loading-title {
                font-size: 16px;
                margin-bottom: 8px;
            }
            
            .ai-loading-subtitle {
                font-size: 13px;
                margin-bottom: 15px;
            }
            
            .ai-loading-warning {
                font-size: 12px;
                padding: 10px;
                margin: 0 15px 20px;
                max-width: 100%;
            }
            
            .ai-loading-spinner {
                width: 40px;
                height: 40px;
                border-width: 4px;
            }
            
            .ai-content {
                padding: 20px 15px;
                max-height: calc(100vh - 80px);
            }
            
            #aiAnalysisContent h2 {
                font-size: 18px;
                margin-top: 20px;
                margin-bottom: 12px;
                padding-bottom: 8px;
            }
            
            #aiAnalysisContent ul {
                margin-left: 10px;
                margin-bottom: 15px;
                padding-left: 10px;
            }
            
            #aiAnalysisContent li {
                margin-bottom: 8px;
                font-size: 14px;
                line-height: 1.6;
            }
            
            #aiAnalysisContent p {
                margin-bottom: 12px;
                font-size: 14px;
                line-height: 1.6;
            }
            
            #aiAnalysisContent code {
                font-size: 0.85em;
                padding: 1px 4px;
            }
            
            #aiAnalysisContent table {
                font-size: 12px;
                display: block;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            #aiAnalysisContent th,
            #aiAnalysisContent td {
                padding: 6px;
                font-size: 12px;
            }
            
            #aiAnalysisContent blockquote {
                padding: 8px 15px;
                margin: 10px 0;
                font-size: 14px;
            }
        }
        
        /* ì‘ì€ ëª¨ë°”ì¼ (360px ì´í•˜) */
        @media (max-width: 360px) {
            .ai-modal-title {
                font-size: 14px;
            }
            
            .ai-icon {
                font-size: 18px;
            }
            
            .ai-title-text {
                font-size: 14px;
            }
            
            .ai-content {
                padding: 15px 10px;
            }
            
            #aiAnalysisContent h2 {
                font-size: 16px;
            }
            
            #aiAnalysisContent li,
            #aiAnalysisContent p {
                font-size: 13px;
            }
            
            #aiAnalysisContent table {
                font-size: 11px;
            }
            
            #aiAnalysisContent th,
            #aiAnalysisContent td {
                padding: 4px;
                font-size: 11px;
            }
        }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        // ì „ì—­ ë³€ìˆ˜ë¡œ ë¡œê·¸ì¸ ìƒíƒœ ì €ì¥
        let isUserLoggedIn = false;

        // ë¡œê·¸ì¸ ìƒíƒœ ì²´í¬
        async function checkLoginStatus() {
            try {
                const response = await fetch('/api/me');
                const data = await response.json();
                
                const authLink = document.getElementById('authLink');
                
                if (data.logged_in) {
                    isUserLoggedIn = true;
                    authLink.textContent = `ğŸ‘¤ ${data.user.nickname}`;
                    authLink.href = '/mypage';
                    authLink.onclick = null;
                } else {
                    isUserLoggedIn = false;
                    authLink.textContent = 'ë¡œê·¸ì¸';
                    authLink.href = '/login';
                    authLink.onclick = null;
                }
                
                // ë¡œê·¸ì¸ ìƒíƒœì— ë”°ë¼ UI ì—…ë°ì´íŠ¸
                updateUIBasedOnLogin();
            } catch (error) {
                console.error('ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ ì˜¤ë¥˜:', error);
                isUserLoggedIn = false;
                updateUIBasedOnLogin();
            }
        }
        
        // ë¡œê·¸ì¸ ìƒíƒœì— ë”°ë¼ UI ì—…ë°ì´íŠ¸
        function updateUIBasedOnLogin() {
            const portfolioNameInput = document.getElementById('portfolioName');
            const saveBtn = document.getElementById('saveBtn');
            const aiAnalysisBtn = document.getElementById('aiAnalysisBtn');
            
            if (portfolioNameInput && saveBtn) {
                if (!isUserLoggedIn) {
                    portfolioNameInput.disabled = true;
                    portfolioNameInput.placeholder = 'ğŸ”’ ë¡œê·¸ì¸ì´ í•„ìš”í•œ ê¸°ëŠ¥ì…ë‹ˆë‹¤';
                    portfolioNameInput.style.backgroundColor = '#f5f5f5';
                    portfolioNameInput.style.cursor = 'not-allowed';
                    
                    saveBtn.disabled = true;
                    saveBtn.style.opacity = '0.5';
                    saveBtn.style.cursor = 'not-allowed';
                    saveBtn.title = 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤';
                } else {
                    portfolioNameInput.disabled = false;
                    portfolioNameInput.placeholder = 'í¬íŠ¸í´ë¦¬ì˜¤ ì´ë¦„ ì…ë ¥';
                    portfolioNameInput.style.backgroundColor = 'white';
                    portfolioNameInput.style.cursor = 'text';
                    
                    saveBtn.disabled = false;
                    saveBtn.style.opacity = '1';
                    saveBtn.style.cursor = 'pointer';
                    saveBtn.title = '';
                }
            }
            
            if (aiAnalysisBtn) {
                if (!isUserLoggedIn) {
                    aiAnalysisBtn.disabled = true;
                    aiAnalysisBtn.style.opacity = '0.5';
                    aiAnalysisBtn.style.cursor = 'not-allowed';
                    aiAnalysisBtn.title = 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤';
                    aiAnalysisBtn.innerHTML = 'ğŸ¤– AI ë¶„ì„í•˜ê¸° <span style="font-size: 12px; display: block; margin-top: 5px;">ğŸ”’ ë¡œê·¸ì¸ì´ í•„ìš”í•œ ê¸°ëŠ¥ì…ë‹ˆë‹¤</span>';
                } else {
                    aiAnalysisBtn.disabled = false;
                    aiAnalysisBtn.style.opacity = '1';
                    aiAnalysisBtn.style.cursor = 'pointer';
                    aiAnalysisBtn.title = '';
                    aiAnalysisBtn.innerHTML = 'ğŸ¤– AI ë¶„ì„í•˜ê¸°<br><span style="font-size: 12px; opacity: 0.9;">í¬íŠ¸í´ë¦¬ì˜¤ë¥¼ AIê°€ ë¶„ì„í•´ë“œë¦½ë‹ˆë‹¤</span>';
                }
            }
        }
        
        // ë¡œê·¸ì•„ì›ƒ
        async function logout() {
            try {
                const response = await fetch('/api/logout', {
                    method: 'POST'
                });
                
                if (response.ok) {
                    alert('ë¡œê·¸ì•„ì›ƒë˜ì—ˆìŠµë‹ˆë‹¤.');
                    window.location.reload();
                }
            } catch (error) {
                console.error('ë¡œê·¸ì•„ì›ƒ ì˜¤ë¥˜:', error);
                alert('ë¡œê·¸ì•„ì›ƒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ë¡œê·¸ì¸ ìƒíƒœ ì²´í¬
        window.addEventListener('DOMContentLoaded', checkLoginStatus);
        
        const form = document.getElementById('analysisForm');
        const loading = document.getElementById('loading');
        const error = document.getElementById('error');
        const results = document.getElementById('results');
        const analyzeBtn = document.getElementById('analyzeBtn');

        // ë‚ ì§œ ê¸°ë³¸ê°’ ì„¤ì • (ì˜¤ëŠ˜ ë‚ ì§œì™€ 3ë…„ ì „ 1ì›” 1ì¼)
        const today = new Date();
        const threeYearsAgo = new Date(today.getFullYear() - 3, 0, 1); // 0 = January, 1 = 1ì¼
        const minDate = new Date(2000, 0, 1); // 2000ë…„ 1ì›” 1ì¼
        
        // ë¡œì»¬ ë‚ ì§œë¥¼ YYYY-MM-DD í˜•ì‹ìœ¼ë¡œ ë³€í™˜ (UTC ë¬¸ì œ ë°©ì§€)
        function formatLocalDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        console.log('Today:', formatLocalDate(today));
        console.log('Three years ago (Jan 1):', formatLocalDate(threeYearsAgo));
        
        document.getElementById('startDate').min = formatLocalDate(minDate);
        document.getElementById('startDate').max = formatLocalDate(today);
        document.getElementById('startDate').value = formatLocalDate(threeYearsAgo);
        
        // ê¸°ë³¸ ë²¤ì¹˜ë§ˆí¬ ì„¤ì •
        document.getElementById('benchmarkTicker').value = 'SPY';

        // ë²¤ì¹˜ë§ˆí¬ ì„ íƒ ë³€ê²½ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        document.getElementById('benchmarkTicker').addEventListener('change', function() {
            const customBenchmarkGroup = document.getElementById('customBenchmarkGroup');
            const customBenchmarkTicker = document.getElementById('customBenchmarkTicker');
            
            if (this.value === 'CUSTOM') {
                customBenchmarkGroup.style.display = 'block';
                customBenchmarkTicker.required = true;
            } else {
                customBenchmarkGroup.style.display = 'none';
                customBenchmarkTicker.required = false;
                customBenchmarkTicker.value = ''; // ê°’ ì´ˆê¸°í™”
            }
        });

        // ì…ë ¥ ëª¨ë“œ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        document.getElementById('csvModeBtn').addEventListener('click', function() {
            switchInputMode('csv');
        });
        document.getElementById('manualModeBtn').addEventListener('click', function() {
            switchInputMode('manual');
        });

        // CSV íŒŒì¼ ì„ íƒ ì‹œ ìë™ íŒŒì‹±
        document.getElementById('csvFile').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file) return;

            console.log('ğŸ“ CSV file selected:', file.name);
            
            // ë¡œë”© í‘œì‹œ
            const csvSection = document.getElementById('csvUploadSection');
            const helperText = csvSection.querySelector('.helper-text');
            const originalHelperText = helperText.innerHTML;
            helperText.innerHTML = '<span style="color: #667eea;">â³ CSV íŒŒì¼ì„ ë¶„ì„í•˜ëŠ” ì¤‘...</span>';

            try {
                const formData = new FormData();
                formData.append('csv_file', file);

                const response = await fetch('/parse-csv', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'CSV íŒŒì¼ íŒŒì‹± ì‹¤íŒ¨');
                }

                console.log('âœ… CSV parsed successfully:', data);

                // ìˆ˜ë™ ì…ë ¥ ëª¨ë“œë¡œ ì „í™˜
                switchInputMode('manual');

                // ê¸°ì¡´ í–‰ ëª¨ë‘ ì‚­ì œ
                const tbody = document.getElementById('manualInputTableBody');
                tbody.innerHTML = '';

                // CSV ë°ì´í„°ë¡œ í–‰ ì±„ìš°ê¸°
                data.portfolio.forEach(item => {
                    const newRow = document.createElement('tr');
                    newRow.className = 'input-row';
                    newRow.innerHTML = `
                        <td><input type="text" class="ticker-input" placeholder="ì˜ˆ: AAPL" value="${item.ticker}"></td>
                        <td><input type="number" class="quantity-input" placeholder="ë³´ìœ  ì£¼ì‹ ìˆ˜ (ì˜ˆ: 10)" min="0" step="1" value="${item.quantity}"></td>
                        <td>
                            <select class="country-input">
                                <option value="ë¯¸êµ­" ${item.country === 'ë¯¸êµ­' ? 'selected' : ''}>ë¯¸êµ­</option>
                                <option value="í•œêµ­" ${item.country === 'í•œêµ­' ? 'selected' : ''}>í•œêµ­</option>
                            </select>
                        </td>
                        <td><button type="button" class="delete-row-btn" onclick="deleteRow(this)">ì‚­ì œ</button></td>
                    `;
                    tbody.appendChild(newRow);
                });

                // ìµœì†Œ 1ê°œ í–‰ ë³´ì¥
                if (tbody.children.length === 0) {
                    addRow();
                }

                // í˜„ê¸ˆ ë°ì´í„° ì±„ìš°ê¸°
                if (data.cash) {
                    document.getElementById('cashKRW').value = data.cash.KRW || 0;
                    document.getElementById('cashUSD').value = data.cash.USD || 0;
                }

                // ì„±ê³µ ë©”ì‹œì§€
                helperText.innerHTML = '<span style="color: #22c55e;">âœ… CSV íŒŒì¼ì´ ì„±ê³µì ìœ¼ë¡œ ë¶ˆëŸ¬ì™€ì¡ŒìŠµë‹ˆë‹¤!</span>';
                setTimeout(() => {
                    helperText.innerHTML = originalHelperText;
                }, 3000);

                // íŒŒì¼ ì…ë ¥ ì´ˆê¸°í™”
                e.target.value = '';

            } catch (error) {
                console.error('âŒ Error parsing CSV:', error);
                helperText.innerHTML = `<span style="color: #ef4444;">âŒ ${error.message}</span>`;
                setTimeout(() => {
                    helperText.innerHTML = originalHelperText;
                }, 5000);
            }
        });

        // ì…ë ¥ ëª¨ë“œ ì „ì—­ ë³€ìˆ˜ (ê¸°ë³¸ê°’: manual, í•­ìƒ manual ëª¨ë“œ ì‚¬ìš©)
        let currentInputMode = 'manual';

        // ì…ë ¥ ëª¨ë“œ ì „í™˜ (CSV ëª¨ë“œëŠ” íŒŒì¼ ì„ íƒ íŠ¸ë¦¬ê±°ë¡œë§Œ ì‚¬ìš©)
        function switchInputMode(mode) {
            console.log('Switching to mode:', mode);
            
            if (mode === 'csv') {
                // CSV ë²„íŠ¼ í´ë¦­ ì‹œ íŒŒì¼ ì„ íƒ ë‹¤ì´ì–¼ë¡œê·¸ ì—´ê¸°
                document.getElementById('csvFile').click();
                // í•­ìƒ manual ëª¨ë“œ ìœ ì§€
                currentInputMode = 'manual';
            } else {
                currentInputMode = 'manual';
            }
            
            // í•­ìƒ manual ì„¹ì…˜ë§Œ í‘œì‹œ
            document.getElementById('csvUploadSection').style.display = 'none';
            document.getElementById('manualInputSection').style.display = 'block';
            document.getElementById('csvFile').required = false;
            
            // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
            document.getElementById('manualModeBtn').classList.add('active');
            document.getElementById('csvModeBtn').classList.remove('active');
        }

        // í–‰ ì¶”ê°€
        function addRow() {
            const tbody = document.getElementById('manualInputTableBody');
            const newRow = document.createElement('tr');
            newRow.className = 'input-row';
            newRow.innerHTML = `
                <td><input type="text" class="ticker-input" placeholder="ì˜ˆ: AAPL"></td>
                <td><input type="number" class="quantity-input" placeholder="ë³´ìœ  ì£¼ì‹ ìˆ˜ (ì˜ˆ: 10)" min="0" step="1"></td>
                <td>
                    <select class="country-input">
                        <option value="ë¯¸êµ­">ë¯¸êµ­</option>
                        <option value="í•œêµ­">í•œêµ­</option>
                    </select>
                </td>
                <td><button type="button" class="delete-row-btn" onclick="deleteRow(this)">ì‚­ì œ</button></td>
            `;
            tbody.appendChild(newRow);
        }

        // í–‰ ì‚­ì œ
        function deleteRow(button) {
            const tbody = document.getElementById('manualInputTableBody');
            const rows = tbody.getElementsByClassName('input-row');
            
            // ìµœì†Œ 1ê°œ í–‰ì€ ìœ ì§€
            if (rows.length > 1) {
                button.closest('tr').remove();
            } else {
                alert('ìµœì†Œ 1ê°œì˜ ì¢…ëª©ì€ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.');
            }
        }

        // ì ë¦½ì‹ íˆ¬ì í–‰ ì¶”ê°€
        function addDcaRow() {
            const dcaSection = document.getElementById('dcaSection');
            const tbody = document.getElementById('dcaInputTableBody');
            
            // ì„¹ì…˜ì´ ìˆ¨ê²¨ì ¸ ìˆìœ¼ë©´ í‘œì‹œ
            if (dcaSection.style.display === 'none') {
                dcaSection.style.display = 'block';
            }
            
            const newRow = document.createElement('tr');
            newRow.className = 'dca-row';
            newRow.innerHTML = `
                <td><input type="text" class="dca-ticker-input" placeholder="ì˜ˆ: AAPL"></td>
                <td><input type="number" class="dca-quantity-input" placeholder="ë§¤ ì£¼ê¸°ë§ˆë‹¤ ì¶”ê°€í•  ìˆ˜ëŸ‰" min="0.01" step="0.01"></td>
                <td>
                    <select class="dca-country-input">
                        <option value="ë¯¸êµ­">ë¯¸êµ­</option>
                        <option value="í•œêµ­">í•œêµ­</option>
                    </select>
                </td>
                <td>
                    <select class="dca-frequency-input">
                        <option value="weekly">ë§¤ì£¼</option>
                        <option value="monthly">ë§¤ì›”</option>
                        <option value="quarterly">ë§¤ë¶„ê¸°</option>
                    </select>
                </td>
                <td><button type="button" class="delete-row-btn" onclick="deleteDcaRow(this)">ì‚­ì œ</button></td>
            `;
            tbody.appendChild(newRow);
        }

        // ì ë¦½ì‹ íˆ¬ì í–‰ ì‚­ì œ
        function deleteDcaRow(button) {
            const tbody = document.getElementById('dcaInputTableBody');
            const dcaSection = document.getElementById('dcaSection');
            
            button.closest('tr').remove();
            
            // ëª¨ë“  í–‰ì´ ì‚­ì œë˜ë©´ ì„¹ì…˜ ìˆ¨ê¸°ê¸°
            const rows = tbody.getElementsByClassName('dca-row');
            if (rows.length === 0) {
                dcaSection.style.display = 'none';
            }
        }

        // ìˆ˜ë™ ì…ë ¥ ë°ì´í„°ë¥¼ CSV í˜•ì‹ìœ¼ë¡œ ë³€í™˜
        function convertManualInputToCSV() {
            const rows = document.querySelectorAll('#manualInputTableBody .input-row');
            const csvLines = ['í‹°ì»¤,ë³´ìœ ëŸ‰,êµ­ê°€,ë¶„ë¥˜'];

            let hasData = false;
            rows.forEach(row => {
                const ticker = row.querySelector('.ticker-input').value.trim();
                const quantity = row.querySelector('.quantity-input').value.trim();
                const country = row.querySelector('.country-input').value;

                if (ticker && quantity) {
                    hasData = true;
                    const assetClass = 'ì£¼ì‹';  // ëª¨ë“  í–‰ì€ ì£¼ì‹ìœ¼ë¡œ ì²˜ë¦¬
                    csvLines.push(`${ticker},${quantity},${country},${assetClass}`);
                }
            });

            // í˜„ê¸ˆ ì¶”ê°€
            const cashKRW = parseFloat(document.getElementById('cashKRW').value) || 0;
            const cashUSD = parseFloat(document.getElementById('cashUSD').value) || 0;

            if (cashKRW > 0) {
                hasData = true;
                csvLines.push(`KRW,${cashKRW},í•œêµ­,í˜„ê¸ˆ`);
            }

            if (cashUSD > 0) {
                hasData = true;
                csvLines.push(`USD,${cashUSD},ë¯¸êµ­,í˜„ê¸ˆ`);
            }

            if (!hasData) {
                return null;
            }

            return csvLines.join('\n');
        }

        // ìºì‹œ í†µê³„ ë¡œë“œ
        async function loadCacheStats() {
            try {
                const response = await fetch('/api/cache-stats');
                if (response.ok) {
                    const data = await response.json();
                    const statsElement = document.getElementById('cacheStats');
                    statsElement.textContent = `${data.ticker_count}ê°œ ì¢…ëª©, ${data.record_count.toLocaleString()}ê°œ ë ˆì½”ë“œ`;
                } else {
                    document.getElementById('cacheStats').textContent = 'í†µê³„ ë¡œë“œ ì‹¤íŒ¨';
                }
            } catch (err) {
                console.error('ìºì‹œ í†µê³„ ë¡œë“œ ì˜¤ë¥˜:', err);
                document.getElementById('cacheStats').textContent = 'í†µê³„ ë¡œë“œ ì‹¤íŒ¨';
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ìºì‹œ í†µê³„ ê°€ì ¸ì˜¤ê¸°
        loadCacheStats();

        // ì €ì¥ëœ í¬íŠ¸í´ë¦¬ì˜¤ ë³´ê¸° ì²˜ë¦¬
        window.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            console.log('URL params:', urlParams.toString());
            console.log('view param:', urlParams.get('view'));
            
            if (urlParams.get('view') === 'portfolio') {
                const portfolioData = sessionStorage.getItem('portfolioData');
                console.log('SessionStorage data:', portfolioData);
                
                if (portfolioData) {
                    try {
                        const data = JSON.parse(portfolioData);
                        console.log('Parsed data:', data);
                        
                        // í¼ ì„¹ì…˜ ìˆ¨ê¸°ê¸°
                        const formCard = document.getElementById('analysisFormCard');
                        if (formCard) {
                            formCard.style.display = 'none';
                        }
                        
                        // í¬íŠ¸í´ë¦¬ì˜¤ ì´ë¦„ ë° ì†Œìœ ì í‘œì‹œ
                        const portfolioNameSection = document.getElementById('portfolioNameSection');
                        const portfolioNameDisplay = document.getElementById('portfolioNameDisplay');
                        const portfolioOwnerDisplay = document.getElementById('portfolioOwnerDisplay');
                        const privacyNotice = document.getElementById('privacyNotice');
                        
                        if (portfolioNameSection && portfolioNameDisplay) {
                            portfolioNameDisplay.textContent = data.name;
                            if (portfolioOwnerDisplay && data.owner_nickname) {
                                portfolioOwnerDisplay.textContent = data.owner_nickname;
                            } else if (portfolioOwnerDisplay) {
                                portfolioOwnerDisplay.textContent = 'ìµëª…';
                            }
                            
                            // í”„ë¼ì´ë²„ì‹œ ì•Œë¦¼ ì„¤ì •
                            if (privacyNotice) {
                                if (data.is_owner) {
                                    // ì†Œìœ ìì¸ ê²½ìš°
                                    privacyNotice.style.background = '#d1ecf1';
                                    privacyNotice.style.color = '#0c5460';
                                    privacyNotice.innerHTML = 'âœ… <strong>ë‚´ í¬íŠ¸í´ë¦¬ì˜¤:</strong> ëª¨ë“  ì •ë³´ê°€ í‘œì‹œë©ë‹ˆë‹¤.';
                                } else {
                                    // ë‹¤ë¥¸ ì‚¬ìš©ìì˜ í¬íŠ¸í´ë¦¬ì˜¤ì¸ ê²½ìš°
                                    privacyNotice.style.background = '#fff3cd';
                                    privacyNotice.style.color = '#856404';
                                    privacyNotice.innerHTML = 'â„¹ï¸ <strong>ì•Œë¦¼:</strong> ë‹¤ë¥¸ ì‚¬ìš©ìì˜ í¬íŠ¸í´ë¦¬ì˜¤ë¥¼ ì¡°íšŒí•  ë•ŒëŠ” í”„ë¼ì´ë²„ì‹œ ë³´í˜¸ë¥¼ ìœ„í•´ ìì‚° ê°€ì¹˜ê°€ í‘œì‹œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
                                }
                            }
                            
                            portfolioNameSection.style.display = 'block';
                        }
                        
                        // ê²°ê³¼ í‘œì‹œ - dataì—ì„œ ì§ì ‘ í•„ìš”í•œ í•„ë“œ ì¶”ì¶œ
                        // is_ownerê°€ trueë©´ ì •ìƒ í‘œì‹œ, falseë©´ í”„ë¼ì´ë²„ì‹œ ëª¨ë“œ
                        displayResults({
                            metrics: data.metrics,
                            summary: data.summary,
                            holdings_table: data.holdings_table,
                            allocation_data: data.allocation_data,
                            chart_data: data.chart_data
                        }, !data.is_owner); // true = í”„ë¼ì´ë²„ì‹œ ëª¨ë“œ (ë‹¤ë¥¸ ì‚¬ìš©ì), false = ì •ìƒ í‘œì‹œ (ì†Œìœ ì)
                        
                        // ê²°ê³¼ ì„¹ì…˜ í‘œì‹œ
                        const results = document.getElementById('results');
                        if (results) {
                            results.style.display = 'block';
                        }
                        
                        // sessionStorage ì •ë¦¬
                        sessionStorage.removeItem('portfolioData');
                        
                        // URLì—ì„œ view íŒŒë¼ë¯¸í„° ì œê±° (ë¸Œë¼ìš°ì € íˆìŠ¤í† ë¦¬ ìœ ì§€)
                        window.history.replaceState({}, document.title, window.location.pathname);
                        
                    } catch (err) {
                        console.error('í¬íŠ¸í´ë¦¬ì˜¤ ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', err);
                        console.error('Error stack:', err.stack);
                        alert('í¬íŠ¸í´ë¦¬ì˜¤ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                    }
                } else {
                    console.log('No portfolio data in sessionStorage');
                }
            }
        });

        let chart = null;
        let initialAllocationChart = null;
        let currentAllocationChart = null;
        
        // ë¶„ì„ ê²°ê³¼ë¥¼ ì €ì¥í•˜ê¸° ìœ„í•œ ì „ì—­ ë³€ìˆ˜
        let currentAnalysisData = null;

        // ë³´ìœ  ì¢…ëª© ë°ì´í„° ë° ì •ë ¬ ìƒíƒœ
        let currentHoldings = [];
        let currentCurrency = 'USD';
        let isDetailView = false;
        let currentSortColumn = null;
        let currentSortDirection = 'asc';

        // ì •ë ¬ í•¨ìˆ˜
        function sortHoldings(column) {
            // ê°™ì€ ì»¬ëŸ¼ì„ í´ë¦­í•˜ë©´ ë°©í–¥ ì „í™˜, ë‹¤ë¥¸ ì»¬ëŸ¼ì´ë©´ ì˜¤ë¦„ì°¨ìˆœìœ¼ë¡œ ì‹œì‘
            if (currentSortColumn === column) {
                currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortColumn = column;
                currentSortDirection = 'asc';
            }

            // ì •ë ¬
            const sorted = [...currentHoldings].sort((a, b) => {
                if (column === 'ticker') {
                    // í˜„ê¸ˆì€ í•­ìƒ ë§¨ ì•„ë˜
                    const aIsCash = a.asset_class === 'í˜„ê¸ˆ';
                    const bIsCash = b.asset_class === 'í˜„ê¸ˆ';
                    
                    if (aIsCash && !bIsCash) return 1;
                    if (!aIsCash && bIsCash) return -1;
                    
                    // ë‘˜ ë‹¤ í˜„ê¸ˆì´ê±°ë‚˜ ë‘˜ ë‹¤ ì¼ë°˜ ìì‚°ì¸ ê²½ìš° í‹°ì»¤ë¡œ ë¹„êµ
                    const comparison = a.ticker.localeCompare(b.ticker);
                    return currentSortDirection === 'asc' ? comparison : -comparison;
                } else if (column === 'weight') {
                    const comparison = a.weight - b.weight;
                    return currentSortDirection === 'asc' ? comparison : -comparison;
                }
                return 0;
            });

            // í…Œì´ë¸” ë‹¤ì‹œ ë Œë”ë§
            renderHoldingsTable(sorted, currentCurrency, isDetailView);

            // í—¤ë” ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
            updateSortHeaders();
        }

        // ì •ë ¬ í—¤ë” ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
        function updateSortHeaders() {
            // ëª¨ë“  í—¤ë”ì—ì„œ ì •ë ¬ í´ë˜ìŠ¤ ì œê±°
            document.querySelectorAll('.sortable-header').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
            });

            // í˜„ì¬ ì •ë ¬ ì»¬ëŸ¼ì— í´ë˜ìŠ¤ ì¶”ê°€
            if (currentSortColumn === 'ticker') {
                const tickerHeader = document.querySelector('.sortable-header[onclick*="ticker"]');
                if (tickerHeader) {
                    tickerHeader.classList.add(currentSortDirection === 'asc' ? 'sort-asc' : 'sort-desc');
                }
            } else if (currentSortColumn === 'weight') {
                const weightHeader = document.querySelector('.sortable-header[onclick*="weight"]');
                if (weightHeader) {
                    weightHeader.classList.add(currentSortDirection === 'asc' ? 'sort-asc' : 'sort-desc');
                }
            }
        }

        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            // í•­ìƒ ìˆ˜ë™ ì…ë ¥ ëª¨ë“œë¡œ ì²˜ë¦¬ (CSVëŠ” ì´ë¯¸ íŒŒì‹±ë˜ì–´ í¼ì— ì±„ì›Œì ¸ ìˆìŒ)
            let csvContent = null;
            let fileToUpload = null;

            // ìˆ˜ë™ ì…ë ¥ ëª¨ë“œ: CSV ìƒì„±
            csvContent = convertManualInputToCSV();
            if (!csvContent) {
                alert('ìµœì†Œ 1ê°œì˜ ì¢…ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            console.log('ğŸ“ Manual input CSV:', csvContent);
            
            // CSVë¥¼ Blobìœ¼ë¡œ ë³€í™˜í•˜ì—¬ íŒŒì¼ì²˜ëŸ¼ ì²˜ë¦¬
            const blob = new Blob([csvContent], { type: 'text/csv' });
            fileToUpload = new File([blob], 'manual_input.csv', { type: 'text/csv' });

            // UI ì´ˆê¸°í™”
            error.style.display = 'none';
            error.style.backgroundColor = ''; // ë°°ê²½ìƒ‰ ì´ˆê¸°í™”
            error.style.color = ''; // ê¸€ììƒ‰ ì´ˆê¸°í™”
            error.style.borderLeft = ''; // í…Œë‘ë¦¬ ì´ˆê¸°í™”
            results.style.display = 'none';
            loading.style.display = 'block';
            analyzeBtn.disabled = true;
            
            // AI ë¶„ì„ ìºì‹œ ì´ˆê¸°í™” (ìƒˆë¡œìš´ ë¶„ì„ ì‹œì‘)
            aiAnalysisResultCache = null;

            const formData = new FormData();
            formData.append('csv_file', fileToUpload);
            formData.append('start_date', document.getElementById('startDate').value);
            
            // ë²¤ì¹˜ë§ˆí¬ ì²˜ë¦¬
            const benchmarkSelect = document.getElementById('benchmarkTicker').value;
            if (benchmarkSelect === 'CUSTOM') {
                const customTicker = document.getElementById('customBenchmarkTicker').value.trim();
                if (!customTicker) {
                    alert('ë²¤ì¹˜ë§ˆí¬ í‹°ì»¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    loading.style.display = 'none';
                    analyzeBtn.disabled = false;
                    return;
                }
                formData.append('benchmark_ticker', customTicker);
            } else {
                formData.append('benchmark_ticker', benchmarkSelect);
            }
            
            formData.append('base_currency', document.getElementById('baseCurrency').value);
            
            // ì ë¦½ì‹ íˆ¬ì ë°ì´í„° ì¶”ê°€
            const dcaRows = document.querySelectorAll('#dcaInputTableBody .dca-row');
            const dcaData = [];
            dcaRows.forEach(row => {
                const ticker = row.querySelector('.dca-ticker-input').value.trim();
                const quantity = row.querySelector('.dca-quantity-input').value.trim();
                const country = row.querySelector('.dca-country-input').value;
                const frequency = row.querySelector('.dca-frequency-input').value;
                
                if (ticker && quantity) {
                    dcaData.push({
                        ticker: ticker,
                        quantity: parseFloat(quantity),
                        country: country,
                        frequency: frequency
                    });
                }
            });
            
            if (dcaData.length > 0) {
                formData.append('dca_data', JSON.stringify(dcaData));
                console.log('ğŸ“ˆ DCA data:', dcaData);
            }
            
            // FormData ë‚´ìš© í™•ì¸ (ë””ë²„ê¹…ìš©)
            console.log('ğŸ“¤ Sending data:');
            for (let [key, value] of formData.entries()) {
                if (value instanceof File) {
                    console.log(`  ${key}: ${value.name} (${value.size} bytes)`);
                } else {
                    console.log(`  ${key}: ${value}`);
                }
            }

            try {
                const response = await fetch('/analyze', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }

                console.log('âœ… Analysis completed successfully');
                
                // ê²½ê³  ë©”ì‹œì§€ í‘œì‹œ (ì¼ë¶€ í‹°ì»¤ ì‹¤íŒ¨)
                if (data.warning) {
                    const warningDiv = document.getElementById('error');
                    warningDiv.textContent = data.warning;
                    warningDiv.style.display = 'block';
                    warningDiv.style.backgroundColor = '#fff3cd';
                    warningDiv.style.color = '#856404';
                    warningDiv.style.borderLeft = '4px solid #ffc107';
                }
                
                // ë¶„ì„ ê²°ê³¼ ì €ì¥ (ì €ì¥ ë²„íŠ¼ìš©)
                // DCAê°€ ì ìš©ëœ ìµœì¢… í¬íŠ¸í´ë¦¬ì˜¤ CSV ì‚¬ìš©
                let csvContentForSave;
                if (data.final_portfolio_csv) {
                    // ë°±ì—”ë“œì—ì„œ DCAê°€ ì ìš©ëœ ìµœì¢… í¬íŠ¸í´ë¦¬ì˜¤ë¥¼ ë°›ìŒ
                    csvContentForSave = data.final_portfolio_csv;
                    console.log('ğŸ“Š Using final portfolio CSV (with DCA applied)');
                } else {
                    // í•­ìƒ ìˆ˜ë™ ì…ë ¥ì—ì„œ ìƒì„±ëœ CSV ì‚¬ìš©
                    csvContentForSave = csvContent;
                }

                currentAnalysisData = {
                    csv_content: csvContentForSave,
                    start_date: document.getElementById('startDate').value,
                    benchmark_ticker: document.getElementById('benchmarkTicker').value,
                    base_currency: document.getElementById('baseCurrency').value,
                    ...data
                };
                
                displayResults(data);
                results.style.display = 'block';
                
                // ì €ì¥ ì„¹ì…˜ í‘œì‹œ
                document.getElementById('saveSection').style.display = 'block';
                document.getElementById('saveMessage').style.display = 'none';
                
                // AI ë¶„ì„ ë²„íŠ¼ í‘œì‹œ
                document.getElementById('aiAnalysisSection').style.display = 'block';
                
                // ë¡œê·¸ì¸ ìƒíƒœì— ë”°ë¼ UI ì—…ë°ì´íŠ¸
                updateUIBasedOnLogin();
                
                // í•­ìƒ CSV ë‚´ë³´ë‚´ê¸° ë²„íŠ¼ í‘œì‹œ (ìˆ˜ë™ ì…ë ¥ ëª¨ë“œ)
                document.getElementById('exportSection').style.display = 'block';

            } catch (err) {
                console.error('âŒ Error:', err);
                error.textContent = err.message;
                error.style.display = 'block';
            } finally {
                loading.style.display = 'none';
                analyzeBtn.disabled = false;
                // ë¶„ì„ í›„ ìºì‹œ í†µê³„ ì—…ë°ì´íŠ¸
                loadCacheStats();
            }
        });

        function displayResults(data, isDetailViewMode = false) {
            const { metrics, chart_data, summary, allocation_data, holdings_table } = data;

            // ì „ì—­ ë³€ìˆ˜ì— ì €ì¥
            currentHoldings = holdings_table;
            currentCurrency = summary.base_currency;
            isDetailView = isDetailViewMode;
            currentSortColumn = null; // ì •ë ¬ ìƒíƒœ ì´ˆê¸°í™”
            currentSortDirection = 'asc';

            // í†µí™” ì‹¬ë³¼ ê²°ì •
            const currencySymbol = summary.base_currency === 'USD' ? '$' : 'â‚©';
            const currencyName = summary.base_currency === 'USD' ? 'USD' : 'KRW';

            // ìì‚° ê°€ì¹˜ í‘œì‹œ í•¨ìˆ˜ (ìƒì„¸ ë·°ì—ì„œëŠ” ìˆ¨ê¹€)
            const formatValue = (value) => {
                return isDetailViewMode ? '-' : formatCurrency(value, summary.base_currency);
            };

            // ìš”ì•½ ì •ë³´ í‘œì‹œ
            const summaryGrid = document.getElementById('summaryGrid');
            summaryGrid.innerHTML = `
                <div class="summary-item">
                    <div class="summary-label">ë³´ìœ  ì¢…ëª© ìˆ˜</div>
                    <div class="summary-value">${summary.num_holdings}</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">ê¸°ì¤€ í†µí™”</div>
                    <div class="summary-value">${currencyName}</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">USD/KRW í™˜ìœ¨</div>
                    <div class="summary-value">${summary.exchange_rate.toLocaleString()}</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">ì‹œì‘ ê°€ì¹˜ (íˆ¬ììì‚°)</div>
                    <div class="summary-value">${formatValue(summary.initial_value)}</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">í˜„ì¬ ê°€ì¹˜ (íˆ¬ììì‚°)</div>
                    <div class="summary-value">${formatValue(summary.current_value)}</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">í˜„ê¸ˆ ë³´ìœ ì•¡</div>
                    <div class="summary-value">${formatValue(summary.total_cash)}</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">ì´ ìì‚° (í˜„ê¸ˆí¬í•¨)</div>
                    <div class="summary-value">${formatValue(summary.current_value_with_cash)}</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">ìˆ˜ìµë¥  (íˆ¬ììì‚°)</div>
                    <div class="summary-value ${summary.total_return >= 0 ? 'positive' : 'negative'}">
                        ${summary.total_return >= 0 ? '+' : ''}${summary.total_return}%
                    </div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">ìˆ˜ìµë¥  (í˜„ê¸ˆí¬í•¨)</div>
                    <div class="summary-value ${summary.total_return_with_cash >= 0 ? 'positive' : 'negative'}">
                        ${summary.total_return_with_cash >= 0 ? '+' : ''}${summary.total_return_with_cash}%
                    </div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">ì—°í‰ê·  ìˆ˜ìµë¥  (CAGR)</div>
                    <div class="summary-value ${metrics.cagr >= 0 ? 'positive' : 'negative'}">
                        ${metrics.cagr >= 0 ? '+' : ''}${metrics.cagr}%
                    </div>
                </div>
            `;
            
            // ë„ë„› ì°¨íŠ¸ ìƒì„±
            createAllocationCharts(allocation_data, summary.base_currency);
            
            // ë³´ìœ  ì¢…ëª© í…Œì´ë¸” ë Œë”ë§ (ìƒì„¸ ë·°ì—ì„œëŠ” í‰ê°€ì•¡ ìˆ¨ê¹€)
            renderHoldingsTable(holdings_table, summary.base_currency, isDetailViewMode);
            
            // ì •ë ¬ í—¤ë” ì´ˆê¸°í™”
            updateSortHeaders();

            // ê·¸ë¼ë°ì´ì…˜ ìƒ‰ìƒ ê³„ì‚° í•¨ìˆ˜
            function getGradientColor(value, benchmarkValue, isBetter) {
                // valueê°€ benchmarkë³´ë‹¤ ì¢‹ì„ìˆ˜ë¡ ì´ˆë¡, ë‚˜ì ìˆ˜ë¡ ë¹¨ê°•
                // isBetter: 'higher' (ë†’ì„ìˆ˜ë¡ ì¢‹ìŒ) ë˜ëŠ” 'lower' (ë‚®ì„ìˆ˜ë¡ ì¢‹ìŒ)
                let diff = 0;
                if (isBetter === 'higher') {
                    diff = value - benchmarkValue;
                } else {
                    diff = benchmarkValue - value;
                }
                
                // ì°¨ì´ë¥¼ í¼ì„¼íŠ¸ë¡œ ë³€í™˜ (ë²¤ì¹˜ë§ˆí¬ ëŒ€ë¹„)
                const percentDiff = benchmarkValue !== 0 ? (diff / Math.abs(benchmarkValue)) * 100 : diff * 100;
                
                // -50% ~ +50% ë²”ìœ„ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ìƒ‰ìƒ ê°•ë„ ê³„ì‚°
                const intensity = Math.max(-1, Math.min(1, percentDiff / 50));
                
                if (Math.abs(intensity) < 0.05) {
                    // ê±°ì˜ ê°™ìœ¼ë©´ ë§¤ìš° ì—°í•œ íšŒìƒ‰
                    return 'rgb(245, 245, 245)';
                } else if (intensity > 0) {
                    // ì´ˆë¡ìƒ‰ (ì¢‹ìŒ) - ì—°í•œ ì´ˆë¡ -> ì§„í•œ ì´ˆë¡
                    const alpha = Math.abs(intensity);
                    const r = Math.floor(200 - alpha * 100); // 200 -> 100
                    const g = Math.floor(230 - alpha * 50);  // 230 -> 180
                    const b = Math.floor(200 - alpha * 100); // 200 -> 100
                    return `rgb(${r}, ${g}, ${b})`;
                } else {
                    // ë¹¨ê°„ìƒ‰ (ë‚˜ì¨) - ì—°í•œ ë¹¨ê°• -> ì§„í•œ ë¹¨ê°•
                    const alpha = Math.abs(intensity);
                    const r = Math.floor(230 - alpha * 50);  // 230 -> 180
                    const g = Math.floor(200 - alpha * 100); // 200 -> 100
                    const b = Math.floor(200 - alpha * 100); // 200 -> 100
                    return `rgb(${r}, ${g}, ${b})`;
                }
            }

            // ë°°ê²½ìƒ‰ì— ë”°ë¥¸ í…ìŠ¤íŠ¸ ìƒ‰ìƒ ê²°ì • í•¨ìˆ˜
            function getTextColor(value, benchmarkValue, isBetter) {
                // ëª¨ë“  í…ìŠ¤íŠ¸ë¥¼ ì–´ë‘ìš´ íšŒìƒ‰ìœ¼ë¡œ í†µì¼
                return '#333';
            }

            // ì„±ê³¼ ì§€í‘œ í‘œì‹œ
            const metricsGrid = document.getElementById('metricsGrid');
            metricsGrid.innerHTML = `
                <div class="metric-card" style="background: ${getGradientColor(metrics.sharpe_ratio, metrics.benchmark_sharpe_ratio, 'higher')};">
                    <div class="metric-label">ìƒ¤í”„ ë¹„ìœ¨ (Sharpe Ratio)</div>
                    <div class="metric-value" style="color: #333;">${metrics.sharpe_ratio}</div>
                    <div class="metric-description" style="font-size: 11px; color: #444;">
                        ë²¤ì¹˜ë§ˆí¬: ${metrics.benchmark_sharpe_ratio}<br>
                        ìœ„í—˜ ëŒ€ë¹„ ìˆ˜ìµë¥ . ë†’ì„ìˆ˜ë¡ ì¢‹ìŒ
                    </div>
                </div>
                <div class="metric-card" style="background: ${getGradientColor(metrics.sortino_ratio, metrics.benchmark_sortino_ratio, 'higher')};">
                    <div class="metric-label">ì†Œí‹°ë…¸ ë¹„ìœ¨ (Sortino Ratio)</div>
                    <div class="metric-value" style="color: #333;">${metrics.sortino_ratio}</div>
                    <div class="metric-description" style="font-size: 11px; color: #444;">
                        ë²¤ì¹˜ë§ˆí¬: ${metrics.benchmark_sortino_ratio}<br>
                        í•˜ë°© ìœ„í—˜ ëŒ€ë¹„ ìˆ˜ìµë¥ . ë†’ì„ìˆ˜ë¡ ì¢‹ìŒ
                    </div>
                </div>
                <div class="metric-card" style="background: ${getGradientColor(metrics.alpha, 0, 'higher')};">
                    <div class="metric-label">ì•ŒíŒŒ (Alpha)</div>
                    <div class="metric-value" style="color: ${getTextColor(metrics.alpha, 0, 'higher')};">
                        ${metrics.alpha >= 0 ? '+' : ''}${metrics.alpha}%
                    </div>
                    <div class="metric-description" style="font-size: 11px; color: #444;">
                        ë²¤ì¹˜ë§ˆí¬: 0%<br>
                        ë²¤ì¹˜ë§ˆí¬ ëŒ€ë¹„ ì´ˆê³¼ ìˆ˜ìµë¥ 
                    </div>
                </div>
                <div class="metric-card" style="background: ${getGradientColor(Math.abs(metrics.beta - 1), 0, 'lower')};">
                    <div class="metric-label">ë² íƒ€ (Beta)</div>
                    <div class="metric-value" style="color: #333;">${metrics.beta}</div>
                    <div class="metric-description" style="font-size: 11px; color: #444;">
                        ë²¤ì¹˜ë§ˆí¬: 1.0<br>
                        ì‹œì¥ ë¯¼ê°ë„. 1.0 = ì‹œì¥ê³¼ ë™ì¼
                    </div>
                </div>
                <div class="metric-card" style="background: ${getGradientColor(metrics.cagr, metrics.benchmark_annual_return, 'higher')};">
                    <div class="metric-label">ì—°í‰ê·  ìˆ˜ìµë¥  (CAGR)</div>
                    <div class="metric-value" style="color: ${getTextColor(metrics.cagr, metrics.benchmark_annual_return, 'higher')};">
                        ${metrics.cagr >= 0 ? '+' : ''}${metrics.cagr}%
                    </div>
                    <div class="metric-description" style="font-size: 11px; color: #444;">
                        ë²¤ì¹˜ë§ˆí¬: ${metrics.benchmark_annual_return >= 0 ? '+' : ''}${metrics.benchmark_annual_return}%<br>
                        ì—°ê°„ ë³µë¦¬ ìˆ˜ìµë¥ 
                    </div>
                </div>
                <div class="metric-card" style="background: ${getGradientColor(metrics.volatility, metrics.benchmark_volatility, 'lower')};">
                    <div class="metric-label">ë³€ë™ì„± (Volatility)</div>
                    <div class="metric-value" style="color: #333;">${metrics.volatility}%</div>
                    <div class="metric-description" style="font-size: 11px; color: #444;">
                        ë²¤ì¹˜ë§ˆí¬: ${metrics.benchmark_volatility}%<br>
                        ì—°ê°„ í‘œì¤€í¸ì°¨. ë‚®ì„ìˆ˜ë¡ ì•ˆì •ì 
                    </div>
                </div>
            `;

            // ì°¨íŠ¸ ìƒì„±
            const benchmarkName = summary.benchmark_name || summary.benchmark;
            createChart(chart_data, benchmarkName);
        }

        function createChart(chartData, benchmark) {
            const ctx = document.getElementById('performanceChart').getContext('2d');

            if (chart) {
                chart.destroy();
            }

            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartData.dates,
                    datasets: [
                        {
                            label: 'ë‚´ í¬íŠ¸í´ë¦¬ì˜¤',
                            data: chartData.portfolio_cumulative,
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            borderWidth: 3,
                            tension: 0.1,
                            fill: true,
                            pointRadius: 1,
                            pointHoverRadius: 5
                        },
                        {
                            label: `ë²¤ì¹˜ë§ˆí¬ (${benchmark})`,
                            data: chartData.benchmark_cumulative,
                            borderColor: '#f43f5e',
                            backgroundColor: 'rgba(244, 63, 94, 0.1)',
                            borderWidth: 3,
                            tension: 0.1,
                            fill: true,
                            pointRadius: 1,
                            pointHoverRadius: 5
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    const value = context.parsed.y;
                                    const percent = ((value - 1) * 100).toFixed(2);
                                    label += `${value.toFixed(4)} (${percent >= 0 ? '+' : ''}${percent}%)`;
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            ticks: {
                                callback: function(value) {
                                    return value.toFixed(2);
                                }
                            },
                            title: {
                                display: true,
                                text: 'ëˆ„ì  ìˆ˜ìµ (1.0 = ì‹œì‘ì )',
                                font: {
                                    size: 12,
                                    weight: 'bold'
                                }
                            }
                        },
                        x: {
                            ticks: {
                                maxTicksLimit: 10
                            },
                            title: {
                                display: true,
                                text: 'ë‚ ì§œ',
                                font: {
                                    size: 12,
                                    weight: 'bold'
                                }
                            }
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    }
                }
            });
        }

        function createAllocationCharts(allocationData, baseCurrency) {
            // ìƒ‰ìƒ íŒ”ë ˆíŠ¸
            const colors = [
                '#667eea', '#764ba2', '#f093fb', '#4facfe',
                '#43e97b', '#fa709a', '#fee140', '#30cfd0',
                '#a8edea', '#fed6e3', '#c471f5', '#ffecd2'
            ];

            // ì‹œì‘ ì‹œì  ë„ë„› ì°¨íŠ¸
            const initialCtx = document.getElementById('initialAllocationChart').getContext('2d');
            if (initialAllocationChart) {
                initialAllocationChart.destroy();
            }

            initialAllocationChart = new Chart(initialCtx, {
                type: 'doughnut',
                data: {
                    labels: allocationData.initial.labels,
                    datasets: [{
                        data: allocationData.initial.values,
                        backgroundColor: colors.slice(0, allocationData.initial.labels.length),
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 10,
                                font: {
                                    size: 11
                                },
                                generateLabels: function(chart) {
                                    const data = chart.data;
                                    if (data.labels.length && data.datasets.length) {
                                        const total = data.datasets[0].data.reduce((a, b) => a + b, 0);
                                        return data.labels.map((label, i) => {
                                            const value = data.datasets[0].data[i];
                                            const percentage = ((value / total) * 100).toFixed(1);
                                            return {
                                                text: `${label}: ${percentage}%`,
                                                fillStyle: data.datasets[0].backgroundColor[i],
                                                hidden: false,
                                                index: i
                                            };
                                        });
                                    }
                                    return [];
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${label}: ${formatCurrency(value, baseCurrency)} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });

            // í˜„ì¬ ì‹œì  ë„ë„› ì°¨íŠ¸
            const currentCtx = document.getElementById('currentAllocationChart').getContext('2d');
            if (currentAllocationChart) {
                currentAllocationChart.destroy();
            }

            currentAllocationChart = new Chart(currentCtx, {
                type: 'doughnut',
                data: {
                    labels: allocationData.current.labels,
                    datasets: [{
                        data: allocationData.current.values,
                        backgroundColor: colors.slice(0, allocationData.current.labels.length),
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 10,
                                font: {
                                    size: 11
                                },
                                generateLabels: function(chart) {
                                    const data = chart.data;
                                    if (data.labels.length && data.datasets.length) {
                                        const total = data.datasets[0].data.reduce((a, b) => a + b, 0);
                                        return data.labels.map((label, i) => {
                                            const value = data.datasets[0].data[i];
                                            const percentage = ((value / total) * 100).toFixed(1);
                                            return {
                                                text: `${label}: ${percentage}%`,
                                                fillStyle: data.datasets[0].backgroundColor[i],
                                                hidden: false,
                                                index: i
                                            };
                                        });
                                    }
                                    return [];
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${label}: ${formatCurrency(value, baseCurrency)} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderHoldingsTable(holdings, currency, isDetailView = false) {
            const tbody = document.getElementById('holdingsTableBody');
            
            tbody.innerHTML = holdings.map(h => `
                <tr style="border-bottom: 1px solid #e0e0e0;">
                    <td style="padding: 12px;"><strong>${h.ticker}</strong></td>
                    <td style="padding: 12px;">${h.name}</td>
                    <td style="padding: 12px; text-align: right;">${isDetailView ? '-' : (h.asset_class === 'í˜„ê¸ˆ' ? '-' : h.quantity.toLocaleString())}</td>
                    <td style="padding: 12px; text-align: right;">${isDetailView ? '-' : formatCurrency(h.current_value, currency)}</td>
                    <td style="padding: 12px; text-align: right;"><strong>${h.weight}%</strong></td>
                </tr>
            `).join('');
        }

        function formatCurrency(value, currency = 'USD') {
            if (currency === 'KRW') {
                // í•œêµ­ ì›í™”
                if (value >= 100000000) {
                    return 'â‚©' + (value / 100000000).toFixed(2) + 'ì–µ';
                } else if (value >= 10000) {
                    return 'â‚©' + (value / 10000).toFixed(0) + 'ë§Œ';
                }
                return 'â‚©' + value.toLocaleString();
            } else {
                // ë¯¸êµ­ ë‹¬ëŸ¬
                if (value >= 1000000) {
                    return '$' + (value / 1000000).toFixed(2) + 'M';
                } else if (value >= 1000) {
                    return '$' + (value / 1000).toFixed(1) + 'K';
                }
                return '$' + value.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
            }
        }

        // í¬íŠ¸í´ë¦¬ì˜¤ ì €ì¥ í•¨ìˆ˜
        async function savePortfolio() {
            // ë¡œê·¸ì¸ ì²´í¬
            if (!isUserLoggedIn) {
                alert('ğŸ”’ ë¡œê·¸ì¸ì´ í•„ìš”í•œ ê¸°ëŠ¥ì…ë‹ˆë‹¤.\në¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì„¸ìš”.');
                window.location.href = '/login';
                return;
            }
            
            const nameInput = document.getElementById('portfolioName');
            const name = nameInput.value.trim();
            const saveBtn = document.getElementById('saveBtn');
            const saveMessage = document.getElementById('saveMessage');
            
            if (!name) {
                alert('í¬íŠ¸í´ë¦¬ì˜¤ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                nameInput.focus();
                return;
            }
            
            if (!currentAnalysisData) {
                alert('ë¶„ì„ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ë¶„ì„ì„ ì‹¤í–‰í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            try {
                saveBtn.disabled = true;
                saveBtn.textContent = 'ì €ì¥ ì¤‘...';
                
                const response = await fetch('/api/save-portfolio', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: name,
                        ...currentAnalysisData
                    })
                });
                
                const data = await response.json();
                
                if (response.status === 401) {
                    alert('ğŸ”’ ' + data.error);
                    window.location.href = '/login';
                    return;
                }
                
                if (!response.ok) {
                    throw new Error(data.error || 'ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
                
                // ì„±ê³µ ë©”ì‹œì§€
                saveMessage.style.display = 'block';
                saveMessage.style.background = '#d4edda';
                saveMessage.style.color = '#155724';
                saveMessage.style.border = '1px solid #c3e6cb';
                saveMessage.textContent = `âœ… ${data.message}`;
                
                // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
                nameInput.value = '';
                
            } catch (err) {
                console.error('âŒ Save Error:', err);
                saveMessage.style.display = 'block';
                saveMessage.style.background = '#f8d7da';
                saveMessage.style.color = '#721c24';
                saveMessage.style.border = '1px solid #f5c6cb';
                saveMessage.textContent = `âŒ ${err.message}`;
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = 'ğŸ’¾ ì €ì¥í•˜ê¸°';
            }
        }

        // CSV ë‚´ë³´ë‚´ê¸° í•¨ìˆ˜
        function exportToCSV() {
            if (!currentAnalysisData || !currentAnalysisData.csv_content) {
                alert('ë‚´ë³´ë‚¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € í¬íŠ¸í´ë¦¬ì˜¤ë¥¼ ë¶„ì„í•´ì£¼ì„¸ìš”.');
                return;
            }

            try {
                // CSV ì»¨í…ì¸  ê°€ì ¸ì˜¤ê¸°
                const csvContent = currentAnalysisData.csv_content;
                
                // Blob ìƒì„±
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                
                // ë‹¤ìš´ë¡œë“œ ë§í¬ ìƒì„±
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                
                // íŒŒì¼ëª… ìƒì„± (í˜„ì¬ ë‚ ì§œ í¬í•¨)
                const today = new Date();
                const dateStr = today.toISOString().split('T')[0];
                const fileName = `portfolio_${dateStr}.csv`;
                
                link.setAttribute('href', url);
                link.setAttribute('download', fileName);
                link.style.visibility = 'hidden';
                
                // DOMì— ì¶”ê°€í•˜ê³  í´ë¦­
                document.body.appendChild(link);
                link.click();
                
                // ì •ë¦¬
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                console.log('âœ… CSV exported successfully:', fileName);
                
                // ì„±ê³µ ë©”ì‹œì§€
                const saveMessage = document.getElementById('saveMessage');
                saveMessage.style.display = 'block';
                saveMessage.style.background = '#d4edda';
                saveMessage.style.color = '#155724';
                saveMessage.style.border = '1px solid #c3e6cb';
                saveMessage.textContent = `âœ… CSV íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤: ${fileName}`;
                
                // 3ì´ˆ í›„ ë©”ì‹œì§€ ìˆ¨ê¸°ê¸°
                setTimeout(() => {
                    saveMessage.style.display = 'none';
                }, 3000);
                
            } catch (err) {
                console.error('âŒ Export Error:', err);
                alert('CSV ë‚´ë³´ë‚´ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + err.message);
            }
        }

        // AI ë¶„ì„ ê²°ê³¼ ìºì‹œ (ê°™ì€ ì„¸ì…˜ì—ì„œëŠ” ì¬ìš”ì²­í•˜ì§€ ì•ŠìŒ)
        let aiAnalysisResultCache = null;

        // AI ë¶„ì„ í•¨ìˆ˜
        async function analyzeWithAI() {
            // ë¡œê·¸ì¸ ì²´í¬
            if (!isUserLoggedIn) {
                alert('ğŸ”’ ë¡œê·¸ì¸ì´ í•„ìš”í•œ ê¸°ëŠ¥ì…ë‹ˆë‹¤.\nAI ë¶„ì„ì€ ë¡œê·¸ì¸ í›„ ì´ìš©í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                window.location.href = '/login';
                return;
            }
            
            if (!currentAnalysisData) {
                alert('ë¶„ì„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € í¬íŠ¸í´ë¦¬ì˜¤ ë¶„ì„ì„ ì‹¤í–‰í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            // ëª¨ë‹¬ ì—´ê¸°
            const modal = document.getElementById('aiAnalysisModal');
            const loadingState = document.getElementById('aiLoadingState');
            const contentDiv = document.getElementById('aiAnalysisContent');
            
            openAIModal();
            
            // ìºì‹œëœ ê²°ê³¼ê°€ ìˆìœ¼ë©´ ë°”ë¡œ í‘œì‹œ
            if (aiAnalysisResultCache) {
                console.log('âœ… Using cached AI analysis result');
                loadingState.style.display = 'none';
                contentDiv.style.display = 'block';
                contentDiv.innerHTML = aiAnalysisResultCache;
                return;
            }
            
            loadingState.style.display = 'block';
            contentDiv.style.display = 'none';
            contentDiv.innerHTML = '';
            
            try {
                console.log('ğŸ¤– Requesting AI analysis...');
                
                const response = await fetch('/api/ai-analysis', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        holdings: currentAnalysisData.holdings_table,
                        metrics: currentAnalysisData.metrics,
                        summary: currentAnalysisData.summary
                    })
                });
                
                const data = await response.json();
                
                // ë¡œê·¸ì¸ ì²´í¬
                if (response.status === 401) {
                    closeAIModal();
                    alert('ğŸ”’ ' + data.error);
                    window.location.href = '/login';
                    return;
                }
                
                // Rate limiting ì²˜ë¦¬
                if (response.status === 429 || data.rate_limited) {
                    throw new Error(data.error || 'AI ë¶„ì„ì€ 1ë¶„ì— 1ë²ˆë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                }
                
                if (!response.ok || !data.success) {
                    throw new Error(data.error || 'AI ë¶„ì„ ìš”ì²­ì´ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
                
                console.log('âœ… AI analysis received' + (data.cached ? ' (from server cache)' : ''));
                
                // ë§ˆí¬ë‹¤ìš´ì„ HTMLë¡œ ë³€í™˜
                const htmlContent = marked.parse(data.analysis);
                
                // ê²°ê³¼ ìºì‹œì— ì €ì¥
                aiAnalysisResultCache = htmlContent;
                
                // ê²°ê³¼ í‘œì‹œ
                loadingState.style.display = 'none';
                contentDiv.style.display = 'block';
                contentDiv.innerHTML = htmlContent;
                
            } catch (err) {
                console.error('âŒ AI Analysis Error:', err);
                loadingState.style.display = 'none';
                contentDiv.style.display = 'block';
                
                // Rate limit ì—ëŸ¬ì¸ ê²½ìš° íŠ¹ë³„í•œ ë©”ì‹œì§€ í‘œì‹œ
                const isRateLimitError = err.message.includes('3ë¶„ì— 1ë²ˆ') || err.message.includes('1ë¶„ì— 1ë²ˆ');
                const errorIcon = isRateLimitError ? 'â±ï¸' : 'âš ï¸';
                const errorColor = isRateLimitError ? '#f59e0b' : '#ef4444';
                
                contentDiv.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: ${errorColor};">
                        <div style="font-size: 48px; margin-bottom: 20px;">${errorIcon}</div>
                        <div style="font-size: 18px; font-weight: 600; margin-bottom: 10px;">
                            ${isRateLimitError ? 'AI ë¶„ì„ ìš”ì²­ ì œí•œ' : 'AI ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤'}
                        </div>
                        <div style="font-size: 14px; color: #999;">
                            ${err.message}
                        </div>
                    </div>
                `;
            }
        }
        
        function closeAIModal() {
            document.getElementById('aiAnalysisModal').style.display = 'none';
            // ëª¨ë°”ì¼ì—ì„œ body ìŠ¤í¬ë¡¤ ë³µì›
            document.body.style.overflow = '';
        }
        
        // ëª¨ë‹¬ ì—´ê¸° í—¬í¼ í•¨ìˆ˜
        function openAIModal() {
            document.getElementById('aiAnalysisModal').style.display = 'block';
            // ëª¨ë°”ì¼ì—ì„œ ë°°ê²½ ìŠ¤í¬ë¡¤ ë°©ì§€
            document.body.style.overflow = 'hidden';
        }
        
        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ì‹œ ë‹«ê¸°
        document.getElementById('aiAnalysisModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeAIModal();
            }
        });
    </script>
</body>
</html>
