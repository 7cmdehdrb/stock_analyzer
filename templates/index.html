<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í¬íŠ¸í´ë¦¬ì˜¤ ì„±ê³¼ ë¶„ì„ê¸°</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            margin-bottom: 20px;
        }

        /* ë„¤ë¹„ê²Œì´ì…˜ ë°” ë°”ë¡œ ë‹¤ìŒì˜ ì¹´ë“œëŠ” ìƒë‹¨ ë‘¥ê·¼ ëª¨ì„œë¦¬ ì œê±° */
        #analysisFormCard {
            border-radius: 0 0 15px 15px;
            margin-top: 0;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        input[type="file"],
        input[type="date"],
        input[type="text"],
        select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
            background-color: white;
        }

        input[type="file"]:focus,
        input[type="date"]:focus,
        input[type="text"]:focus,
        select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #667eea;
            font-weight: 600;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #fee;
            color: #c33;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #c33;
            display: none;
        }

        .results {
            display: none;
        }

        /* ìˆ˜ë™ ì…ë ¥ í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        .input-table-container {
            margin-top: 20px;
            overflow-x: auto;
        }

        .input-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 10px;
        }

        .input-table th {
            background: #f5f5f5;
            padding: 10px;
            text-align: left;
            border-bottom: 2px solid #667eea;
            font-weight: 600;
            font-size: 14px;
        }

        .input-table td {
            padding: 8px;
            border-bottom: 1px solid #e0e0e0;
        }

        .input-table input[type="text"],
        .input-table input[type="number"],
        .input-table select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .input-table input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .delete-row-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .delete-row-btn:hover {
            background: #dc2626;
        }

        .add-row-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .add-row-btn:hover {
            opacity: 0.9;
        }

        .input-mode-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .mode-btn {
            flex: 1;
            padding: 10px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        .mode-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .mode-btn:hover {
            transform: translateY(-2px);
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .summary-item {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .summary-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .summary-value {
            font-size: 24px;
            font-weight: 700;
            color: #333;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .metric-label {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 10px;
            font-weight: 500;
            color: #333;
        }

        .metric-value {
            font-size: 32px;
            font-weight: 700;
        }

        .metric-description {
            font-size: 11px;
            opacity: 0.8;
            margin-top: 5px;
            color: #444;
        }

        .chart-container {
            margin-top: 20px;
            position: relative;
            height: 400px;
        }

        canvas {
            max-width: 100%;
        }

        .helper-text {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
            font-style: italic;
        }

        .positive {
            color: #22c55e;
        }

        .negative {
            color: #ef4444;
        }

        /* ì •ë ¬ ê°€ëŠ¥í•œ í…Œì´ë¸” í—¤ë” */
        .sortable-header {
            cursor: pointer;
            user-select: none;
            position: relative;
            padding-right: 20px !important;
        }

        .sortable-header:hover {
            background: #e8e8e8;
        }

        .sortable-header::after {
            content: 'â‡…';
            position: absolute;
            right: 8px;
            opacity: 0.3;
            font-size: 14px;
        }

        .sortable-header.sort-asc::after {
            content: 'â†‘';
            opacity: 1;
            color: #667eea;
        }

        .sortable-header.sort-desc::after {
            content: 'â†“';
            opacity: 1;
            color: #667eea;
        }

        /* ë„¤ë¹„ê²Œì´ì…˜ ë°” ìŠ¤íƒ€ì¼ */
        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 0;
            margin: 0 0 0 0;
            border-radius: 15px 15px 0 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .navbar-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px 30px;
        }

        .navbar-title {
            color: white;
            font-size: 24px;
            font-weight: 700;
            text-decoration: none;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .navbar-title:hover {
            opacity: 0.9;
        }

        .navbar-links {
            display: flex;
            gap: 20px;
        }

        .navbar-link {
            color: white;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 500;
            transition: background 0.2s;
        }

        .navbar-link:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .navbar-link.active {
            background: rgba(255, 255, 255, 0.3);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ë„¤ë¹„ê²Œì´ì…˜ ë°” -->
        <div class="navbar">
            <div class="navbar-content">
                <a href="/" class="navbar-title">ğŸ“Š í¬íŠ¸í´ë¦¬ì˜¤ ì„±ê³¼ ë¶„ì„ê¸°</a>
                <div class="navbar-links">
                    <a href="/" class="navbar-link active">ë¶„ì„í•˜ê¸°</a>
                    <a href="/ranking" class="navbar-link">ë­í‚¹ë³´ê¸°</a>
                </div>
            </div>
        </div>

        <div class="card" id="analysisFormCard">
            <form id="analysisForm" enctype="multipart/form-data">
                <!-- ì…ë ¥ ëª¨ë“œ ì„ íƒ -->
                <div class="input-mode-toggle">
                    <button type="button" class="mode-btn active" id="manualModeBtn">âœï¸ ì§ì ‘ ì…ë ¥</button>
                    <button type="button" class="mode-btn" id="csvModeBtn">ğŸ“ CSV ì—…ë¡œë“œ</button>
                </div>

                <!-- CSV ì—…ë¡œë“œ ëª¨ë“œ -->
                <div id="csvUploadSection" class="form-group" style="display: none;">
                    <label for="csvFile">í¬íŠ¸í´ë¦¬ì˜¤ CSV íŒŒì¼ ì—…ë¡œë“œ</label>
                    <input type="file" id="csvFile" name="csv_file" accept=".csv">
                    <div class="helper-text">
                        CSV íŒŒì¼ì€ ë°˜ë“œì‹œ "í‹°ì»¤", "ë³´ìœ ëŸ‰", "êµ­ê°€", "ë¶„ë¥˜" ì»¬ëŸ¼ì„ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤.
                    </div>
                </div>

                <!-- ìˆ˜ë™ ì…ë ¥ ëª¨ë“œ -->
                <div id="manualInputSection">
                    <label>í¬íŠ¸í´ë¦¬ì˜¤ ì¢…ëª© ì…ë ¥</label>
                    <div class="helper-text" style="margin-top: 5px; margin-bottom: 10px;">
                        ğŸ’¡ í˜„ê¸ˆ ì²´í¬ë°•ìŠ¤ë¥¼ ì„ íƒí•˜ë©´ í•´ë‹¹ ì¢…ëª©ì´ í˜„ê¸ˆìœ¼ë¡œ ì²˜ë¦¬ë˜ë©°, í‹°ì»¤ëŠ” ìë™ìœ¼ë¡œ USD ë˜ëŠ” KRWë¡œ ì„¤ì •ë©ë‹ˆë‹¤.
                    </div>
                    <div class="input-table-container">
                        <table class="input-table">
                            <thead>
                                <tr>
                                    <th style="width: 25%;">í‹°ì»¤</th>
                                    <th style="width: 20%;">ë³´ìœ ëŸ‰</th>
                                    <th style="width: 20%;">êµ­ê°€</th>
                                    <th style="width: 15%;">í˜„ê¸ˆ</th>
                                    <th style="width: 20%;">ì‚­ì œ</th>
                                </tr>
                            </thead>
                            <tbody id="manualInputTableBody">
                                <!-- ì´ˆê¸° í–‰ -->
                                <tr class="input-row">
                                    <td><input type="text" class="ticker-input" placeholder="ì˜ˆ: AAPL"></td>
                                    <td><input type="number" class="quantity-input" placeholder="0" min="0" step="1"></td>
                                    <td>
                                        <select class="country-input" onchange="updateQuantityStep(this)">
                                            <option value="ë¯¸êµ­">ë¯¸êµ­</option>
                                            <option value="í•œêµ­">í•œêµ­</option>
                                        </select>
                                    </td>
                                    <td style="text-align: center;"><input type="checkbox" class="cash-input" onchange="handleCashChangeWithStep(this)"></td>
                                    <td><button type="button" class="delete-row-btn" onclick="deleteRow(this)">ì‚­ì œ</button></td>
                                </tr>
                            </tbody>
                        </table>
                        <button type="button" class="add-row-btn" onclick="addRow()">
                            <span>â•</span>
                            <span>ì¢…ëª© ì¶”ê°€</span>
                        </button>
                    </div>
                </div>

                <div class="form-group">
                    <label for="startDate">ì‹œì‘ ì¼ì</label>
                    <input type="date" id="startDate" name="start_date" required>
                    <div class="helper-text">
                        ë¶„ì„ì„ ì‹œì‘í•  ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”. (ì˜ˆ: í¬íŠ¸í´ë¦¬ì˜¤ êµ¬ì„± ì‹œì‘ì¼)
                    </div>
                </div>

                <div class="form-group">
                    <label for="benchmarkTicker">ë²¤ì¹˜ë§ˆí¬</label>
                    <select id="benchmarkTicker" name="benchmark_ticker" required>
                        <option value="SPY">S&P 500</option>
                        <option value="QQQ">NASDAQ 100</option>
                        <option value="069500.KS">KODEX 200</option>
                    </select>
                    <div class="helper-text">
                        í¬íŠ¸í´ë¦¬ì˜¤ ì„±ê³¼ë¥¼ ë¹„êµí•  ë²¤ì¹˜ë§ˆí¬ë¥¼ ì„ íƒí•˜ì„¸ìš”.
                    </div>
                </div>

                <div class="form-group">
                    <label for="baseCurrency">ê¸°ì¤€ í†µí™”</label>
                    <select id="baseCurrency" name="base_currency" required>
                        <option value="USD">ë¯¸êµ­ ë‹¬ëŸ¬ (USD)</option>
                        <option value="KRW">í•œêµ­ ì›í™” (KRW)</option>
                    </select>
                    <div class="helper-text">
                        í¬íŠ¸í´ë¦¬ì˜¤ë¥¼ í‰ê°€í•  ê¸°ì¤€ í†µí™”ë¥¼ ì„ íƒí•˜ì„¸ìš”. ì„ íƒí•œ í†µí™”ë¡œ ëª¨ë“  ìì‚°ì´ í™˜ì‚°ë©ë‹ˆë‹¤.
                    </div>
                </div>

                <button type="submit" class="btn" id="analyzeBtn">ë¶„ì„ ì‹œì‘</button>
            </form>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <div>í¬íŠ¸í´ë¦¬ì˜¤ë¥¼ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...</div>
            </div>

            <div class="error" id="error" style="margin-top: 20px;"></div>
            
            <!-- ìºì‹œ í†µê³„ -->
            <div style="margin-top: 20px; padding: 15px; background: #f5f7fa; border-radius: 8px; font-size: 12px; color: #666;">
                <div>
                    <strong>ğŸ’¾ ë°ì´í„° ìºì‹œ:</strong> 
                    <span id="cacheStats">ë¡œë”© ì¤‘...</span>
                </div>
            </div>
        </div>

        <div class="results" id="results">
            <!-- í¬íŠ¸í´ë¦¬ì˜¤ ì´ë¦„ í‘œì‹œ (ìƒì„¸ ë·° ì „ìš©) -->
            <div class="card" id="portfolioNameSection" style="display: none;">
                <h1 style="margin: 0; color: #333; font-size: 2em;">
                    <span id="portfolioNameDisplay"></span>
                </h1>
                <div style="margin-top: 15px; padding: 12px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 4px; color: #856404; font-size: 14px;">
                    â„¹ï¸ <strong>ì•Œë¦¼:</strong> ë‹¤ë¥¸ ì‚¬ìš©ìì˜ í¬íŠ¸í´ë¦¬ì˜¤ë¥¼ ì¡°íšŒí•  ë•ŒëŠ” í”„ë¼ì´ë²„ì‹œ ë³´í˜¸ë¥¼ ìœ„í•´ ìì‚° ê°€ì¹˜ê°€ í‘œì‹œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
                </div>
            </div>
            
            <div class="card">
                <h2 style="margin-bottom: 20px; color: #333;">ğŸ“ˆ í¬íŠ¸í´ë¦¬ì˜¤ ìš”ì•½</h2>
                <div class="summary-grid" id="summaryGrid"></div>
            </div>

            <div class="card">
                <h2 style="margin-bottom: 20px; color: #333;">ğŸ’¼ ë³´ìœ  ì¢…ëª© í˜„í™©</h2>
                <div style="overflow-x: auto;">
                    <table id="holdingsTable" style="width: 100%; border-collapse: collapse; margin-top: 10px;">
                        <thead>
                            <tr style="background: #f5f5f5;">
                                <th class="sortable-header" onclick="sortHoldings('ticker')" style="padding: 12px; text-align: left; border-bottom: 2px solid #667eea;">í‹°ì»¤</th>
                                <th style="padding: 12px; text-align: left; border-bottom: 2px solid #667eea;">ì¢…ëª©ëª…</th>
                                <th style="padding: 12px; text-align: right; border-bottom: 2px solid #667eea;">ë³´ìœ ëŸ‰</th>
                                <th style="padding: 12px; text-align: right; border-bottom: 2px solid #667eea;">í‰ê°€ì•¡</th>
                                <th class="sortable-header" onclick="sortHoldings('weight')" style="padding: 12px; text-align: right; border-bottom: 2px solid #667eea;">ë¹„ì¤‘(%)</th>
                            </tr>
                        </thead>
                        <tbody id="holdingsTableBody">
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="card">
                <h2 style="margin-bottom: 20px; color: #333;">ğŸ¥§ ìì‚° ë°°ë¶„ ë¹„ì¤‘</h2>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 20px;">
                    <div>
                        <h3 style="text-align: center; margin-bottom: 15px; color: #666; font-size: 16px;">ì‹œì‘ ì‹œì </h3>
                        <div style="position: relative; height: 300px;">
                            <canvas id="initialAllocationChart"></canvas>
                        </div>
                    </div>
                    <div>
                        <h3 style="text-align: center; margin-bottom: 15px; color: #666; font-size: 16px;">í˜„ì¬ ì‹œì </h3>
                        <div style="position: relative; height: 300px;">
                            <canvas id="currentAllocationChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2 style="margin-bottom: 20px; color: #333;">ğŸ“Š ì„±ê³¼ ì§€í‘œ</h2>
                <div class="metrics-grid" id="metricsGrid"></div>
            </div>

            <div class="card">
                <h2 style="margin-bottom: 20px; color: #333;">ğŸ“‰ ëˆ„ì  ìˆ˜ìµë¥  ë¹„êµ</h2>
                <div class="chart-container">
                    <canvas id="performanceChart"></canvas>
                </div>
            </div>

            <!-- ì €ì¥ ë²„íŠ¼ -->
            <div class="card" id="saveSection" style="display: none;">
                <h2 style="margin-bottom: 20px; color: #333;">ğŸ’¾ í¬íŠ¸í´ë¦¬ì˜¤ ì €ì¥</h2>
                <div style="display: flex; gap: 15px; align-items: center; margin-bottom: 15px;">
                    <input 
                        type="text" 
                        id="portfolioName" 
                        placeholder="í¬íŠ¸í´ë¦¬ì˜¤ ì´ë¦„ ì…ë ¥" 
                        style="flex: 1; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px;"
                    >
                    <button 
                        id="saveBtn" 
                        onclick="savePortfolio()"
                        style="padding: 12px 30px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; white-space: nowrap;"
                    >
                        ğŸ’¾ ì €ì¥í•˜ê¸°
                    </button>
                </div>
                <!-- CSV ë‚´ë³´ë‚´ê¸° ë²„íŠ¼ (ì§ì ‘ ì…ë ¥ ëª¨ë“œ ì „ìš©) -->
                <div id="exportSection" style="display: none;">
                    <button 
                        id="exportBtn" 
                        onclick="exportToCSV()"
                        style="width: 100%; padding: 12px 30px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer;"
                    >
                        ğŸ“¥ CSVë¡œ ë‚´ë³´ë‚´ê¸°
                    </button>
                    <div style="margin-top: 10px; font-size: 12px; color: #666;">
                        ğŸ’¡ ì…ë ¥í•œ í¬íŠ¸í´ë¦¬ì˜¤ë¥¼ CSV íŒŒì¼ë¡œ ë‹¤ìš´ë¡œë“œí•˜ì—¬ ë‚˜ì¤‘ì— ë‹¤ì‹œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                    </div>
                </div>
                <div id="saveMessage" style="margin-top: 15px; padding: 12px; border-radius: 6px; display: none;"></div>
            </div>

            <!-- AI ë¶„ì„ ë²„íŠ¼ -->
            <div class="card" id="aiAnalysisSection" style="display: none; text-align: center;">
                <button 
                    id="aiAnalysisBtn" 
                    onclick="analyzeWithAI()"
                    style="
                        padding: 20px 40px;
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        color: white;
                        border: none;
                        border-radius: 50px;
                        font-size: 16px;
                        font-weight: 700;
                        cursor: pointer;
                        box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
                        transition: all 0.3s ease;
                        display: inline-flex;
                        align-items: center;
                        gap: 12px;
                    "
                    onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 12px 24px rgba(102, 126, 234, 0.4)';"
                    onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 8px 20px rgba(102, 126, 234, 0.3)';"
                >
                    <span style="font-size: 24px;">ğŸ¤–</span>
                    <span>AIë¡œ ë¶„ì„í•˜ê¸°</span>
                </button>
                <div style="margin-top: 15px; font-size: 13px; color: #666;">
                    ğŸ’¡ AIê°€ í¬íŠ¸í´ë¦¬ì˜¤ ì„±ê³¼ë¥¼ ë¶„ì„í•˜ê³  ì¸ì‚¬ì´íŠ¸ë¥¼ ì œê³µí•©ë‹ˆë‹¤.
                </div>
            </div>

            <!-- AI ë¶„ì„ ê²°ê³¼ ëª¨ë‹¬ -->
            <div id="aiAnalysisModal" style="
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.7);
                z-index: 9999;
                overflow-y: auto;
            ">
                <div style="
                    max-width: 900px;
                    margin: 50px auto;
                    background: white;
                    border-radius: 12px;
                    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
                    position: relative;
                ">
                    <!-- ëª¨ë‹¬ í—¤ë” -->
                    <div style="
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        padding: 25px 30px;
                        border-radius: 12px 12px 0 0;
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                    ">
                        <h2 style="margin: 0; color: white; font-size: 24px; display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 28px;">ğŸ¤–</span>
                            <span>AI í¬íŠ¸í´ë¦¬ì˜¤ ë¶„ì„</span>
                        </h2>
                        <button onclick="closeAIModal()" style="
                            background: none;
                            border: none;
                            color: white;
                            font-size: 28px;
                            cursor: pointer;
                            width: 36px;
                            height: 36px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            border-radius: 50%;
                            transition: background 0.2s;
                        " onmouseover="this.style.background='rgba(255,255,255,0.2)'" onmouseout="this.style.background='none'">
                            Ã—
                        </button>
                    </div>
                    
                    <!-- ë¡œë”© ìƒíƒœ -->
                    <div id="aiLoadingState" style="padding: 60px; text-align: center; display: none;">
                        <div style="font-size: 48px; margin-bottom: 20px;">ğŸ¤–</div>
                        <div style="font-size: 18px; color: #667eea; font-weight: 600; margin-bottom: 10px;">
                            AIê°€ í¬íŠ¸í´ë¦¬ì˜¤ë¥¼ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...
                        </div>
                        <div style="font-size: 14px; color: #999; margin-bottom: 20px;">
                            ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”
                        </div>
                        <div style="font-size: 13px; color: #ef4444; background: #fee; padding: 12px; border-radius: 6px; margin: 0 auto 30px; max-width: 400px; border: 1px solid #fcc;">
                            âš ï¸ <strong>ì£¼ì˜:</strong> ë¶„ì„ì´ ì™„ë£Œë  ë•Œê¹Œì§€ ì°½ì„ ë‹«ê±°ë‚˜ í™”ë©´ì„ ë²—ì–´ë‚˜ì§€ ë§ˆì„¸ìš”.
                        </div>
                        <div style="margin-top: 30px;">
                            <div style="
                                display: inline-block;
                                width: 50px;
                                height: 50px;
                                border: 5px solid #f3f3f3;
                                border-top: 5px solid #667eea;
                                border-radius: 50%;
                                animation: spin 1s linear infinite;
                            "></div>
                        </div>
                    </div>
                    
                    <!-- ë¶„ì„ ê²°ê³¼ -->
                    <div id="aiAnalysisContent" style="
                        padding: 30px;
                        max-height: 70vh;
                        overflow-y: auto;
                        line-height: 1.8;
                    "></div>
                </div>
            </div>
        </div>
    </div>

    <style>
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* ë§ˆí¬ë‹¤ìš´ ìŠ¤íƒ€ì¼ë§ */
        #aiAnalysisContent h2 {
            color: #333;
            margin-top: 30px;
            margin-bottom: 15px;
            font-size: 22px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e0e0e0;
        }
        
        #aiAnalysisContent h2:first-child {
            margin-top: 0;
        }
        
        #aiAnalysisContent ul {
            margin-left: 20px;
            margin-bottom: 20px;
        }
        
        #aiAnalysisContent li {
            margin-bottom: 10px;
            color: #333;
        }
        
        #aiAnalysisContent strong {
            color: #667eea;
            font-weight: 600;
        }
        
        #aiAnalysisContent p {
            margin-bottom: 15px;
            color: #555;
        }
        
        #aiAnalysisContent code {
            background: #f5f5f5;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            color: #e83e8c;
        }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        const form = document.getElementById('analysisForm');
        const loading = document.getElementById('loading');
        const error = document.getElementById('error');
        const results = document.getElementById('results');
        const analyzeBtn = document.getElementById('analyzeBtn');

        // ë‚ ì§œ ê¸°ë³¸ê°’ ì„¤ì • (ì˜¤ëŠ˜ ë‚ ì§œì™€ 3ë…„ ì „ 1ì›” 1ì¼)
        const today = new Date();
        const threeYearsAgo = new Date(today.getFullYear() - 3, 0, 1); // 0 = January, 1 = 1ì¼
        const minDate = new Date(2000, 0, 1); // 2000ë…„ 1ì›” 1ì¼
        
        // ë¡œì»¬ ë‚ ì§œë¥¼ YYYY-MM-DD í˜•ì‹ìœ¼ë¡œ ë³€í™˜ (UTC ë¬¸ì œ ë°©ì§€)
        function formatLocalDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        console.log('Today:', formatLocalDate(today));
        console.log('Three years ago (Jan 1):', formatLocalDate(threeYearsAgo));
        
        document.getElementById('startDate').min = formatLocalDate(minDate);
        document.getElementById('startDate').max = formatLocalDate(today);
        document.getElementById('startDate').value = formatLocalDate(threeYearsAgo);
        
        // ê¸°ë³¸ ë²¤ì¹˜ë§ˆí¬ ì„¤ì •
        document.getElementById('benchmarkTicker').value = 'SPY';

        // ì…ë ¥ ëª¨ë“œ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        document.getElementById('csvModeBtn').addEventListener('click', function() {
            switchInputMode('csv');
        });
        document.getElementById('manualModeBtn').addEventListener('click', function() {
            switchInputMode('manual');
        });

        // ì…ë ¥ ëª¨ë“œ ì „ì—­ ë³€ìˆ˜ (ê¸°ë³¸ê°’: manual)
        let currentInputMode = 'manual';

        // ì…ë ¥ ëª¨ë“œ ì „í™˜
        function switchInputMode(mode) {
            console.log('Switching to mode:', mode);
            currentInputMode = mode;
            const csvSection = document.getElementById('csvUploadSection');
            const manualSection = document.getElementById('manualInputSection');
            const csvFile = document.getElementById('csvFile');
            const buttons = document.querySelectorAll('.mode-btn');

            buttons.forEach(btn => btn.classList.remove('active'));

            if (mode === 'csv') {
                csvSection.style.display = 'block';
                manualSection.style.display = 'none';
                csvFile.required = true;
                buttons[0].classList.add('active');
                console.log('CSV mode activated');
            } else {
                csvSection.style.display = 'none';
                manualSection.style.display = 'block';
                csvFile.required = false;
                buttons[1].classList.add('active');
                console.log('Manual mode activated');
            }
        }

        // í–‰ ì¶”ê°€
        function addRow() {
            const tbody = document.getElementById('manualInputTableBody');
            const newRow = document.createElement('tr');
            newRow.className = 'input-row';
            newRow.innerHTML = `
                <td><input type="text" class="ticker-input" placeholder="ì˜ˆ: AAPL"></td>
                <td><input type="number" class="quantity-input" placeholder="0" min="0" step="1"></td>
                <td>
                    <select class="country-input" onchange="updateQuantityStep(this)">
                        <option value="ë¯¸êµ­">ë¯¸êµ­</option>
                        <option value="í•œêµ­">í•œêµ­</option>
                    </select>
                </td>
                <td style="text-align: center;"><input type="checkbox" class="cash-input" onchange="handleCashChangeWithStep(this)"></td>
                <td><button type="button" class="delete-row-btn" onclick="deleteRow(this)">ì‚­ì œ</button></td>
            `;
            tbody.appendChild(newRow);
        }

        // í–‰ ì‚­ì œ
        function deleteRow(button) {
            const tbody = document.getElementById('manualInputTableBody');
            const rows = tbody.getElementsByClassName('input-row');
            
            // ìµœì†Œ 1ê°œ í–‰ì€ ìœ ì§€
            if (rows.length > 1) {
                button.closest('tr').remove();
            } else {
                alert('ìµœì†Œ 1ê°œì˜ ì¢…ëª©ì€ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.');
            }
        }

        // ë³´ìœ ëŸ‰ ì…ë ¥ í•„ë“œì˜ step ì—…ë°ì´íŠ¸
        function updateQuantityStep(selectOrCheckbox) {
            const row = selectOrCheckbox.closest('tr');
            const quantityInput = row.querySelector('.quantity-input');
            const countrySelect = row.querySelector('.country-input');
            const cashCheckbox = row.querySelector('.cash-input');
            
            // ë¯¸êµ­ + í˜„ê¸ˆì¸ ê²½ìš°ì—ë§Œ ì†Œìˆ˜ì  ì…ë ¥ í—ˆìš©
            if (countrySelect.value === 'ë¯¸êµ­' && cashCheckbox.checked) {
                quantityInput.step = '0.01';
            } else {
                quantityInput.step = '1';
            }
        }

        // í˜„ê¸ˆ ì²´í¬ë°•ìŠ¤ ë³€ê²½ ì²˜ë¦¬ (step ì—…ë°ì´íŠ¸ í¬í•¨)
        function handleCashChangeWithStep(checkbox) {
            handleCashChange(checkbox);
            updateQuantityStep(checkbox);
        }

        // í˜„ê¸ˆ ì²´í¬ë°•ìŠ¤ ë³€ê²½ ì²˜ë¦¬
        function handleCashChange(checkbox) {
            const row = checkbox.closest('tr');
            const tickerInput = row.querySelector('.ticker-input');
            const countrySelect = row.querySelector('.country-input');

            if (checkbox.checked) {
                // í˜„ê¸ˆìœ¼ë¡œ ì²´í¬ëœ ê²½ìš°
                if (countrySelect.value === 'ë¯¸êµ­') {
                    tickerInput.value = 'USD';
                } else {
                    tickerInput.value = 'KRW';
                }
                tickerInput.readOnly = true;
                tickerInput.style.background = '#f5f5f5';
            } else {
                // í˜„ê¸ˆ ì²´í¬ í•´ì œëœ ê²½ìš°
                tickerInput.value = '';
                tickerInput.readOnly = false;
                tickerInput.style.background = 'white';
            }
        }

        // êµ­ê°€ ì„ íƒ ë³€ê²½ ì²˜ë¦¬ (í˜„ê¸ˆì¸ ê²½ìš°ì—ë§Œ)
        function handleCountryChange(select) {
            const row = select.closest('tr');
            const cashCheckbox = row.querySelector('.cash-input');
            const tickerInput = row.querySelector('.ticker-input');

            if (cashCheckbox.checked) {
                // í˜„ê¸ˆì¸ ê²½ìš° í‹°ì»¤ ìë™ ë³€ê²½
                if (select.value === 'ë¯¸êµ­') {
                    tickerInput.value = 'USD';
                } else {
                    tickerInput.value = 'KRW';
                }
            }
            
            // stepë„ ì—…ë°ì´íŠ¸
            updateQuantityStep(select);
        }

        // ìˆ˜ë™ ì…ë ¥ ë°ì´í„°ë¥¼ CSV í˜•ì‹ìœ¼ë¡œ ë³€í™˜
        function convertManualInputToCSV() {
            const rows = document.querySelectorAll('#manualInputTableBody .input-row');
            const csvLines = ['í‹°ì»¤,ë³´ìœ ëŸ‰,êµ­ê°€,ë¶„ë¥˜'];

            let hasData = false;
            rows.forEach(row => {
                const ticker = row.querySelector('.ticker-input').value.trim();
                const quantity = row.querySelector('.quantity-input').value.trim();
                const country = row.querySelector('.country-input').value;
                const isCash = row.querySelector('.cash-input').checked;

                if (ticker && quantity) {
                    hasData = true;
                    const assetClass = isCash ? 'í˜„ê¸ˆ' : 'ì£¼ì‹';
                    csvLines.push(`${ticker},${quantity},${country},${assetClass}`);
                }
            });

            if (!hasData) {
                return null;
            }

            return csvLines.join('\n');
        }

        // ì´ˆê¸° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • (í˜„ê¸ˆ/êµ­ê°€ ë³€ê²½)
        document.addEventListener('DOMContentLoaded', function() {
            const tbody = document.getElementById('manualInputTableBody');
            tbody.querySelectorAll('.cash-input').forEach(cb => {
                cb.addEventListener('change', function() {
                    handleCashChangeWithStep(this);
                });
            });
            tbody.querySelectorAll('.country-input').forEach(select => {
                select.addEventListener('change', function() {
                    updateQuantityStep(this);
                });
            });
        });

        // ìºì‹œ í†µê³„ ë¡œë“œ
        async function loadCacheStats() {
            try {
                const response = await fetch('/api/cache-stats');
                if (response.ok) {
                    const data = await response.json();
                    const statsElement = document.getElementById('cacheStats');
                    statsElement.textContent = `${data.ticker_count}ê°œ ì¢…ëª©, ${data.record_count.toLocaleString()}ê°œ ë ˆì½”ë“œ`;
                } else {
                    document.getElementById('cacheStats').textContent = 'í†µê³„ ë¡œë“œ ì‹¤íŒ¨';
                }
            } catch (err) {
                console.error('ìºì‹œ í†µê³„ ë¡œë“œ ì˜¤ë¥˜:', err);
                document.getElementById('cacheStats').textContent = 'í†µê³„ ë¡œë“œ ì‹¤íŒ¨';
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ìºì‹œ í†µê³„ ê°€ì ¸ì˜¤ê¸°
        loadCacheStats();

        // ì €ì¥ëœ í¬íŠ¸í´ë¦¬ì˜¤ ë³´ê¸° ì²˜ë¦¬
        window.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            console.log('URL params:', urlParams.toString());
            console.log('view param:', urlParams.get('view'));
            
            if (urlParams.get('view') === 'portfolio') {
                const portfolioData = sessionStorage.getItem('portfolioData');
                console.log('SessionStorage data:', portfolioData);
                
                if (portfolioData) {
                    try {
                        const data = JSON.parse(portfolioData);
                        console.log('Parsed data:', data);
                        
                        // í¼ ì„¹ì…˜ ìˆ¨ê¸°ê¸°
                        const formCard = document.getElementById('analysisFormCard');
                        if (formCard) {
                            formCard.style.display = 'none';
                        }
                        
                        // í¬íŠ¸í´ë¦¬ì˜¤ ì´ë¦„ í‘œì‹œ
                        const portfolioNameSection = document.getElementById('portfolioNameSection');
                        const portfolioNameDisplay = document.getElementById('portfolioNameDisplay');
                        if (portfolioNameSection && portfolioNameDisplay) {
                            portfolioNameDisplay.textContent = data.name;
                            portfolioNameSection.style.display = 'block';
                        }
                        
                        // ê²°ê³¼ í‘œì‹œ - dataì—ì„œ ì§ì ‘ í•„ìš”í•œ í•„ë“œ ì¶”ì¶œ (ìƒì„¸ ë·° ëª¨ë“œë¡œ)
                        displayResults({
                            metrics: data.metrics,
                            summary: data.summary,
                            holdings_table: data.holdings_table,
                            allocation_data: data.allocation_data,
                            chart_data: data.chart_data
                        }, true); // true = ìƒì„¸ ë·° ëª¨ë“œ
                        
                        // ê²°ê³¼ ì„¹ì…˜ í‘œì‹œ
                        const results = document.getElementById('results');
                        if (results) {
                            results.style.display = 'block';
                        }
                        
                        // sessionStorage ì •ë¦¬
                        sessionStorage.removeItem('portfolioData');
                        
                        // URLì—ì„œ view íŒŒë¼ë¯¸í„° ì œê±° (ë¸Œë¼ìš°ì € íˆìŠ¤í† ë¦¬ ìœ ì§€)
                        window.history.replaceState({}, document.title, window.location.pathname);
                        
                    } catch (err) {
                        console.error('í¬íŠ¸í´ë¦¬ì˜¤ ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', err);
                        console.error('Error stack:', err.stack);
                        alert('í¬íŠ¸í´ë¦¬ì˜¤ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                    }
                } else {
                    console.log('No portfolio data in sessionStorage');
                }
            }
        });

        let chart = null;
        let initialAllocationChart = null;
        let currentAllocationChart = null;
        
        // ë¶„ì„ ê²°ê³¼ë¥¼ ì €ì¥í•˜ê¸° ìœ„í•œ ì „ì—­ ë³€ìˆ˜
        let currentAnalysisData = null;

        // ë³´ìœ  ì¢…ëª© ë°ì´í„° ë° ì •ë ¬ ìƒíƒœ
        let currentHoldings = [];
        let currentCurrency = 'USD';
        let isDetailView = false;
        let currentSortColumn = null;
        let currentSortDirection = 'asc';

        // ì •ë ¬ í•¨ìˆ˜
        function sortHoldings(column) {
            // ê°™ì€ ì»¬ëŸ¼ì„ í´ë¦­í•˜ë©´ ë°©í–¥ ì „í™˜, ë‹¤ë¥¸ ì»¬ëŸ¼ì´ë©´ ì˜¤ë¦„ì°¨ìˆœìœ¼ë¡œ ì‹œì‘
            if (currentSortColumn === column) {
                currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortColumn = column;
                currentSortDirection = 'asc';
            }

            // ì •ë ¬
            const sorted = [...currentHoldings].sort((a, b) => {
                if (column === 'ticker') {
                    // í˜„ê¸ˆì€ í•­ìƒ ë§¨ ì•„ë˜
                    const aIsCash = a.asset_class === 'í˜„ê¸ˆ';
                    const bIsCash = b.asset_class === 'í˜„ê¸ˆ';
                    
                    if (aIsCash && !bIsCash) return 1;
                    if (!aIsCash && bIsCash) return -1;
                    
                    // ë‘˜ ë‹¤ í˜„ê¸ˆì´ê±°ë‚˜ ë‘˜ ë‹¤ ì¼ë°˜ ìì‚°ì¸ ê²½ìš° í‹°ì»¤ë¡œ ë¹„êµ
                    const comparison = a.ticker.localeCompare(b.ticker);
                    return currentSortDirection === 'asc' ? comparison : -comparison;
                } else if (column === 'weight') {
                    const comparison = a.weight - b.weight;
                    return currentSortDirection === 'asc' ? comparison : -comparison;
                }
                return 0;
            });

            // í…Œì´ë¸” ë‹¤ì‹œ ë Œë”ë§
            renderHoldingsTable(sorted, currentCurrency, isDetailView);

            // í—¤ë” ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
            updateSortHeaders();
        }

        // ì •ë ¬ í—¤ë” ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
        function updateSortHeaders() {
            // ëª¨ë“  í—¤ë”ì—ì„œ ì •ë ¬ í´ë˜ìŠ¤ ì œê±°
            document.querySelectorAll('.sortable-header').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
            });

            // í˜„ì¬ ì •ë ¬ ì»¬ëŸ¼ì— í´ë˜ìŠ¤ ì¶”ê°€
            if (currentSortColumn === 'ticker') {
                const tickerHeader = document.querySelector('.sortable-header[onclick*="ticker"]');
                if (tickerHeader) {
                    tickerHeader.classList.add(currentSortDirection === 'asc' ? 'sort-asc' : 'sort-desc');
                }
            } else if (currentSortColumn === 'weight') {
                const weightHeader = document.querySelector('.sortable-header[onclick*="weight"]');
                if (weightHeader) {
                    weightHeader.classList.add(currentSortDirection === 'asc' ? 'sort-asc' : 'sort-desc');
                }
            }
        }

        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            // ì…ë ¥ ëª¨ë“œì— ë”°ë¼ ì²˜ë¦¬
            let csvContent = null;
            let fileToUpload = null;

            if (currentInputMode === 'manual') {
                // ìˆ˜ë™ ì…ë ¥ ëª¨ë“œ: CSV ìƒì„±
                csvContent = convertManualInputToCSV();
                if (!csvContent) {
                    alert('ìµœì†Œ 1ê°œì˜ ì¢…ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }
                console.log('ğŸ“ Manual input CSV:', csvContent);
                
                // CSVë¥¼ Blobìœ¼ë¡œ ë³€í™˜í•˜ì—¬ íŒŒì¼ì²˜ëŸ¼ ì²˜ë¦¬
                const blob = new Blob([csvContent], { type: 'text/csv' });
                fileToUpload = new File([blob], 'manual_input.csv', { type: 'text/csv' });
            } else {
                // CSV ì—…ë¡œë“œ ëª¨ë“œ: íŒŒì¼ í™•ì¸
                const fileInput = document.getElementById('csvFile');
                if (!fileInput.files || fileInput.files.length === 0) {
                    alert('CSV íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                    return;
                }
                fileToUpload = fileInput.files[0];
                console.log('ğŸ“ Selected file:', fileToUpload.name);
            }

            // UI ì´ˆê¸°í™”
            error.style.display = 'none';
            error.style.backgroundColor = ''; // ë°°ê²½ìƒ‰ ì´ˆê¸°í™”
            error.style.color = ''; // ê¸€ììƒ‰ ì´ˆê¸°í™”
            error.style.borderLeft = ''; // í…Œë‘ë¦¬ ì´ˆê¸°í™”
            results.style.display = 'none';
            loading.style.display = 'block';
            analyzeBtn.disabled = true;
            
            // AI ë¶„ì„ ìºì‹œ ì´ˆê¸°í™” (ìƒˆë¡œìš´ ë¶„ì„ ì‹œì‘)
            aiAnalysisResultCache = null;

            const formData = new FormData();
            formData.append('csv_file', fileToUpload);
            formData.append('start_date', document.getElementById('startDate').value);
            formData.append('benchmark_ticker', document.getElementById('benchmarkTicker').value);
            formData.append('base_currency', document.getElementById('baseCurrency').value);
            
            // FormData ë‚´ìš© í™•ì¸ (ë””ë²„ê¹…ìš©)
            console.log('ğŸ“¤ Sending data:');
            for (let [key, value] of formData.entries()) {
                if (value instanceof File) {
                    console.log(`  ${key}: ${value.name} (${value.size} bytes)`);
                } else {
                    console.log(`  ${key}: ${value}`);
                }
            }

            try {
                const response = await fetch('/analyze', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }

                console.log('âœ… Analysis completed successfully');
                
                // ê²½ê³  ë©”ì‹œì§€ í‘œì‹œ (ì¼ë¶€ í‹°ì»¤ ì‹¤íŒ¨)
                if (data.warning) {
                    const warningDiv = document.getElementById('error');
                    warningDiv.textContent = data.warning;
                    warningDiv.style.display = 'block';
                    warningDiv.style.backgroundColor = '#fff3cd';
                    warningDiv.style.color = '#856404';
                    warningDiv.style.borderLeft = '4px solid #ffc107';
                }
                
                // ë¶„ì„ ê²°ê³¼ ì €ì¥ (ì €ì¥ ë²„íŠ¼ìš©)
                let csvContentForSave;
                if (currentInputMode === 'manual') {
                    csvContentForSave = csvContent;
                } else {
                    csvContentForSave = await fileToUpload.text();
                }

                currentAnalysisData = {
                    csv_content: csvContentForSave,
                    start_date: document.getElementById('startDate').value,
                    benchmark_ticker: document.getElementById('benchmarkTicker').value,
                    base_currency: document.getElementById('baseCurrency').value,
                    ...data
                };
                
                displayResults(data);
                results.style.display = 'block';
                
                // ì €ì¥ ì„¹ì…˜ í‘œì‹œ
                document.getElementById('saveSection').style.display = 'block';
                document.getElementById('saveMessage').style.display = 'none';
                
                // AI ë¶„ì„ ë²„íŠ¼ í‘œì‹œ
                document.getElementById('aiAnalysisSection').style.display = 'block';
                
                // ì§ì ‘ ì…ë ¥ ëª¨ë“œì¸ ê²½ìš° CSV ë‚´ë³´ë‚´ê¸° ë²„íŠ¼ í‘œì‹œ
                if (currentInputMode === 'manual') {
                    document.getElementById('exportSection').style.display = 'block';
                } else {
                    document.getElementById('exportSection').style.display = 'none';
                }

            } catch (err) {
                console.error('âŒ Error:', err);
                error.textContent = err.message;
                error.style.display = 'block';
            } finally {
                loading.style.display = 'none';
                analyzeBtn.disabled = false;
                // ë¶„ì„ í›„ ìºì‹œ í†µê³„ ì—…ë°ì´íŠ¸
                loadCacheStats();
            }
        });

        function displayResults(data, isDetailViewMode = false) {
            const { metrics, chart_data, summary, allocation_data, holdings_table } = data;

            // ì „ì—­ ë³€ìˆ˜ì— ì €ì¥
            currentHoldings = holdings_table;
            currentCurrency = summary.base_currency;
            isDetailView = isDetailViewMode;
            currentSortColumn = null; // ì •ë ¬ ìƒíƒœ ì´ˆê¸°í™”
            currentSortDirection = 'asc';

            // í†µí™” ì‹¬ë³¼ ê²°ì •
            const currencySymbol = summary.base_currency === 'USD' ? '$' : 'â‚©';
            const currencyName = summary.base_currency === 'USD' ? 'USD' : 'KRW';

            // ìì‚° ê°€ì¹˜ í‘œì‹œ í•¨ìˆ˜ (ìƒì„¸ ë·°ì—ì„œëŠ” ìˆ¨ê¹€)
            const formatValue = (value) => {
                return isDetailViewMode ? '-' : formatCurrency(value, summary.base_currency);
            };

            // ìš”ì•½ ì •ë³´ í‘œì‹œ
            const summaryGrid = document.getElementById('summaryGrid');
            summaryGrid.innerHTML = `
                <div class="summary-item">
                    <div class="summary-label">ë³´ìœ  ì¢…ëª© ìˆ˜</div>
                    <div class="summary-value">${summary.num_holdings}</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">ê¸°ì¤€ í†µí™”</div>
                    <div class="summary-value">${currencyName}</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">USD/KRW í™˜ìœ¨</div>
                    <div class="summary-value">${summary.exchange_rate.toLocaleString()}</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">ì‹œì‘ ê°€ì¹˜ (íˆ¬ììì‚°)</div>
                    <div class="summary-value">${formatValue(summary.initial_value)}</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">í˜„ì¬ ê°€ì¹˜ (íˆ¬ììì‚°)</div>
                    <div class="summary-value">${formatValue(summary.current_value)}</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">í˜„ê¸ˆ ë³´ìœ ì•¡</div>
                    <div class="summary-value">${formatValue(summary.total_cash)}</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">ì´ ìì‚° (í˜„ê¸ˆí¬í•¨)</div>
                    <div class="summary-value">${formatValue(summary.current_value_with_cash)}</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">ìˆ˜ìµë¥  (íˆ¬ììì‚°)</div>
                    <div class="summary-value ${summary.total_return >= 0 ? 'positive' : 'negative'}">
                        ${summary.total_return >= 0 ? '+' : ''}${summary.total_return}%
                    </div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">ìˆ˜ìµë¥  (í˜„ê¸ˆí¬í•¨)</div>
                    <div class="summary-value ${summary.total_return_with_cash >= 0 ? 'positive' : 'negative'}">
                        ${summary.total_return_with_cash >= 0 ? '+' : ''}${summary.total_return_with_cash}%
                    </div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">ì—°í‰ê·  ìˆ˜ìµë¥  (CAGR)</div>
                    <div class="summary-value ${metrics.cagr >= 0 ? 'positive' : 'negative'}">
                        ${metrics.cagr >= 0 ? '+' : ''}${metrics.cagr}%
                    </div>
                </div>
            `;
            
            // ë„ë„› ì°¨íŠ¸ ìƒì„±
            createAllocationCharts(allocation_data, summary.base_currency);
            
            // ë³´ìœ  ì¢…ëª© í…Œì´ë¸” ë Œë”ë§ (ìƒì„¸ ë·°ì—ì„œëŠ” í‰ê°€ì•¡ ìˆ¨ê¹€)
            renderHoldingsTable(holdings_table, summary.base_currency, isDetailViewMode);
            
            // ì •ë ¬ í—¤ë” ì´ˆê¸°í™”
            updateSortHeaders();

            // ê·¸ë¼ë°ì´ì…˜ ìƒ‰ìƒ ê³„ì‚° í•¨ìˆ˜
            function getGradientColor(value, benchmarkValue, isBetter) {
                // valueê°€ benchmarkë³´ë‹¤ ì¢‹ì„ìˆ˜ë¡ ì´ˆë¡, ë‚˜ì ìˆ˜ë¡ ë¹¨ê°•
                // isBetter: 'higher' (ë†’ì„ìˆ˜ë¡ ì¢‹ìŒ) ë˜ëŠ” 'lower' (ë‚®ì„ìˆ˜ë¡ ì¢‹ìŒ)
                let diff = 0;
                if (isBetter === 'higher') {
                    diff = value - benchmarkValue;
                } else {
                    diff = benchmarkValue - value;
                }
                
                // ì°¨ì´ë¥¼ í¼ì„¼íŠ¸ë¡œ ë³€í™˜ (ë²¤ì¹˜ë§ˆí¬ ëŒ€ë¹„)
                const percentDiff = benchmarkValue !== 0 ? (diff / Math.abs(benchmarkValue)) * 100 : diff * 100;
                
                // -50% ~ +50% ë²”ìœ„ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ìƒ‰ìƒ ê°•ë„ ê³„ì‚°
                const intensity = Math.max(-1, Math.min(1, percentDiff / 50));
                
                if (Math.abs(intensity) < 0.05) {
                    // ê±°ì˜ ê°™ìœ¼ë©´ ë§¤ìš° ì—°í•œ íšŒìƒ‰
                    return 'rgb(245, 245, 245)';
                } else if (intensity > 0) {
                    // ì´ˆë¡ìƒ‰ (ì¢‹ìŒ) - ì—°í•œ ì´ˆë¡ -> ì§„í•œ ì´ˆë¡
                    const alpha = Math.abs(intensity);
                    const r = Math.floor(200 - alpha * 100); // 200 -> 100
                    const g = Math.floor(230 - alpha * 50);  // 230 -> 180
                    const b = Math.floor(200 - alpha * 100); // 200 -> 100
                    return `rgb(${r}, ${g}, ${b})`;
                } else {
                    // ë¹¨ê°„ìƒ‰ (ë‚˜ì¨) - ì—°í•œ ë¹¨ê°• -> ì§„í•œ ë¹¨ê°•
                    const alpha = Math.abs(intensity);
                    const r = Math.floor(230 - alpha * 50);  // 230 -> 180
                    const g = Math.floor(200 - alpha * 100); // 200 -> 100
                    const b = Math.floor(200 - alpha * 100); // 200 -> 100
                    return `rgb(${r}, ${g}, ${b})`;
                }
            }

            // ë°°ê²½ìƒ‰ì— ë”°ë¥¸ í…ìŠ¤íŠ¸ ìƒ‰ìƒ ê²°ì • í•¨ìˆ˜
            function getTextColor(value, benchmarkValue, isBetter) {
                // ëª¨ë“  í…ìŠ¤íŠ¸ë¥¼ ì–´ë‘ìš´ íšŒìƒ‰ìœ¼ë¡œ í†µì¼
                return '#333';
            }

            // ì„±ê³¼ ì§€í‘œ í‘œì‹œ
            const metricsGrid = document.getElementById('metricsGrid');
            metricsGrid.innerHTML = `
                <div class="metric-card" style="background: ${getGradientColor(metrics.sharpe_ratio, metrics.benchmark_sharpe_ratio, 'higher')};">
                    <div class="metric-label">ìƒ¤í”„ ë¹„ìœ¨ (Sharpe Ratio)</div>
                    <div class="metric-value" style="color: #333;">${metrics.sharpe_ratio}</div>
                    <div class="metric-description" style="font-size: 11px; color: #444;">
                        ë²¤ì¹˜ë§ˆí¬: ${metrics.benchmark_sharpe_ratio}<br>
                        ìœ„í—˜ ëŒ€ë¹„ ìˆ˜ìµë¥ . ë†’ì„ìˆ˜ë¡ ì¢‹ìŒ
                    </div>
                </div>
                <div class="metric-card" style="background: ${getGradientColor(metrics.sortino_ratio, metrics.benchmark_sortino_ratio, 'higher')};">
                    <div class="metric-label">ì†Œí‹°ë…¸ ë¹„ìœ¨ (Sortino Ratio)</div>
                    <div class="metric-value" style="color: #333;">${metrics.sortino_ratio}</div>
                    <div class="metric-description" style="font-size: 11px; color: #444;">
                        ë²¤ì¹˜ë§ˆí¬: ${metrics.benchmark_sortino_ratio}<br>
                        í•˜ë°© ìœ„í—˜ ëŒ€ë¹„ ìˆ˜ìµë¥ . ë†’ì„ìˆ˜ë¡ ì¢‹ìŒ
                    </div>
                </div>
                <div class="metric-card" style="background: ${getGradientColor(metrics.alpha, 0, 'higher')};">
                    <div class="metric-label">ì•ŒíŒŒ (Alpha)</div>
                    <div class="metric-value" style="color: ${getTextColor(metrics.alpha, 0, 'higher')};">
                        ${metrics.alpha >= 0 ? '+' : ''}${metrics.alpha}%
                    </div>
                    <div class="metric-description" style="font-size: 11px; color: #444;">
                        ë²¤ì¹˜ë§ˆí¬: 0%<br>
                        ë²¤ì¹˜ë§ˆí¬ ëŒ€ë¹„ ì´ˆê³¼ ìˆ˜ìµë¥ 
                    </div>
                </div>
                <div class="metric-card" style="background: ${getGradientColor(Math.abs(metrics.beta - 1), 0, 'lower')};">
                    <div class="metric-label">ë² íƒ€ (Beta)</div>
                    <div class="metric-value" style="color: #333;">${metrics.beta}</div>
                    <div class="metric-description" style="font-size: 11px; color: #444;">
                        ë²¤ì¹˜ë§ˆí¬: 1.0<br>
                        ì‹œì¥ ë¯¼ê°ë„. 1.0 = ì‹œì¥ê³¼ ë™ì¼
                    </div>
                </div>
                <div class="metric-card" style="background: ${getGradientColor(metrics.cagr, metrics.benchmark_annual_return, 'higher')};">
                    <div class="metric-label">ì—°í‰ê·  ìˆ˜ìµë¥  (CAGR)</div>
                    <div class="metric-value" style="color: ${getTextColor(metrics.cagr, metrics.benchmark_annual_return, 'higher')};">
                        ${metrics.cagr >= 0 ? '+' : ''}${metrics.cagr}%
                    </div>
                    <div class="metric-description" style="font-size: 11px; color: #444;">
                        ë²¤ì¹˜ë§ˆí¬: ${metrics.benchmark_annual_return >= 0 ? '+' : ''}${metrics.benchmark_annual_return}%<br>
                        ì—°ê°„ ë³µë¦¬ ìˆ˜ìµë¥ 
                    </div>
                </div>
                <div class="metric-card" style="background: ${getGradientColor(metrics.volatility, metrics.benchmark_volatility, 'lower')};">
                    <div class="metric-label">ë³€ë™ì„± (Volatility)</div>
                    <div class="metric-value" style="color: #333;">${metrics.volatility}%</div>
                    <div class="metric-description" style="font-size: 11px; color: #444;">
                        ë²¤ì¹˜ë§ˆí¬: ${metrics.benchmark_volatility}%<br>
                        ì—°ê°„ í‘œì¤€í¸ì°¨. ë‚®ì„ìˆ˜ë¡ ì•ˆì •ì 
                    </div>
                </div>
            `;

            // ì°¨íŠ¸ ìƒì„±
            createChart(chart_data, summary.benchmark);
        }

        function createChart(chartData, benchmark) {
            const ctx = document.getElementById('performanceChart').getContext('2d');

            if (chart) {
                chart.destroy();
            }

            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartData.dates,
                    datasets: [
                        {
                            label: 'ë‚´ í¬íŠ¸í´ë¦¬ì˜¤',
                            data: chartData.portfolio_cumulative,
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            borderWidth: 3,
                            tension: 0.1,
                            fill: true,
                            pointRadius: 1,
                            pointHoverRadius: 5
                        },
                        {
                            label: `ë²¤ì¹˜ë§ˆí¬ (${benchmark})`,
                            data: chartData.benchmark_cumulative,
                            borderColor: '#f43f5e',
                            backgroundColor: 'rgba(244, 63, 94, 0.1)',
                            borderWidth: 3,
                            tension: 0.1,
                            fill: true,
                            pointRadius: 1,
                            pointHoverRadius: 5
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    const value = context.parsed.y;
                                    const percent = ((value - 1) * 100).toFixed(2);
                                    label += `${value.toFixed(4)} (${percent >= 0 ? '+' : ''}${percent}%)`;
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            ticks: {
                                callback: function(value) {
                                    return value.toFixed(2);
                                }
                            },
                            title: {
                                display: true,
                                text: 'ëˆ„ì  ìˆ˜ìµ (1.0 = ì‹œì‘ì )',
                                font: {
                                    size: 12,
                                    weight: 'bold'
                                }
                            }
                        },
                        x: {
                            ticks: {
                                maxTicksLimit: 10
                            },
                            title: {
                                display: true,
                                text: 'ë‚ ì§œ',
                                font: {
                                    size: 12,
                                    weight: 'bold'
                                }
                            }
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    }
                }
            });
        }

        function createAllocationCharts(allocationData, baseCurrency) {
            // ìƒ‰ìƒ íŒ”ë ˆíŠ¸
            const colors = [
                '#667eea', '#764ba2', '#f093fb', '#4facfe',
                '#43e97b', '#fa709a', '#fee140', '#30cfd0',
                '#a8edea', '#fed6e3', '#c471f5', '#ffecd2'
            ];

            // ì‹œì‘ ì‹œì  ë„ë„› ì°¨íŠ¸
            const initialCtx = document.getElementById('initialAllocationChart').getContext('2d');
            if (initialAllocationChart) {
                initialAllocationChart.destroy();
            }

            initialAllocationChart = new Chart(initialCtx, {
                type: 'doughnut',
                data: {
                    labels: allocationData.initial.labels,
                    datasets: [{
                        data: allocationData.initial.values,
                        backgroundColor: colors.slice(0, allocationData.initial.labels.length),
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 10,
                                font: {
                                    size: 11
                                },
                                generateLabels: function(chart) {
                                    const data = chart.data;
                                    if (data.labels.length && data.datasets.length) {
                                        const total = data.datasets[0].data.reduce((a, b) => a + b, 0);
                                        return data.labels.map((label, i) => {
                                            const value = data.datasets[0].data[i];
                                            const percentage = ((value / total) * 100).toFixed(1);
                                            return {
                                                text: `${label}: ${percentage}%`,
                                                fillStyle: data.datasets[0].backgroundColor[i],
                                                hidden: false,
                                                index: i
                                            };
                                        });
                                    }
                                    return [];
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${label}: ${formatCurrency(value, baseCurrency)} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });

            // í˜„ì¬ ì‹œì  ë„ë„› ì°¨íŠ¸
            const currentCtx = document.getElementById('currentAllocationChart').getContext('2d');
            if (currentAllocationChart) {
                currentAllocationChart.destroy();
            }

            currentAllocationChart = new Chart(currentCtx, {
                type: 'doughnut',
                data: {
                    labels: allocationData.current.labels,
                    datasets: [{
                        data: allocationData.current.values,
                        backgroundColor: colors.slice(0, allocationData.current.labels.length),
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 10,
                                font: {
                                    size: 11
                                },
                                generateLabels: function(chart) {
                                    const data = chart.data;
                                    if (data.labels.length && data.datasets.length) {
                                        const total = data.datasets[0].data.reduce((a, b) => a + b, 0);
                                        return data.labels.map((label, i) => {
                                            const value = data.datasets[0].data[i];
                                            const percentage = ((value / total) * 100).toFixed(1);
                                            return {
                                                text: `${label}: ${percentage}%`,
                                                fillStyle: data.datasets[0].backgroundColor[i],
                                                hidden: false,
                                                index: i
                                            };
                                        });
                                    }
                                    return [];
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${label}: ${formatCurrency(value, baseCurrency)} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderHoldingsTable(holdings, currency, isDetailView = false) {
            const tbody = document.getElementById('holdingsTableBody');
            
            tbody.innerHTML = holdings.map(h => `
                <tr style="border-bottom: 1px solid #e0e0e0;">
                    <td style="padding: 12px;"><strong>${h.ticker}</strong></td>
                    <td style="padding: 12px;">${h.name}</td>
                    <td style="padding: 12px; text-align: right;">${isDetailView ? '-' : (h.asset_class === 'í˜„ê¸ˆ' ? '-' : h.quantity.toLocaleString())}</td>
                    <td style="padding: 12px; text-align: right;">${isDetailView ? '-' : formatCurrency(h.current_value, currency)}</td>
                    <td style="padding: 12px; text-align: right;"><strong>${h.weight}%</strong></td>
                </tr>
            `).join('');
        }

        function formatCurrency(value, currency = 'USD') {
            if (currency === 'KRW') {
                // í•œêµ­ ì›í™”
                if (value >= 100000000) {
                    return 'â‚©' + (value / 100000000).toFixed(2) + 'ì–µ';
                } else if (value >= 10000) {
                    return 'â‚©' + (value / 10000).toFixed(0) + 'ë§Œ';
                }
                return 'â‚©' + value.toLocaleString();
            } else {
                // ë¯¸êµ­ ë‹¬ëŸ¬
                if (value >= 1000000) {
                    return '$' + (value / 1000000).toFixed(2) + 'M';
                } else if (value >= 1000) {
                    return '$' + (value / 1000).toFixed(1) + 'K';
                }
                return '$' + value.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
            }
        }

        // í¬íŠ¸í´ë¦¬ì˜¤ ì €ì¥ í•¨ìˆ˜
        async function savePortfolio() {
            const nameInput = document.getElementById('portfolioName');
            const name = nameInput.value.trim();
            const saveBtn = document.getElementById('saveBtn');
            const saveMessage = document.getElementById('saveMessage');
            
            if (!name) {
                alert('í¬íŠ¸í´ë¦¬ì˜¤ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                nameInput.focus();
                return;
            }
            
            if (!currentAnalysisData) {
                alert('ë¶„ì„ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ë¶„ì„ì„ ì‹¤í–‰í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            try {
                saveBtn.disabled = true;
                saveBtn.textContent = 'ì €ì¥ ì¤‘...';
                
                const response = await fetch('/api/save-portfolio', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: name,
                        ...currentAnalysisData
                    })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
                
                // ì„±ê³µ ë©”ì‹œì§€
                saveMessage.style.display = 'block';
                saveMessage.style.background = '#d4edda';
                saveMessage.style.color = '#155724';
                saveMessage.style.border = '1px solid #c3e6cb';
                saveMessage.textContent = `âœ… ${data.message}`;
                
                // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
                nameInput.value = '';
                
            } catch (err) {
                console.error('âŒ Save Error:', err);
                saveMessage.style.display = 'block';
                saveMessage.style.background = '#f8d7da';
                saveMessage.style.color = '#721c24';
                saveMessage.style.border = '1px solid #f5c6cb';
                saveMessage.textContent = `âŒ ${err.message}`;
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = 'ğŸ’¾ ì €ì¥í•˜ê¸°';
            }
        }

        // CSV ë‚´ë³´ë‚´ê¸° í•¨ìˆ˜
        function exportToCSV() {
            if (!currentAnalysisData || !currentAnalysisData.csv_content) {
                alert('ë‚´ë³´ë‚¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € í¬íŠ¸í´ë¦¬ì˜¤ë¥¼ ë¶„ì„í•´ì£¼ì„¸ìš”.');
                return;
            }

            try {
                // CSV ì»¨í…ì¸  ê°€ì ¸ì˜¤ê¸°
                const csvContent = currentAnalysisData.csv_content;
                
                // Blob ìƒì„±
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                
                // ë‹¤ìš´ë¡œë“œ ë§í¬ ìƒì„±
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                
                // íŒŒì¼ëª… ìƒì„± (í˜„ì¬ ë‚ ì§œ í¬í•¨)
                const today = new Date();
                const dateStr = today.toISOString().split('T')[0];
                const fileName = `portfolio_${dateStr}.csv`;
                
                link.setAttribute('href', url);
                link.setAttribute('download', fileName);
                link.style.visibility = 'hidden';
                
                // DOMì— ì¶”ê°€í•˜ê³  í´ë¦­
                document.body.appendChild(link);
                link.click();
                
                // ì •ë¦¬
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                console.log('âœ… CSV exported successfully:', fileName);
                
                // ì„±ê³µ ë©”ì‹œì§€
                const saveMessage = document.getElementById('saveMessage');
                saveMessage.style.display = 'block';
                saveMessage.style.background = '#d4edda';
                saveMessage.style.color = '#155724';
                saveMessage.style.border = '1px solid #c3e6cb';
                saveMessage.textContent = `âœ… CSV íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤: ${fileName}`;
                
                // 3ì´ˆ í›„ ë©”ì‹œì§€ ìˆ¨ê¸°ê¸°
                setTimeout(() => {
                    saveMessage.style.display = 'none';
                }, 3000);
                
            } catch (err) {
                console.error('âŒ Export Error:', err);
                alert('CSV ë‚´ë³´ë‚´ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + err.message);
            }
        }

        // AI ë¶„ì„ ê²°ê³¼ ìºì‹œ (ê°™ì€ ì„¸ì…˜ì—ì„œëŠ” ì¬ìš”ì²­í•˜ì§€ ì•ŠìŒ)
        let aiAnalysisResultCache = null;

        // AI ë¶„ì„ í•¨ìˆ˜
        async function analyzeWithAI() {
            if (!currentAnalysisData) {
                alert('ë¶„ì„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € í¬íŠ¸í´ë¦¬ì˜¤ ë¶„ì„ì„ ì‹¤í–‰í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            // ëª¨ë‹¬ ì—´ê¸°
            const modal = document.getElementById('aiAnalysisModal');
            const loadingState = document.getElementById('aiLoadingState');
            const contentDiv = document.getElementById('aiAnalysisContent');
            
            modal.style.display = 'block';
            
            // ìºì‹œëœ ê²°ê³¼ê°€ ìˆìœ¼ë©´ ë°”ë¡œ í‘œì‹œ
            if (aiAnalysisResultCache) {
                console.log('âœ… Using cached AI analysis result');
                loadingState.style.display = 'none';
                contentDiv.style.display = 'block';
                contentDiv.innerHTML = aiAnalysisResultCache;
                return;
            }
            
            loadingState.style.display = 'block';
            contentDiv.style.display = 'none';
            contentDiv.innerHTML = '';
            
            try {
                console.log('ğŸ¤– Requesting AI analysis...');
                
                const response = await fetch('/api/ai-analysis', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        holdings: currentAnalysisData.holdings_table,
                        metrics: currentAnalysisData.metrics,
                        summary: currentAnalysisData.summary
                    })
                });
                
                const data = await response.json();
                
                // Rate limiting ì²˜ë¦¬
                if (response.status === 429 || data.rate_limited) {
                    throw new Error(data.error || 'AI ë¶„ì„ì€ 3ë¶„ì— 1ë²ˆë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                }
                
                if (!response.ok || !data.success) {
                    throw new Error(data.error || 'AI ë¶„ì„ ìš”ì²­ì´ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
                
                console.log('âœ… AI analysis received' + (data.cached ? ' (from server cache)' : ''));
                
                // ë§ˆí¬ë‹¤ìš´ì„ HTMLë¡œ ë³€í™˜
                const htmlContent = marked.parse(data.analysis);
                
                // ê²°ê³¼ ìºì‹œì— ì €ì¥
                aiAnalysisResultCache = htmlContent;
                
                // ê²°ê³¼ í‘œì‹œ
                loadingState.style.display = 'none';
                contentDiv.style.display = 'block';
                contentDiv.innerHTML = htmlContent;
                
            } catch (err) {
                console.error('âŒ AI Analysis Error:', err);
                loadingState.style.display = 'none';
                contentDiv.style.display = 'block';
                
                // Rate limit ì—ëŸ¬ì¸ ê²½ìš° íŠ¹ë³„í•œ ë©”ì‹œì§€ í‘œì‹œ
                const isRateLimitError = err.message.includes('3ë¶„ì— 1ë²ˆ') || err.message.includes('1ë¶„ì— 1ë²ˆ');
                const errorIcon = isRateLimitError ? 'â±ï¸' : 'âš ï¸';
                const errorColor = isRateLimitError ? '#f59e0b' : '#ef4444';
                
                contentDiv.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: ${errorColor};">
                        <div style="font-size: 48px; margin-bottom: 20px;">${errorIcon}</div>
                        <div style="font-size: 18px; font-weight: 600; margin-bottom: 10px;">
                            ${isRateLimitError ? 'AI ë¶„ì„ ìš”ì²­ ì œí•œ' : 'AI ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤'}
                        </div>
                        <div style="font-size: 14px; color: #999;">
                            ${err.message}
                        </div>
                    </div>
                `;
            }
        }
        
        function closeAIModal() {
            document.getElementById('aiAnalysisModal').style.display = 'none';
        }
        
        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ì‹œ ë‹«ê¸°
        document.getElementById('aiAnalysisModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeAIModal();
            }
        });
    </script>
</body>
</html>
